<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Running ownCloud in Kubernetes with Rook Ceph Storage - Part 1 | Edenmal - Sysadmin Garden of Eden</title>
<meta name=author content="Alexander Trost"><meta name=description content="How to run ownCloud in Kubernetes with using Rook for a Ceph Cluster."><meta name=twitter:site content="@galexrt"><meta name=twitter:title content="Running ownCloud in Kubernetes with Rook Ceph Storage - Part 1 | Edenmal - Sysadmin Garden of Eden"><meta name=twitter:card content="summary"><meta name=twitter:image content="/images/avatar.png"><meta name=twitter:description content="How to run ownCloud in Kubernetes with using Rook for a Ceph Cluster."><meta property="og:type" content="article"><meta property="og:title" content="Running ownCloud in Kubernetes with Rook Ceph Storage - Part 1"><meta property="og:description" content="How to run ownCloud in Kubernetes with using Rook for a Ceph Cluster."><meta property="og:url" content="https://edenmal.moe/post/2020/Running-ownCloud-in-Kubernetes-with-Rook-Ceph-Storage-Part-1/"><meta property="og:image" content="/images/avatar.png"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=https://edenmal.moe/post/2020/Running-ownCloud-in-Kubernetes-with-Rook-Ceph-Storage-Part-1/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=Cache-Control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#4d4ac7"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Edenmal"><meta name=msapplication-tooltip content="Edenmal"><meta name=msapplication-navbutton-color content="#4d4ac7"><meta name=msapplication-TileColor content="#4d4ac7"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://edenmal.moe/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://edenmal.moe/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://edenmal.moe/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://edenmal.moe/icons/icon-192x192.png><link rel=apple-touch-icon href=https://edenmal.moe/icons/icon-152x152.png><link rel=manifest href=https://edenmal.moe/manifest.json><link rel=preload href=https://edenmal.moe/styles/main-rendered.min.css as=style><link rel=preload href=https://edenmal.moe/images/avatar.png as=image><link rel=preload href=https://edenmal.moe/images/grey-prism.svg as=image><style>body{background-color:#f4f3f1;background-image:url(/images/grey-prism.svg);background-repeat:repeat;background-attachment:fixed}</style><link rel=stylesheet href=https://edenmal.moe/styles/main-rendered.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.min.css><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.819c76b4bba0f8b8c568f6e4860173f1d16e5046c01b008f4705ae823b5766e1.js integrity="sha256-gZx2tLug+LjFaPbkhgFz8dFuUEbAGwCPRwWugjtXZuE="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.min.2fcfc43be15566e9378af0e8247ba57fec8d4ee95c5dba15cf97e84d6c2115bc.js integrity="sha256-L8/EO+FVZuk3ivDoJHulf+yNTulcXboVz5foTWwhFbw="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.min.77ec5e7d7f844e9b6c2413a352b48194493a65c75d94d5cd9679a225c2da773c.js integrity="sha256-d+xefX+ETptsJBOjUrSBlEk6ZcddlNXNlnmiJcLadzw="></script><script src=https://edenmal.moe/scripts/pswp-init.min.299a530b67d8be41667aa9ed78920e272e970b0ac8ab7540ba3a7c1382b52de2.js integrity="sha256-KZpTC2fYvkFmeqnteJIOJy6XCwrIq3VAujp8E4K1LeI="></script></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class=icofont-caret-up aria-hidden=true></span></a>
<a role=button aria-label="Print page" title="Print page" class=print-page onclick=window.print()><span class=icofont-print aria-hidden=true></span></a></div><header class=site-header><a class=avatara href=https://edenmal.moe/><img class=avatar src=https://edenmal.moe/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://edenmal.moe/>Edenmal</a></h2><p class=subtitle>Sysadmin Garden of Eden</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class=icofont-navigation-menu aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://edenmal.moe/>Home</a></li><li class=menu-item><a href=https://edenmal.moe/about/>About</a></li><li class=menu-item><a href=https://edenmal.moe/tags/>Tags</a></li><li class=menu-item><a href=https://edenmal.moe/events/>Events</a></li><li class=menu-item><a href=https://edenmal.moe/site-notice/>Impressum</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:me@galexrt.moe title=Email aria-label=Email><span class=icofont-envelope aria-hidden=true></span></a></li><li class=social-item><a href=https://galexrt.moe/ rel=me title=Homepage aria-label=Homepage><span class=icofont-page aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/galexrt rel=me title=GitHub aria-label=GitHub><span class=icofont-github aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/galexrt rel=me title=Twitter aria-label=Twitter><span class=icofont-twitter aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/alexander-trost rel=me title=LinkedIn aria-label=LinkedIn><span class=icofont-linkedin aria-hidden=true></span></a></li><li class=social-item><a href=//www.xing.com/profile/Alexander_Trost18 rel=me title=XING aria-label=XING><span class=icofont-xing aria-hidden=true></span></a></li><li class=social-item><a rel=alternate type=application/rss+xml href=https://edenmal.moe/index.xml title=RSS aria-label=RSS><span class=icofont-rss aria-hidden=true></span></a></li></ul></nav></header><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><section class="main post-detail"><header class=post-header><h1 class=post-title>Running ownCloud in Kubernetes with Rook Ceph Storage - Part 1</h1><p class=post-meta>Author Alexander Trost · Read Time 6 minutes · Created Mon Jan 6 14:55:41 2020 · Updated Fri Mar 25 21:33:36 2022</p></header><article class=post-content><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#kubernetes---was-ist-das>Kubernetes - Was ist das?</a></li><li><a href=#was-brauchen-wir-dafür>Was brauchen wir dafür?</a><ul><li><a href=#datenbank---postgresql>Datenbank - PostgreSQL</a></li><li><a href=#storage>Storage</a></li><li><a href=#redis>Redis</a></li></ul></li><li><a href=#der-plan>Der Plan</a></li></ul></nav><hr><p>This a cross post of a post I wrote for the <a href=https://owncloud.org/news/>ownCloud Blog</a>, the original post can be found here: <a href=https://owncloud.org/news/running-owncloud-in-kubernetes-with-rook-ceph-storage/>Running ownCloud in Kubernetes With Rook Ceph Storage</a>.</p><p>Thanks to them for allowing me to write and publish the post on their blog!</p><hr><p>In dieser zweiteiligen Artikelreihe wird es darum gehen ownCloud hochverfügbar in <a href=https://kubernetes.io>Kubernetes</a> zu betreiben.</p><p>Der erste Teil wird dabei auf die Grundaspekte und Requirements eingehen, so das am Ende ein Plan bereit ist der im zweiten Teil dann Schritt für Schritt umgesetzt wird.</p><p>Zusammengefasst soll folgendes erreicht werden:</p><ul><li>Hardware- / Serverausfälle sollen nicht zu:<ul><li>Datenverlust führen.</li><li>ownCloud an sich nicht mehr verfügbar ist.</li></ul></li><li>Steigende Userzahlen sollen weniger / keine Probleme verursachen:<ul><li>Ceph ist an sich je nach gegebenen Storage in den genutzten Servern schnell unterwegs und sollte ohne Probleme mit vielen Usern klar kommen.</li><li>Die Datenbank ist neben dem Storage noch ein denkbares &ldquo;Bottleneck&rdquo;, jedoch komnmt das darauf an wie und welche Features in ownCloud genutzt werden.</li></ul></li></ul><h2 id=kubernetes---was-ist-das>Kubernetes - Was ist das?</h2><p>Kubernetes ist ein Orchestrator für Container. Bedeutet das Kubernetes Container verteilt über mehrere Server laufen lassen kann und noch weitere Features die uns dann nützlich sein werden.
Neben Container laufen lassen, kann Kubernetes noch vieles mehr, unteranderem mit Leichtigkeit HTTP Anwendungen im Internet erreichbar zu machen.
Dafür wird das <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Kubernetes Ingress Feature</a> genutzt.</p><p>Im weiteren Kontext der Artikelreihe wird Kubernetes (Grund-) Wissen vorrausgesetz. Sollte Kubernetes noch eine &ldquo;Pandorasbüchse&rdquo; für sie sein, kann dies unteranderem durch die hervorragenden Tutorials auf der Kubernetes Homepage Stück für Stück aufgebaut werden, siehe <a href=https://kubernetes.io/docs/tutorials/>Tutorials - Kubernetes</a>.</p><p><strong>ACHTUNG</strong> Der zweite Artikel in der Artikelreihe geht davon aus das ein funktionierendes Kubernetes Cluster mit einem Node / Worker mindestens vorhanden ist.</p><h2 id=was-brauchen-wir-dafür>Was brauchen wir dafür?</h2><p>Fangen wir erstmal bei den Komponenten an die immger gebraucht werden an und arbeiten uns dann direkt auch zu entsprechenden Tools / Projekten vor die uns im Kubernetes Umfeld dabei helfen können.</p><h3 id=datenbank---postgresql>Datenbank - PostgreSQL</h3><p>Fangen wir bei einer der wichtigsten Komponenten an, die Datenbank.</p><p>Im Falle von kleinen ownCloud Instanz, kann es sein das SQLite als Datenbank eingesetzt wird. SQLite ist nicht für Hochverfügbarkeit gemacht. Es sollte in jedem Fall ein Wechsel auf gegebenfalls PostgreSQL, MySQL oder Oracle in betracht gezogen werden. Oracle Datenbank Server Unterstützung ist in der ownCloud Enterprise Edition verfügbar.
Für mehr Informationen was SQLite angeht, siehe <a href=https://central.owncloud.org/t/when-to-and-not-to-use-sqlite/853>When to and not to use SQLITE - FAQ - ownCloud Central</a>.</p><p>Unter den unterstützten Datenbanken, <a href=https://doc.owncloud.com/server/10.1/admin_manual/configuration/database/linux_database_configuration.html>ownCloud Documentation 10.1 - Database configuration on Linux</a>, ist unteranderem PostgreSQL. Da es recht einfache Operator in Kubernetes gibt die ein PostgreSQL Cluster laufen lassen können, werden wir diese nun nutzen.</p><p>Bevor jedoch der &ldquo;PostgreSQL Operator&rdquo; gezeigt wird, was ist so ein Operator überhaupt?</p><p>Ein Operator in Kubernetes vereinfacht gesehen ein Automatisierungsmechanismus. Anhand von Custom Objekten in Kubernetes, sogenannten <a href=https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/>CustomResourceDefinitions</a>, reagiert der Operator darauf und erstellt in den meisten Fällen entsprechende Objekte in Kubernetes.
Bedeutet als Beispiel für einen PostgreSQL Operator: Wenn ein <code>PostgreSQL</code> Objekt erstellt wird, reagiert der Operator darauf und erstellt automatisch Stück für Stück Kubernetes Objekte (e.g., Service, Deployment, StatefulSet) um ein PostgreSQL Cluster zu erstellen.</p><p>In diesem Artikel wird <a href=https://github.com/zalando/postgres-operator>Zalando&rsquo;s Postgres Operator</a> zum Einsatz kommen, um ein PostgreSQL cluster in Kubernetes zu betreiben.</p><h3 id=storage>Storage</h3><p>ownCloud braucht Storage um die hochgeladenen Dateien zu speichern. Die Datenbank braucht auch einen Speicher (Storage) für, e.g., User Logins.</p><p>Für Owncloud macht ein Filesystem Storage, als bekanntestes Beispiel <a href=https://nfs.org/>NFS</a>, am meisten Sinn. Grund für Nutzung eines Filesystem Storage anstatt Block Storage ist, dass Block Storage nicht wirklich für mehr als einen Writer gemacht ist.
Man kann auch Object Storage, bekannte Beispiele AWS S3, in ownCloud einbinden, jedoch &ldquo;beschränken&rdquo; wir uns in dieser Artikelreihe auf die Nutzung des Filesystem Storage für ownCloud.</p><p>Für PostgreSQL sollte zwingend Block Storage verwendet werden, da es dort sonst zu Performanceeinbusen kommt. Hintergrund der Performanceeinbusen ist, dass bei Block Storage kann die Datenbank &ldquo;direkter&rdquo; schreiben. Dabei kann der Linux Kernel entsprechend Caching betreiben.</p><p>Nun da die Frage geklärt ist welcher Storage Typ für die verschiedenen Komponenten zu nutzen ist, gehen wir über zum Einsatz kommenden Storage Software.</p><h4 id=ceph>Ceph</h4><p>Das <a href=https://ceph.com>Ceph</a> Projekt existiert seit ungefähr 2006.
Ceph hat als oberste Priorität Datensicherheit. Das passt perfekt, da wir keine unserer wertvollen Daten, e.g., Urlaubsfotos, Musik oder ähnliches, verlieren möchten.</p><p>Man muss sich auch keine Sorgen machen das Ceph so schnell nicht mehr weiterentwickelt wird. Die <a href=https://ceph.com/foundation/>Ceph Foundation</a> unterstützt Ceph zentral, um die starke Entwicklung noch stärker als sie schon ist voran zu treiben.
Das zeigt Mal wieder wie gut es ist wenn Firmen die Open Source nutzen &ldquo;zusammen kommen&rdquo; und gemeinsam an einem Strang ziehen.</p><p>Ceph an sich ist sehr komplex, bringt dafür aber auch einiges an Features mit sich. Neben Filesystem storage, gibt es auch Block storage und sogar Object Storage in verschiedenen Protokollen (e.g., S3 kompatibles Protokoll, OpenStack SWIFT).
Was ich grundlegend empfehlen würde ist, sich durch das <a href=http://docs.ceph.com/docs/master/start/intro/>Intro to Ceph - Ceph Documentation</a> durch zulesen um die Grundkonzepte zu verstehen.
<a href=https://ceph.com/users/>CERN, Deutsche Telekom, und viele andere Organistationen und Firmen</a> nutzen Ceph als Storage System für ihre Applikationen.</p><p>Wahrscheinlich kommt jetzt die Frage auf &ldquo;Wo soll Ceph laufen?&rdquo;. Das ist eine gute Frage die jedoch schnell beantwortet ist, in Kubernetes. <a href=https://rook.io/>Rook.io</a> ist der Weg das zu schaffen.</p><p>Rook ermöglicht es Ceph und andere Software für persistente Datenhaltung, wie z.B. EdgeFS, Minio, CockroachDB und weitere, in Kubernetes laufen zu lassen.</p><p>Beim Punkt <a href=#datenbank-postgresql>Datenbank - PostgreSQL</a> wurden Kubernetes Operatoren angesprochen. Rook ist genau auch ein Operator, der auf die Custom Kubernetes Objekte reagiert und dann zum Beispiel bei <code>CephCluster</code> Objekten ein Ceph Cluster in Kubernetes Stück für Stück startet.
Neben des Erstellen des Ceph Clusters, kümmert sich Rook momentan auch um das erstellen und löschen von Volumen in Ceph, damit auch das &ldquo;Management&rdquo; der passenden <code>PersistentVolume</code> Objekt in Kubernetes.</p><p>Für Container und Kubernetes Interessierte kann ich empfehlen sich in die Themen <a href=https://kubernetes.io/blog/2020/01/15/container-storage-interface-ga/>Kubernetes Blog - Container Storage Interface (CSI)</a> und <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/>Kubernetes - Persistent Volumes</a> einzulesen.</p><p>Damit haben wir also den Punkt Storage für ownCloud in Kubernetes geklärt.
Fehlt nur noch eine Komponente, Redis.</p><h3 id=redis>Redis</h3><p>Standardmäßig wird die Datenbank für &ldquo;File Locking&rdquo; eingesetzt. Jedoch ist das eine entsprechende Last die am Ende eher störend für die Datenbank ist, deswegen werden wir Redis dafür einsetzen.
Zu diesem Thema gibt es <a href=https://doc.owncloud.com/server/admin_manual/configuration/files/files_locking_transactional.html>ownCloud - Transactional File Locking</a></p><p>Dafür wird auch wieder ein Operator eingesetzt, der uns das Leben dabei entsprechend einfacher machen soll. <a href=https://kubedb.com/docs/0.12.0/welcome/>kubed Operator</a> kann unteranderem Redis als Cluster in Kubernetes laufen lassen.</p><p>Für mehr Informationen zum Redis Part im kubed Operator, siehe <a href=https://kubedb.com/docs/0.12.0/concepts/databases/redis/>Redis Documentation - kubedb Operator</a>.</p><h2 id=der-plan>Der Plan</h2><p>Um eine Übersicht zu geben wie das in Kubernetes aussehen wird, hier ein Diagram mit dem &ldquo;Geflecht&rdquo; aus Komponenten:</p><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=owncloud-in-kubernetes-rook-ceph.png itemprop=contentUrl><img itemprop=thumbnail src=owncloud-in-kubernetes-rook-ceph.png width=100%></a><figcaption><h4>ownCloud in Kubernetes mit Rook Ceph Storage - Architektur Diagramm</h4></figcaption></figure></div><p>Um das ganze nochmal in Stichpunkten zusammenzufassen:</p><ul><li>Kubernetes um ownCloud und die anderen Komponenten als Container laufen zu lassen.<ul><li>Ingress Controller (hängt von der Kubernetes Installation ab) um ownCloud im Internet verfügbar zu machen.</li></ul></li><li><a href=https://github.com/zalando/postgres-operator>Zalando&rsquo;s Postgres Operator</a> für PostgreSQL Cluster in Kubernetes.</li><li><a href=https://kubedb.com/docs/0.12.0/welcome/>kubed Operator</a> für Redis Cluster in Kubernetes.</li><li>Ceph als Storage und per <a href=https://rook.io/>Rook.io</a> als Container in Kubernetes.</li></ul><p>Das ist der Plan und der Plan wird im zweiten Teil der Artikelreihe, Schritt für Schritt umgesetzt um ownCloud in Kubernetes redundant und ausfallsicher laufen zu lassen.</p></article><footer class=post-footer><ul class=post-tags><li><a href=https://edenmal.moe/tags/Articles><span class=tag>Articles</span></a></li><li><a href=https://edenmal.moe/tags/ownCloud><span class=tag>OwnCloud</span></a></li></ul><p class=post-copyright>© This page/post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License, please give source if you wish to quote or reproduce.This post was published <strong>684</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.</p></footer><script src=https://utteranc.es/client.js repo=galexrt/edenmal.moe issue-term=title label=blogpost theme=icy-dark crossorigin=anonymous async></script></section><footer class=site-footer><p>© 2017-2024 Alexander Trost</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with customized theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><link rel=stylesheet href=https://edenmal.moe/styles/icofont.min.min.css><script async src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.min.120e30ad299b8d6548dd1fbb6ab1d45fb508bf080219df63e5ab9750b1241207.js integrity="sha256-Eg4wrSmbjWVI3R+7arHUX7UIvwgCGd9j5auXULEkEgc="></script><script type=text/x-mathjax-config>
  MathJax.Ajax.config.path["MathJax"] = "/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5";
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://edenmal.moe/scripts/index.min.0375b6e63e18876ff8d4ad95bf8ef081176b6b994398d5bd22f5140f45565d37.js integrity="sha256-A3W25j4Yh2/41K2Vv47wgRdra5lDmNW9IvUUD0VWXTc="></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(){console.log("[ServiceWorker] Registered")})</script></body></html>