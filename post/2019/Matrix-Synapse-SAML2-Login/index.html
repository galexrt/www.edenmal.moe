<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Matrix Synapse SAML2 Login | Edenmal - Sysadmin Garden of Eden</title>
<meta name=author content="Alexander Trost"><meta name=description content="Tutorial on how to use Keycloak with Matrix Synapse Homeserver for authentication of users."><meta name=twitter:site content="@galexrt"><meta name=twitter:title content="Matrix Synapse SAML2 Login | Edenmal - Sysadmin Garden of Eden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/Matrix-Synapse-SAML2-Login.png"><meta name=twitter:description content="Tutorial on how to use Keycloak with Matrix Synapse Homeserver for authentication of users."><meta property="og:type" content="article"><meta property="og:title" content="Matrix Synapse SAML2 Login"><meta property="og:description" content="Tutorial on how to use Keycloak with Matrix Synapse Homeserver for authentication of users."><meta property="og:url" content="https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/"><meta property="og:image" content="https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/Matrix-Synapse-SAML2-Login.png"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=Cache-Control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#4d4ac7"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Edenmal"><meta name=msapplication-tooltip content="Edenmal"><meta name=msapplication-navbutton-color content="#4d4ac7"><meta name=msapplication-TileColor content="#4d4ac7"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://edenmal.moe/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://edenmal.moe/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://edenmal.moe/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://edenmal.moe/icons/icon-192x192.png><link rel=apple-touch-icon href=https://edenmal.moe/icons/icon-152x152.png><link rel=manifest href=https://edenmal.moe/manifest.json><link rel=preload href=https://edenmal.moe/styles/main-rendered.min.css as=style><link rel=preload href=https://edenmal.moe/images/avatar.png as=image><link rel=preload href=https://edenmal.moe/images/grey-prism.svg as=image><style>body{background-color:#f4f3f1;background-image:url(/images/grey-prism.svg);background-repeat:repeat;background-attachment:fixed}</style><link rel=stylesheet href=https://edenmal.moe/styles/main-rendered.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.min.css><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.819c76b4bba0f8b8c568f6e4860173f1d16e5046c01b008f4705ae823b5766e1.js integrity="sha256-gZx2tLug+LjFaPbkhgFz8dFuUEbAGwCPRwWugjtXZuE="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.min.2fcfc43be15566e9378af0e8247ba57fec8d4ee95c5dba15cf97e84d6c2115bc.js integrity="sha256-L8/EO+FVZuk3ivDoJHulf+yNTulcXboVz5foTWwhFbw="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.min.77ec5e7d7f844e9b6c2413a352b48194493a65c75d94d5cd9679a225c2da773c.js integrity="sha256-d+xefX+ETptsJBOjUrSBlEk6ZcddlNXNlnmiJcLadzw="></script><script src=https://edenmal.moe/scripts/pswp-init.min.299a530b67d8be41667aa9ed78920e272e970b0ac8ab7540ba3a7c1382b52de2.js integrity="sha256-KZpTC2fYvkFmeqnteJIOJy6XCwrIq3VAujp8E4K1LeI="></script></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class=icofont-caret-up aria-hidden=true></span></a>
<a role=button aria-label="Print page" title="Print page" class=print-page onclick=window.print()><span class=icofont-print aria-hidden=true></span></a></div><header class=site-header><a class=avatara href=https://edenmal.moe/><img class=avatar src=https://edenmal.moe/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://edenmal.moe/>Edenmal</a></h2><p class=subtitle>Sysadmin Garden of Eden</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class=icofont-navigation-menu aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://edenmal.moe/>Home</a></li><li class=menu-item><a href=https://edenmal.moe/about/>About</a></li><li class=menu-item><a href=https://edenmal.moe/tags/>Tags</a></li><li class=menu-item><a href=https://edenmal.moe/events/>Events</a></li><li class=menu-item><a href=https://edenmal.moe/site-notice/>Impressum</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:me@galexrt.moe title=Email aria-label=Email><span class=icofont-envelope aria-hidden=true></span></a></li><li class=social-item><a href=https://galexrt.moe/ rel=me title=Homepage aria-label=Homepage><span class=icofont-page aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/galexrt rel=me title=GitHub aria-label=GitHub><span class=icofont-github aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/galexrt rel=me title=Twitter aria-label=Twitter><span class=icofont-twitter aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/alexander-trost rel=me title=LinkedIn aria-label=LinkedIn><span class=icofont-linkedin aria-hidden=true></span></a></li><li class=social-item><a href=//www.xing.com/profile/Alexander_Trost18 rel=me title=XING aria-label=XING><span class=icofont-xing aria-hidden=true></span></a></li><li class=social-item><a rel=alternate type=application/rss+xml href=https://edenmal.moe/index.xml title=RSS aria-label=RSS><span class=icofont-rss aria-hidden=true></span></a></li></ul></nav></header><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><section class="main post-detail"><header class=post-header><h1 class=post-title>Matrix Synapse SAML2 Login</h1><p class=post-meta>Author Alexander Trost · Read Time 11 minutes · Created Fri Jun 28 11:51:19 2019 · Updated Fri Mar 25 21:33:36 2022</p></header><article class=post-content><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/Matrix-Synapse-SAML2-Login.png itemprop=contentUrl><img itemprop=thumbnail src=https://edenmal.moe/post/2019/Matrix-Synapse-SAML2-Login/Matrix-Synapse-SAML2-Login.png width=850px></a></figure></div><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#matrix-syanspe>Matrix Syanspe</a></li><li><a href=#keycloak>Keycloak</a><ul><li><a href=#saml2-client>SAML2 Client</a></li><li><a href=#saml-20-identity-provider-metadata-file>SAML 2.0 Identity Provider Metadata file</a></li></ul></li><li><a href=#files>Files</a><ul><li><a href=#replacements>Replacements</a></li><li><a href=#synapseconfigkeypem-and-synapseconfigcertpem><code>/synapse/config/key.pem</code> and <code>/synapse/config/cert.pem</code></a></li><li><a href=#synapseconfigidpxml><code>/synapse/config/idp.xml</code></a></li><li><a href=#synapseconfigsp_confpy><code>/synapse/config/sp_conf.py</code></a></li><li><a href=#synapsesaml2_attribute_mapsmappy><code>/synapse/saml2_attribute_maps/map.py</code></a></li><li><a href=#your-matrix-synapse-homeserver-config-yaml-file>Your Matrix Synapse Homeserver Config YAML file</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav><hr><blockquote><p><strong>NOTE</strong></p><p>This is a very rough write-up on how to use Keycloak SAML2 with a Matrix Synapse Homeserver for user authentication. Keep in mind that not all points outlined here may 100% work for you and &ldquo;turning and changing&rdquo; some parameters may be needed to get it working for your setup.</p></blockquote><h2 id=intro>Intro</h2><p>This blog post is especially made for Keycloak SAML 2.0 SSO with Matrix with the <a href=https://github.com/matrix-org/synapse/pull/5422>GitHub matrix-org/synapse - Complete the SAML2 implementation #5422</a>, which is based on my draft PR <a href=https://github.com/matrix-org/synapse/pull/5316>GitHub matrix-org/synapse - SAML2 Improvements and redirect stuff #5316</a>.</p><blockquote><p><strong>THANKS</strong></p><p>Thanks to Helder Ferreira (<a href=https://twitter.com/wounn>@wounn Twitter</a>, <a href=https://github.com/HelderFSFerreira>HelderFSFerreira GitHub</a>) for reaching out to me and updating the configs in this post!</p></blockquote><h2 id=matrix-syanspe>Matrix Syanspe</h2><p>To get SAML 2.0 working you need to have a Matrix Synapse Homeserver running version at least <a href=https://matrix.org/blog/2019/07/04/synapse-1-1-0-released>version <code>1.1,0</code></a>.</p><p>In addition to that you need to have the <code>pysaml2</code> Python module installed and <code>xmlsec1</code> must be installed on the Matrix Synapse homeserver too.</p><p>On Debian and CentOS (possibly all RHEL based OSes) the package is called <code>xmlsec1</code>.</p><p>Be sure to verify that the path to <code>xmlsec1</code> is correctly configured in the upcoming <code>/synapse/config/sp_conf.py</code> section. To make sure you have the right path for the <code>pysaml2</code> config, run <code>which xmlsec1</code> and use the printed out path for the <code>xmlsec_binary</code> option.</p><blockquote><p><strong>NOTE</strong></p><p>The blog post assumes that the config for the Matrix Synapse Homeserver is located in <code>/synapse/config/</code> directory, you can simply change this as long as you change it in all files and / or steps to do.</p></blockquote><h2 id=keycloak>Keycloak</h2><h3 id=saml2-client>SAML2 Client</h3><p>In Keycloak create a new SAML client and set the settings of that client as follows:</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-settings-tab.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-settings-tab.png width=100%></a><figcaption><h4>Keycloak Client Settings</h4></figcaption></figure><p>Two mappers should be created:</p><ul><li><code>uid</code> for the username.<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-mapper-uid.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-mapper-uid.png width=100%></a><figcaption><h4>Keycloak Client Mapper uid Options</h4></figcaption></figure><ul><li><code>Mapper Type</code> - <code>User Property</code></li><li><code>Property</code> - <code>Username</code></li><li><code>Friendly Name</code> - <code>uid</code></li><li><code>SAML Attribute Name</code> - <code>uid</code></li><li><code>SAML Attribute NameFormat</code> - <code>URI Reference</code></li></ul></li><li><code>displayName</code> for the displayed name in Keycloak.<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-mapper-displayname.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-mapper-displayname.png width=100%></a><figcaption><h4>Keycloak Client Mapper displayName Options</h4></figcaption></figure><ul><li><code>Mapper Type</code> - <code>Javascript Mapper</code></li><li><code>Script</code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6272a4>// Concat First and Last name of user when non-empty
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>names <span style=color:#ff79c6>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>firstName <span style=color:#ff79c6>=</span> user.getFirstName();
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (firstName.length <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>    names.push(firstName);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>lastName <span style=color:#ff79c6>=</span> user.getLastName();
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (lastName.length <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>    names.push(lastName);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exports <span style=color:#ff79c6>=</span> names.join(<span style=color:#f1fa8c>&#34; &#34;</span>);
</span></span></code></pre></div></li><li><code>Single Value Attribute</code> - <code>On</code></li><li><code>Friendly Name</code> - <code>displayName</code></li><li><code>SAML Attribute Name</code> - <code>displayName</code></li><li><code>SAML Attribute NameFormat</code> - <code>Basic</code></li></ul></li></ul><p>In the end it should look like this:</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-mappers-list.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-mappers-list.png width=100%></a><figcaption><h4>Keycloak Client Mappers List</h4></figcaption></figure><blockquote><p><strong>INFO</strong></p><p>Thanks to <a href=http://disq.us/p/239xrfr>this comment</a> for pointing to the correct attributes to use for Matrix Synapse code to pick&rsquo;em up!</p></blockquote><h3 id=saml-20-identity-provider-metadata-file>SAML 2.0 Identity Provider Metadata file</h3><p>Now download the Keycloak &ldquo;SAML 2.0 Identity Provider Metadata&rdquo; file.
You can get it when you login to the &ldquo;Keycloak Admin Console&rdquo; and then click the &ldquo;SAML 2.0 Identity Provider Metadata&rdquo; link in the <code>General</code> tab (selected by default) at the <code>Endpoints</code> list.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-realm-settings.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-realm-settings.png width=100%></a><figcaption><h4>Keycloak Realm Settings</h4></figcaption></figure><blockquote><p><strong>NOTE</strong></p><p>Should you not have this button / link in the <code>Endpoints</code> list, update your Keycloak instance to version <code>6.0.1</code> or higher!</p><p>If you have a very good reason to not keep your Keycloak uptodate, you can try to get the file from <code>https://YOUR_KEYCLOAK_URL/auth/realms/YOUR_REALM/protocol/saml/descriptor</code>.
(Replace the placeholders according to your setup)</p></blockquote><h2 id=files>Files</h2><h3 id=replacements>Replacements</h3><p>Be sure to replace the following strings with your value:</p><ul><li><code>matrix.example.com</code> - Your Matrix homeserver address.</li><li><code>matrix-example-com</code> - The name of the SAML2 Keycloak client you chose during the client creation.</li></ul><h3 id=synapseconfigkeypem-and-synapseconfigcertpem><code>/synapse/config/key.pem</code> and <code>/synapse/config/cert.pem</code></h3><p>Certificate and key from Keycloak Client &ldquo;SAML Keys&rdquo; tab page.
If there is no certificate and key shown, press the <code>Generate new keys</code> button to generate them.</p><p>Click the <code>Export</code> button, set the following options before clicking the <code>Download</code> button:</p><ul><li>Archive Format: <code>PKCS12</code></li><li>Key Alias: The name of your Keycloak Client.</li><li>Key Password: A password which is used later to &ldquo;decrypt&rdquo; the PKCS12 cert + key store.</li><li>Realm Certificate Alias: <code>master</code></li><li>Store password: Either another password or the same as for <code>Key Password</code>.</li></ul><p>You should get a file named <code>keystore.p12</code> after pressing the <code>Download</code> button.</p><p>Now run the following sequence of commands to extract the key and cert in PEM format (this assumes the file is named <code>keystore.p12</code> and the password chosen is <code>example123</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>KEYSTORE_PW</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;example123&#34;</span>
</span></span><span style=display:flex><span>$ openssl pkcs12 -in keystore.p12 -password <span style=color:#f1fa8c>&#34;pass:</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KEYSTORE_PW</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> -nocerts -nodes | openssl rsa -out key.pem
</span></span><span style=display:flex><span><span style=color:#44475a>writing RSA key
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>$ openssl pkcs12 -in keystore.p12 -password <span style=color:#f1fa8c>&#34;pass:</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KEYSTORE_PW</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> -nodes | openssl x509 -out cert.pem
</span></span></code></pre></div><p>Two files, <code>key.pem</code> and <code>cert.pem</code>, are now generated in your current directory and now just need to be placed in the <code>/synapse/config/</code> directory (full paths see section title) on the Matrix Synapse host(s).</p><h3 id=synapseconfigidpxml><code>/synapse/config/idp.xml</code></h3><blockquote><p><strong>NOTE</strong></p><p>If you have already downloaded the &ldquo;SAML 2.0 Identity Provider Metadata&rdquo; file as mentioned in the <a href=#saml-2-0-identity-provider-metadata-file>Keycloak - SAML 2.0 Identity Provider Metadata file section</a>, you can just use and copy it to <code>/synapse/config/idp.xml</code> on the Matrix Synapse Homeserver.</p></blockquote><p>You can get it when you login to the &ldquo;Keycloak Admin Console&rdquo; and then click the &ldquo;SAML 2.0 Identity Provider Metadata&rdquo; link in the <code>General</code> tab (selected by default) at the <code>Endpoints</code> list.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-realm-settings.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-realm-settings.png width=100%></a><figcaption><h4>Keycloak Realm Settings</h4></figcaption></figure><blockquote><p><strong>NOTE</strong></p><p>Should you not have this button / link in the <code>Endpoints</code> list, update your Keycloak instance to version <code>6.0.1</code> or higher!</p><p>If you have a very good reason to not keep your Keycloak uptodate, you can try to get the file from <code>https://YOUR_KEYCLOAK_URL/auth/realms/YOUR_REALM/protocol/saml/descriptor</code>.
(Replace the placeholders according to your setup)</p></blockquote><p>Be sure to copy the downloaded file to <code>/synapse/config/idp.xml</code> on the Matrix Synapse Homeserver.</p><p><strong>Example Keycloak SAML 2.0 Identity Provider Metadata file</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>&lt;!--
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ Copyright 2016 Red Hat, Inc. and/or its affiliates
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ and other contributors as indicated by the @author tags.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ you may not use this file except in compliance with the License.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ You may obtain a copy of the License at
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ Unless required by applicable law or agreed to in writing, software
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ See the License for the specific language governing permissions and
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  ~ limitations under the License.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>  --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;EntitiesDescriptor</span> <span style=color:#50fa7b>Name=</span><span style=color:#f1fa8c>&#34;urn:keycloak&#34;</span> <span style=color:#50fa7b>xmlns=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:metadata&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>xmlns:dsig=</span><span style=color:#f1fa8c>&#34;http://www.w3.org/2000/09/xmldsig#&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;EntityDescriptor</span> <span style=color:#50fa7b>entityID=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>&lt;IDPSSODescriptor</span> <span style=color:#50fa7b>WantAuthnRequestsSigned=</span><span style=color:#f1fa8c>&#34;true&#34;</span>
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>protocolSupportEnumeration=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:protocol&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&lt;KeyDescriptor</span> <span style=color:#50fa7b>use=</span><span style=color:#f1fa8c>&#34;signing&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>                          <span style=color:#ff79c6>&lt;dsig:KeyInfo&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>&lt;dsig:KeyName&gt;</span>[REDACTED]<span style=color:#ff79c6>&lt;/dsig:KeyName&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>&lt;dsig:X509Data&gt;</span>
</span></span><span style=display:flex><span>                              <span style=color:#ff79c6>&lt;dsig:X509Certificate&gt;</span>[REDACTED]<span style=color:#ff79c6>&lt;/dsig:X509Certificate&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>&lt;/dsig:X509Data&gt;</span>
</span></span><span style=display:flex><span>                          <span style=color:#ff79c6>&lt;/dsig:KeyInfo&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&lt;/KeyDescriptor&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;SingleLogoutService</span>
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>Binding=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>Location=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master/protocol/saml&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;SingleLogoutService</span>
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>Binding=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>Location=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master/protocol/saml&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent<span style=color:#ff79c6>&lt;/NameIDFormat&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:2.0:nameid-format:transient<span style=color:#ff79c6>&lt;/NameIDFormat&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified<span style=color:#ff79c6>&lt;/NameIDFormat&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress<span style=color:#ff79c6>&lt;/NameIDFormat&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;SingleSignOnService</span> <span style=color:#50fa7b>Binding=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>Location=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master/protocol/saml&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;SingleSignOnService</span>
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>Binding=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>Location=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master/protocol/saml&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>&lt;SingleSignOnService</span>
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>Binding=</span><span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:bindings:SOAP&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>Location=</span><span style=color:#f1fa8c>&#34;https://__YOUR_KEYCLOAK_URL__/auth/realms/master/protocol/saml&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>&lt;/IDPSSODescriptor&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;/EntityDescriptor&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/EntitiesDescriptor&gt;</span>
</span></span></code></pre></div><h3 id=synapseconfigsp_confpy><code>/synapse/config/sp_conf.py</code></h3><p>This is the <code>pysaml2</code> config file. It configures <code>pysaml2</code> to talk with the Keycloak server and do SAML2 authentication.</p><p>Create this file with the following content:
(Don&rsquo;t forget to replace the placeholders, see <a href=#replacements>Replacements section</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> saml2
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> saml2.saml <span style=color:#ff79c6>import</span> NAME_FORMAT_URI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BASE <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;https://matrix.example.com/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CONFIG <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;entityid&#34;</span>: <span style=color:#f1fa8c>&#34;matrix-example-com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;description&#34;</span>: <span style=color:#f1fa8c>&#34;Matrix Server&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;service&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;sp&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;matrix-login&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;endpoints&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;single_sign_on_service&#34;</span>: [
</span></span><span style=display:flex><span>                    (BASE <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;_matrix/saml2/authn_response&#34;</span>, saml2<span style=color:#ff79c6>.</span>BINDING_HTTP_POST),
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;assertion_consumer_service&#34;</span>: [
</span></span><span style=display:flex><span>                    (BASE <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;_matrix/saml2/authn_response&#34;</span>, saml2<span style=color:#ff79c6>.</span>BINDING_HTTP_POST),
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#6272a4>#&#34;single_logout_service&#34;: [</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>#    (BASE + &#34;_matrix/saml2/logout&#34;, saml2.BINDING_HTTP_POST),</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>#],</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;required_attributes&#34;</span>: [<span style=color:#f1fa8c>&#34;uid&#34;</span>,],
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;optional_attributes&#34;</span>: [<span style=color:#f1fa8c>&#34;displayName&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;sign_assertion&#34;</span>: <span style=color:#ff79c6>True</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;sign_response&#34;</span>: <span style=color:#ff79c6>True</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;debug&#34;</span>: <span style=color:#bd93f9>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;key_file&#34;</span>: <span style=color:#f1fa8c>&#34;/synapse/config/key.pem&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;cert_file&#34;</span>: <span style=color:#f1fa8c>&#34;/synapse/config/cert.pem&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;encryption_keypairs&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;key_file&#34;</span>: <span style=color:#f1fa8c>&#34;/synapse/config/key.pem&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;cert_file&#34;</span>: <span style=color:#f1fa8c>&#34;/synapse/config/cert.pem&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;attribute_map_dir&#34;</span>: <span style=color:#f1fa8c>&#34;/synapse/saml2_attribute_maps/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;local&#34;</span>: [<span style=color:#f1fa8c>&#34;/synapse/config/idp.xml&#34;</span>]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#6272a4># If you want to have organization and contact_person for the pysaml2 config</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#&#34;organization&#34;: {</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;name&#34;: &#34;Example AB&#34;,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;display_name&#34;: [(&#34;Example AB&#34;, &#34;se&#34;), (&#34;Example Co.&#34;, &#34;en&#34;)],</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;url&#34;: &#34;http://example.com/roland&#34;,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#},</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#&#34;contact_person&#34;: [{</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;given_name&#34;: &#34;Example&#34;,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;sur_name&#34;: &#34;Example&#34;,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;email_address&#34;: [&#34;example@example.com&#34;],</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    &#34;contact_type&#34;: &#34;technical&#34;,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#    },</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#],</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Make sure to have xmlsec1 installed on your host(s)!</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;xmlsec_binary&#34;</span>: <span style=color:#f1fa8c>&#34;/usr/bin/xmlsec1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;name_form&#34;</span>: NAME_FORMAT_URI,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=synapsesaml2_attribute_mapsmappy><code>/synapse/saml2_attribute_maps/map.py</code></h3><p>This file is your way to map attributes coming from the SSO (/ IDP) service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>MAP <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;identifier&#34;</span>: <span style=color:#f1fa8c>&#34;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;fro&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;uid&#39;</span>: <span style=color:#f1fa8c>&#39;uid&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;displayName&#39;</span>: <span style=color:#f1fa8c>&#39;displayName&#39;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;to&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;uid&#39;</span>: <span style=color:#f1fa8c>&#39;uid&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;displayName&#39;</span>: <span style=color:#f1fa8c>&#39;displayName&#39;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><strong>NOTE</strong></p><p><strong><code>fro</code> in the above file is not a typo</strong>, see <a href=https://pysaml2.readthedocs.io/en/latest/howto/config.html#attribute-map-dir><code>pysaml2</code> Documentation - &ldquo;Configuration of pySAML2 entities&rdquo; - <code>attribute_map_dir</code></a>.</p></blockquote><h3 id=your-matrix-synapse-homeserver-config-yaml-file>Your Matrix Synapse Homeserver Config YAML file</h3><p>Add or change the following lines to your Matrix Synapse Homeserver config (make sure you don&rsquo;t duplicate the lines as that may lead to weird server behavior and / or issues):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#6272a4>## Registration ##</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Registration can be rate-limited using the parameters in the &#34;Ratelimiting&#34;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># section of this file.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Enable registration for new users.</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>enable_registration</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>saml2_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4># `sp_config` is the configuration for the pysaml2 Service Provider.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># See pysaml2 docs for format of config.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Default values will be used for the &#39;entityid&#39; and &#39;service&#39; settings,</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># so it is not normally necessary to specify them unless you need to</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># override them.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>sp_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#  # point this to the IdP&#39;s metadata. You can use either a local file or</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#  # (preferably) a URL.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    #local: [&#34;saml2/idp.xml&#34;]</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>remote</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>url</span>: https://YOUR_KEYCLOAK_URL/auth/realms/YOUR_REALM/protocol/saml/descriptor
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # By default, the user has to go to our login page first. If you&#39;d like</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # to allow IdP-initiated login, set &#39;allow_unsolicited: true&#39; in a</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # &#39;service.sp&#39; section:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    #</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    #service:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    #  sp:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    #    allow_unsolicited: true</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # The examples below are just used to generate our metadata xml, and you</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # may well not need them, depending on your setup. Alternatively you</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    # may need a whole lot more detail - see the pysaml2 docs!</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    description: [&#34;My awesome SP&#34;, &#34;en&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    name: [&#34;Test SP&#34;, &#34;en&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    organization:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#      name: Example com</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#      display_name:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#        - [&#34;Example co&#34;, &#34;en&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#      display_name:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#        - [&#34;Example co&#34;, &#34;en&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#      url: &#34;http://example.com&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#    contact_person:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#      - given_name: Bob</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#        sur_name: &#34;the Sysadmin&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#        email_address&#34;: [&#34;admin@example.com&#34;]</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#        contact_type&#34;: technical</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Instead of putting the config inline as above, you can specify a</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># separate pysaml2 configuration file:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>config_path</span>: <span style=color:#f1fa8c>&#34;/data/sp_conf.py&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Or for container envs:</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>config_path</span>: <span style=color:#f1fa8c>&#34;/synapse/config/sp_conf.py&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># The lifetime of a SAML session. This defines how long a user has to</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># complete the authentication process, if allow_unsolicited is unset.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># The default is 5 minutes.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#saml_session_lifetime: 5m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># An external module can be provided here as a custom solution to</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># mapping attributes returned from a saml provider onto a matrix user.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>user_mapping_provider</span>:
</span></span><span style=display:flex><span>    <span style=color:#6272a4># The custom module&#39;s class. Uncomment to use a custom module.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#module: mapping_provider.SamlMappingProvider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Custom configuration values for the module. Below options are</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># intended for the built-in provider, they should be changed if</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># using a custom module. This section will be passed as a Python</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># dictionary to the module&#39;s `parse_config` method.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#6272a4># The SAML attribute (after mapping via the attribute maps) to use</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># to derive the Matrix ID from. &#39;uid&#39; by default.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># Note: This used to be configured by the</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># saml2_config.mxid_source_attribute option. If that is still</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># defined, its value will be used instead.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#mxid_source_attribute: displayName</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># The mapping system to use for mapping the saml attribute onto a</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># matrix ID.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># Options include:</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#  * &#39;hexencode&#39; (which maps unpermitted characters to &#39;=xx&#39;)</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#  * &#39;dotreplace&#39; (which replaces unpermitted characters with</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#     &#39;.&#39;).</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># The default is &#39;hexencode&#39;.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># Note: This used to be configured by the</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># saml2_config.mxid_mapping option. If that is still defined, its</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># value will be used instead.</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>#mxid_mapping: dotreplace</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># In previous versions of synapse, the mapping from SAML attribute to</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># MXID was always calculated dynamically rather than stored in a</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># table. For backwards- compatibility, we will look for user_ids</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># matching such a pattern before creating a new account.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># This setting controls the SAML attribute which will be used for this</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># backwards-compatibility lookup. Typically it should be &#39;uid&#39;, but if</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># the attribute maps are changed, it may be necessary to change it.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># The default is &#39;uid&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#grandfathered_mxid_source_attribute: upn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Directory in which Synapse will try to find the template files below.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># If not set, default templates from within the Synapse package will be used.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># DO NOT UNCOMMENT THIS SETTING unless you want to customise the templates.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># If you *do* uncomment it, you will need to make sure that all the templates</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># below are in the directory.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># Synapse will look for the following templates in this directory:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># * HTML page to display to users if something goes wrong during the</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#   authentication process: &#39;saml_error.html&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#   This template doesn&#39;t currently need any variable to render.</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># You can see the default templates at:</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># https://github.com/matrix-org/synapse/tree/master/synapse/res/templates</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#template_dir: &#34;res/templates&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>password_config</span>:
</span></span><span style=display:flex><span>   <span style=color:#6272a4># Uncomment to disable password login</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>enabled</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4># Uncomment to disable authentication against the local password</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4># database. This is ignored if `enabled` is false, and is only useful</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4># if you have other password_providers.</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#localdb_enabled: false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4># Uncomment and change to a secret random string for extra security.</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4># DO NOT CHANGE THIS AFTER INITIAL SETUP!</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#pepper: &#34;EVEN_MORE_SECRET&#34;</span>
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><blockquote><p><strong>THANKS</strong></p><p>And again a huge thanks to Helder Ferreira (<a href=https://twitter.com/wounn>@wounn Twitter</a>, <a href=https://github.com/HelderFSFerreira>HelderFSFerreira GitHub</a>) for updating the configs in this post!</p></blockquote><h2 id=summary>Summary</h2><p>That should be it, now when you go to your Riot Webapp (and chose your Matrix Homeserver) it should give you a button to login through your (SAML2) SSO.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=riot-webapp-sso-login.png itemprop=contentUrl><img itemprop=thumbnail src=riot-webapp-sso-login.png width=900px></a><figcaption><h4>Riot Webapp SSO Login</h4></figcaption></figure><p>If it does not work, make sure your Matrix Synapse Homeserver has the required <code>pysaml2</code> module installed and check your Synapse Homeserver logs for errors and / or warnings.</p><p>Have Fun!</p></article><footer class=post-footer><ul class=post-tags><li><a href=https://edenmal.moe/tags/Matrix><span class=tag>Matrix</span></a></li><li><a href=https://edenmal.moe/tags/Matrix-Synapse><span class=tag>Matrix Synapse</span></a></li><li><a href=https://edenmal.moe/tags/SAML2><span class=tag>SAML2</span></a></li></ul><p class=post-copyright>© This page/post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License, please give source if you wish to quote or reproduce.This post was published <strong>650</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.</p></footer><script src=https://utteranc.es/client.js repo=galexrt/edenmal.moe issue-term=title label=blogpost theme=icy-dark crossorigin=anonymous async></script></section><footer class=site-footer><p>© 2017-2024 Alexander Trost</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with customized theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><link rel=stylesheet href=https://edenmal.moe/styles/icofont.min.min.css><script async src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.min.120e30ad299b8d6548dd1fbb6ab1d45fb508bf080219df63e5ab9750b1241207.js integrity="sha256-Eg4wrSmbjWVI3R+7arHUX7UIvwgCGd9j5auXULEkEgc="></script><script type=text/x-mathjax-config>
  MathJax.Ajax.config.path["MathJax"] = "/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5";
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://edenmal.moe/scripts/index.min.0375b6e63e18876ff8d4ad95bf8ef081176b6b994398d5bd22f5140f45565d37.js integrity="sha256-A3W25j4Yh2/41K2Vv47wgRdra5lDmNW9IvUUD0VWXTc="></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(){console.log("[ServiceWorker] Registered")})</script></body></html>