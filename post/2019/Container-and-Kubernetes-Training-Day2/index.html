<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Container and Kubernetes - Day #2 | Edenmal - Sysadmin Garden of Eden</title>
<meta name=author content="Alexander Trost"><meta name=description content="Container und Kubernetes Training Material"><meta name=twitter:site content="@galexrt"><meta name=twitter:title content="Container and Kubernetes - Day #2 | Edenmal - Sysadmin Garden of Eden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png"><meta name=twitter:description content="Container und Kubernetes Training Material"><meta property="og:type" content="article"><meta property="og:title" content="Container and Kubernetes - Day #2"><meta property="og:description" content="Container und Kubernetes Training Material"><meta property="og:url" content="https://edenmal.moe/post/2019/Container-and-Kubernetes-Training-Day2/"><meta property="og:image" content="https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=https://edenmal.moe/post/2019/Container-and-Kubernetes-Training-Day2/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=Cache-Control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#4d4ac7"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Edenmal"><meta name=msapplication-tooltip content="Edenmal"><meta name=msapplication-navbutton-color content="#4d4ac7"><meta name=msapplication-TileColor content="#4d4ac7"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://edenmal.moe/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://edenmal.moe/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://edenmal.moe/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://edenmal.moe/icons/icon-192x192.png><link rel=apple-touch-icon href=https://edenmal.moe/icons/icon-152x152.png><link rel=manifest href=https://edenmal.moe/manifest.json><link rel=preload href=https://edenmal.moe/styles/main-rendered.min.css as=style><link rel=preload href=https://edenmal.moe/images/avatar.png as=image><link rel=preload href=https://edenmal.moe/images/grey-prism.svg as=image><style>body{background-color:#f4f3f1;background-image:url(/images/grey-prism.svg);background-repeat:repeat;background-attachment:fixed}</style><link rel=stylesheet href=https://edenmal.moe/styles/main-rendered.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.min.css><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.819c76b4bba0f8b8c568f6e4860173f1d16e5046c01b008f4705ae823b5766e1.js integrity="sha256-gZx2tLug+LjFaPbkhgFz8dFuUEbAGwCPRwWugjtXZuE="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.min.2fcfc43be15566e9378af0e8247ba57fec8d4ee95c5dba15cf97e84d6c2115bc.js integrity="sha256-L8/EO+FVZuk3ivDoJHulf+yNTulcXboVz5foTWwhFbw="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.min.77ec5e7d7f844e9b6c2413a352b48194493a65c75d94d5cd9679a225c2da773c.js integrity="sha256-d+xefX+ETptsJBOjUrSBlEk6ZcddlNXNlnmiJcLadzw="></script><script src=https://edenmal.moe/scripts/pswp-init.min.299a530b67d8be41667aa9ed78920e272e970b0ac8ab7540ba3a7c1382b52de2.js integrity="sha256-KZpTC2fYvkFmeqnteJIOJy6XCwrIq3VAujp8E4K1LeI="></script></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class=icofont-caret-up aria-hidden=true></span></a>
<a role=button aria-label="Print page" title="Print page" class=print-page onclick=window.print()><span class=icofont-print aria-hidden=true></span></a></div><header class=site-header><a class=avatara href=https://edenmal.moe/><img class=avatar src=https://edenmal.moe/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://edenmal.moe/>Edenmal</a></h2><p class=subtitle>Sysadmin Garden of Eden</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class=icofont-navigation-menu aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://edenmal.moe/>Home</a></li><li class=menu-item><a href=https://edenmal.moe/about/>About</a></li><li class=menu-item><a href=https://edenmal.moe/tags/>Tags</a></li><li class=menu-item><a href=https://edenmal.moe/events/>Events</a></li><li class=menu-item><a href=https://edenmal.moe/site-notice/>Impressum</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:me@galexrt.moe title=Email aria-label=Email><span class=icofont-envelope aria-hidden=true></span></a></li><li class=social-item><a href=https://galexrt.moe/ rel=me title=Homepage aria-label=Homepage><span class=icofont-page aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/galexrt rel=me title=GitHub aria-label=GitHub><span class=icofont-github aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/galexrt rel=me title=Twitter aria-label=Twitter><span class=icofont-twitter aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/alexander-trost rel=me title=LinkedIn aria-label=LinkedIn><span class=icofont-linkedin aria-hidden=true></span></a></li><li class=social-item><a href=//www.xing.com/profile/Alexander_Trost18 rel=me title=XING aria-label=XING><span class=icofont-xing aria-hidden=true></span></a></li><li class=social-item><a rel=alternate type=application/rss+xml href=https://edenmal.moe/index.xml title=RSS aria-label=RSS><span class=icofont-rss aria-hidden=true></span></a></li></ul></nav></header><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><section class="main post-detail"><header class=post-header><h1 class=post-title>Container and Kubernetes - Day #2</h1><p class=post-meta>Author Alexander Trost · Read Time 58 minutes · Created Tue Mar 26 21:25:06 2019 · Updated Fri Dec 29 23:12:53 2023</p></header><article class=post-content><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png itemprop=contentUrl><img itemprop=thumbnail src=https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png width=850px></a></figure></div><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#welcome>Welcome!</a></li><li><a href=#goal-of-the-training>Goal of the Training</a></li><li><a href=#goal-of-the-day>Goal of the day</a></li><li><a href=#container-orchestration-tools>Container Orchestration Tools</a><ul><li><a href=#a-wild-docker-swarm-appeared-kubernetes-used-rolling-update-it-was-very-effective>A wild Docker Swarm appeared. Kubernetes used rolling update. It was very effective.</a></li></ul></li><li><a href=#kubernetes>Kubernetes</a><ul><li><a href=#so-what-has-kubernetes-to-offer---features-of-kubernetes>So what has Kubernetes to offer? - Features of Kubernetes</a></li><li><a href=#use-case-examples>Use Case Examples</a></li></ul></li><li><a href=#from-docker-compose-to-kubernetes>From <code>docker-compose</code> to Kubernetes?</a></li><li><a href=#prepare-for-the-kubernetes-madness>Prepare for the Kubernetes madness</a><ul><li><a href=#kubernetes-system-requirements>Kubernetes System Requirements</a></li><li><a href=#clone-the-workshop-repo>Clone the workshop repo</a></li></ul></li><li><a href=#kubernetes-first-steps>Kubernetes: First Steps</a><ul><li><a href=#hello-world>Hello World!</a></li><li><a href=#lets-run-wordpress-on-kubernetes>Let&rsquo;s run WordPress on Kubernetes</a></li></ul></li><li><a href=#get-creative-with-your-kubernetes-cluster>Get creative with your Kubernetes cluster!</a><ul><li><a href=#already-done-with-the-php-guestbook-application-on-kubernetes>Already done with the PHP Guestbook application on Kubernetes?</a></li><li><a href=#summary>Summary</a></li></ul></li><li><a href=#deploy-your-own-kubernetes-cluster>Deploy your own Kubernetes cluster</a><ul><li><a href=#what-is-kubeadm>What is <code>kubeadm</code>?</a></li><li><a href=#what-are-kubeadms-prerequisites>What are <code>kubeadm</code>&rsquo;s prerequisites?</a></li><li><a href=#steps-to-your-own-kubernetes-cluster>Steps to your own Kubernetes cluster</a></li><li><a href=#lets-extend-the-kubernetes-cluster-with-cool-features>Let&rsquo;s extend the Kubernetes cluster with cool features!</a></li></ul></li><li><a href=#network-stuff-because-network-in-kubernetes-is-special>Network stuff. Because network in Kubernetes is &ldquo;special&rdquo;.</a><ul><li><a href=#requirements>Requirements</a></li><li><a href=#sdn-and-cni>SDN and CNI?</a></li><li><a href=#kube-proxy---takes-care-of-service-clusterips><code>kube-proxy</code> - Takes care of Service ClusterIPs</a></li><li><a href=#ipv6>IPv6</a></li></ul></li><li><a href=#deploying-an-application-to-kubernetes>Deploying an application to Kubernetes</a><ul><li><a href=#busybox-pod-example>BusyBox Pod Example</a></li></ul></li><li><a href=#kubessar---a-glossar-but-for-kubernetes>Kubessar - A Glossar but for Kubernetes</a><ul><li><a href=#labels>Labels</a></li><li><a href=#annotations>Annotations</a></li><li><a href=#namespace>Namespace</a></li><li><a href=#pod-po>Pod (<code>po</code>)</a></li><li><a href=#deployment-deployment>Deployment (<code>deployment</code>)</a></li><li><a href=#service-svc>Service (<code>svc</code>)</a></li><li><a href=#other-objects>Other Objects</a></li><li><a href=#object-manifest-files>Object Manifest files</a></li></ul></li><li><a href=#kubectl---our-tool-to-catch-deploy-them-all><code>kubectl</code> - Our tool to catch deploy them all</a><ul><li><a href=#the-basics-of-kubectl>The Basics of <code>kubectl</code></a></li><li><a href=#advanced-kubectl-usage>Advanced kubectl usage</a></li></ul></li><li><a href=#summary-of-the-day>Summary of the Day</a></li></ul></nav><hr><h2 id=welcome>Welcome!</h2><p>Quick short introduction to myself, my name is Alexander Trost. I’m a sysadmin who loves automation, containers, coding in Go, playing games but also with new technologies.
I&rsquo;m currently working at Cloudical as a DevOps Engineer, helping companies move to the cloud and / or to container technologies (e.g., Docker, Kubernetes, etc).</p><h2 id=goal-of-the-training>Goal of the Training</h2><p>The training is going to show how simple it is to get started with containers. In this case Docker is used, as it is the most popular container toolchain and runtime right now.
After getting to know containers and Docker, we will hopefully realize that there is a need for some kind of <em>magical</em> orchestration layer to run applications and more in containers (in an orchestrated way). The important if you haven&rsquo;t noticed here is the orchestration of containers in an automated and orchestrated manner.</p><hr><h2 id=goal-of-the-day>Goal of the day</h2><p>Goal of the day is to setup a Kubernetes cluster using the official Kubernetes tool <code>kubeadm</code> and deploy an example application consisting of multiple applications (application, database, cache, etc).
In the process of setting up the Kubernetes cluster with <code>kubeadm</code>, we will look at the architecture of a Kubernetes cluster. This will show how Kubernetes does the container orchestration and what additional features it brings. After that everyone should have a basic understanding what is needed to run a Kubernetes cluster and how to deploy an application to it.</p><hr><h2 id=container-orchestration-tools>Container Orchestration Tools</h2><blockquote><p><em>The right tool for the right workload. Keep that in mind or you&rsquo;ll have problems soon.</em></p></blockquote><p>There are many container orchestration tools available, to name a few here is a list:</p><ul><li><a href=https://docs.docker.com/engine/swarm/>Docker Swarm</a></li><li><a href=https://mesos.apache.org/>Mesos by Apache</a></li><li><a href=https://rancher.com/>Rancher by Rancher Labs</a></li><li><a href=https://portainer.io/>Portainer by Portainer Team</a></li><li><a href=https://www.nomadproject.io/>Nomad by Hashicorp</a></li><li>And many more..</li></ul><p>There are a lot of tools available to orchestrate containers with. Problem is with so many tools available, to find the one that fits your use case.</p><p>As you kind of have potentially already decided, in this training we will go over Kubernetes.</p><p>For me personally the reason is that</p><h3 id=a-wild-docker-swarm-appeared-kubernetes-used-rolling-update-it-was-very-effective>A wild Docker Swarm appeared. Kubernetes used rolling update. It was very effective.</h3><p>*Insert Pokemon battle between Docker Swarm and Kubernetes here*</p><p>The choice of the orchestration tool, depends on many factors:</p><ul><li>What workloads are you going to handle? How many containers would you run? What features do you need from the platform for your application to run smoothly?</li><li>Where do you want to run your workload? In the cloud? On premise?</li><li>What are your security requirements?</li><li>What integration possibilites does the orchestration tool offer? E.g., Istio - Service Mesh Proxy / Routing.</li></ul><p>My choice when I initially got into the container orchestration topic were <a href=https://docs.docker.com/engine/swarm/>Docker Swarm</a> and <a href=https://mesos.apache.org/>Mesos by Apache</a>. After &ldquo;playing around&rdquo; with both, I concluded for me that <a href=https://docs.docker.com/engine/swarm/>Docker Swarm</a> was not mature enough from itself and the ecosystem around it, <a href=https://mesos.apache.org/>Mesos by Apache</a> on the other hand was interesting to play around with, but after I have tried out Kubernetes it just felt &ldquo;better.
Some of the other reasons for me to use Kubernetes are and were that if you know what you are doing it is pretty easy to use with the right tools, developed by Google who have long experience with containers (from what they tell they are also one of the longest and largest users of containers) and, I know weird point for someone running Kubernetes privately, but Kubernetes can scale up to 5000 nodes (version v1.14). Most users will never reach this amount of nodes but still it is good to know it could and it would if you should ever have the need for so many nodes.</p><p>If the ecosystem / community around a software project is very important for you, I can safely say that Kubernetes is there. &ldquo;Most important&rdquo; is also that not only individuals are working on Kubernetes, but also many many companies come together to work on Kubernetes the project itself and the ecosystem around it.</p><p>There are probably more reasons to like and / or dislike Kubernetes, but that is up to you now!
I hope you can form yourself a good opinion on Kubernetes, even though a very much opinioated person is holding the workshop. ;-)</p><h2 id=kubernetes>Kubernetes</h2><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png itemprop=contentUrl><img itemprop=thumbnail src=https://edenmal.moe/post/covers/kubernetes-logo-with-bg.png width=700px></a><figcaption><h4>Kubernetes Logo</h4></figcaption></figure><h3 id=so-what-has-kubernetes-to-offer---features-of-kubernetes>So what has Kubernetes to offer? - Features of Kubernetes</h3><h4 id=kubernetes-is-a-framework---paint-your-picture-in>Kubernetes is a framework - Paint your picture in!</h4><p>Kubernetes is &ldquo;just&rdquo; a framework. It gives you basic abilities to run containres, make them available to the outside, make storage available for your application and more.</p><p>But even Kubernetes features have an &ldquo;end&rdquo;. For this Kubernetes has many abilities to allow extending the Kubernetes API to for example add custom objects.
Example: A &ldquo;Project&rdquo; object which causes a Namespace (logical name isolation in Kubernetes) and, e.g., create Network Security Policies, for network side protection, automatically through an operator (pattern)*.</p><p>*Operator pattern = A pattern of watching for objects and / or object changes in the Kubernetes API and then reacting to those creations / changes (e.g., creating other objects).</p><h4 id=you-want-to-use-storage-in-kubernetes>You want to use Storage in Kubernetes?</h4><p>No problem, Kubernetes allows you to specify claims for storage volumes and depending on if your storage system / software supports it dynamically provision these &ldquo;claims for storage&rdquo; for you.
Meaning that an application create a <code>PersistentVolumeClaim</code> requesting 50 Gigabytes of storage. Kubernetes and / or the storage system / software will then take care of creating the actual volume / disk and to not lose track of it, create a <code>PersistentVolume</code> in Kubernetes again (&ldquo;Mapping&rdquo; between Kubernetes and the Storage).</p><p>This allows for simple use of storage depending on if your storage system / software supports it.</p><blockquote><p><strong>NOTE</strong></p><p>Container Storage Interface (CSI) plays an important role now and in the future. CSI is a set of interfaces which a storage system / software can implement so that Kubernetes and other systems can easily request storage.</p><p>&ldquo;To mention it already there is a new interface for requesting / &lsquo;managing&rsquo; storage, which is named <strong>C</strong>ontainer <strong>S</strong>torage <strong>I</strong>nterface (CSI). The goal of CSI is to have an unified interface through which anyone can request storage. Mounting of the requested storage is done by the storage dependent CSI driver then.&rdquo;</p></blockquote><h4 id=and-there-are-even-more-features>And there are even more features!</h4><ul><li>Horizontal Autoscaling for applications</li><li>Loadbalancing for Level 4 and 7 Services.<ul><li>Level 7 Services are balanced using a Ingress Controller, which is not part of Kubernetes by default.</li></ul></li><li>Utilizing existing Storage for your applications (e.g., Ceph, NFS).</li><li>Framework - Kubernetes API is easily extensible, examples for applications helping you with Kubernetes are:<ul><li><a href=https://istio.io/>Istio</a> - &ldquo;Connect, secure, control, and observe services&rdquo;.</li><li><a href=https://vitess.io/>Vitess</a> - &ldquo;Vitess is a database clustering system for horizontal scaling of MySQL&rdquo;.</li><li><a href=https://github.com/coreos/prometheus-operator>Prometheus Operator</a> - &ldquo;Prometheus Operator creates / configures/manages Prometheus clusters atop Kubernetes&rdquo;.</li></ul></li><li>And more features already there and to come..</li></ul><p>The <a href=https://github.com/kubernetes/enhancements>GitHub kubernetes / enhancements repository</a> is the place for enchancement tracking and backlog for Kubernetes. I suggest to check it out to see what else is on the &ldquo;roadmap&rdquo;.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=kubernetes-its-dangerous-to-go-alone.png itemprop=contentUrl><img itemprop=thumbnail src=kubernetes-its-dangerous-to-go-alone.png width=550px></a><figcaption><h4>Kubernetes - 'It's dangerous to go alone' *Zelda Meme intensifies*</h4></figcaption></figure><h3 id=use-case-examples>Use Case Examples</h3><h4 id=web-applications>Web applications</h4><p>The ease of Ingress objects in Kubernetes, allows for simple exposition of HTTP based applications.</p><p>Example Ingres Object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: extensions/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Ingress
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: my-web-app
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4># tls: Also possible with ease</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>host</span>: example.com
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>path</span>: /
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>serviceName</span>: my-web-app
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>servicePort</span>: <span style=color:#bd93f9>8080</span>
</span></span></code></pre></div><blockquote><p><strong>NOTE</strong></p><p>We will get back to <code>Ingress</code> objects later on in the training, but for now we have to begin at the very basics.</p></blockquote><p>The example Ingress object causes the &ldquo;application&rdquo; <code>my-web-app</code> to be available reachable when accessing <code>example.com</code>.
You could even have different <code>path</code>s for different application in the same or other objects, making it easy to &ldquo;combine&rdquo; multiple (micro-)services.</p><p>Having more insight and control of incoming traffic can be done as shown in the next use case example.</p><h4 id=service-mesh-istio-linkerd-and-others>Service Mesh (Istio, Linkerd, and others)</h4><p>Service Meshes allow you to gain more insight into the flow of traffic to your application.
Not only can you gain more insight, but you can also control the traffic that with, e.g., Circuit Breaker Pattern and more possibilites.</p><ul><li><a href=https://istio.io>Istio</a></li><li><a href=https://linkerd.io>Linkerd</a></li><li><a href=https://www.consul.io/docs/connect/>Consul Connect</a></li><li><a href=https://www.envoyproxy.io/learn/service-mesh>Enovy Service Mesh</a></li></ul><h4 id=and-more->And more &mldr;</h4><p>There are many more use cases you can cover using Kubernetes or even containers in general.</p><p>To get some examples / case studies of companies moving / having moved to Kubernetes, checkout the <a href=https://kubernetes.io/case-studies/>Kubernetes - Case Studies page</a>.</p><hr><h2 id=from-docker-compose-to-kubernetes>From <code>docker-compose</code> to Kubernetes?</h2><p>There are tools to translate <code>docker-compose</code> files to Kubernetes &ldquo;format&rdquo; (<a href=https://github.com/kubernetes/kompose>kompose</a>), but I would not recommend them for two simple reasons:</p><ul><li>To learn what objects are necessary and needed behind an application in Kubernetes, it is better to, e.g., have a Hackathon where everyone is playing around with the application to get it running on Kubernetes. <strong>=> Learn effect!</strong><ul><li>Additionally as there are some features which Docker doesn&rsquo;t have, getting to know them through such a Hackathon makes for a good team building either way :-)</li><li>Besides in the end you simply need to know the (basic) objects of Kubernetes to run, scale and keep your application running.</li></ul></li><li>The results are &ldquo;basic&rdquo; and still require manual improvements (e.g., health probes / checks, persistent storage, and more) to be made that the applications can / will run smoothly in Kubernetes with everything Kubernetes has to offer.</li></ul><p>So please take yourself the time to play around with the available Kubernetes objects and features. This should give you an overview of what is available and optimal for your application(s) when you think / want to move them to Kubernetes.</p><p>Taking yourself time for looking into Kubernetes and other solutions will allow you to make a good decision, instead of using a butcher knife in an operation where a scalpel would have gotten the job done perfectly fine.</p><hr><h2 id=prepare-for-the-kubernetes-madness>Prepare for the Kubernetes madness</h2><p>Connect to the first training VM using SSH and follow the sections ahead.</p><h3 id=kubernetes-system-requirements>Kubernetes System Requirements</h3><p>The following are the system requirements for a Kubernetes node which will or has been setup with <code>kubeadm</code>:</p><ul><li>2 or more CPU cores</li><li>2 or more Gigabytes of memory</li><li>No MAC nor IP address duplication for the servers used.<ul><li>For later on, make sure you don&rsquo;t use IP ranges already used in your company / organisation.</li></ul></li></ul><p>For the full list of requirements, see <a href=https://kubernetes.io/docs/setup/independent/install-kubeadm/#before-you-begin>Kubernetes - Install kubeadm documentation &ldquo;Before you begin&rdquo; section</a>.</p><h3 id=clone-the-workshop-repo>Clone the workshop repo</h3><p>Clone the repository, which contains the example and task files, from GitHub <code>https://github.com/galexrt/workshop-container-docker-kubernetes.git</code>. It&rsquo;ll provide all files and tasks used in the Workshop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ git clone https://github.com/galexrt/workshop-container-docker-kubernetes.git
</span></span><span style=display:flex><span><span style=color:#44475a>Cloning into &#39;workshop-container-docker-kubernetes&#39;...
</span></span></span><span style=display:flex><span><span style=color:#44475a>remote: Enumerating objects: 30, done.
</span></span></span><span style=display:flex><span><span style=color:#44475a>remote: Counting objects: 100% (30/30), done.
</span></span></span><span style=display:flex><span><span style=color:#44475a>remote: Compressing objects: 100% (23/23), done.
</span></span></span><span style=display:flex><span><span style=color:#44475a>remote: Total 30 (delta 3), reused 30 (delta 3), pack-reused 0
</span></span></span><span style=display:flex><span><span style=color:#44475a>Unpacking objects: 100% (30/30), done.
</span></span></span></code></pre></div><p>Now you are ready to run your first Pods in Kubernetes!</p><hr><h2 id=kubernetes-first-steps>Kubernetes: First Steps</h2><h3 id=hello-world>Hello World!</h3><p>Kubernetes has something similar to <code>docker run</code>, <code>kubectl run</code>. We will use <code>kubectl run</code> for the first example to get started but to already say it, <code>kubectl run</code> isn&rsquo;t really used in the end to, e.g., deploy applications.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl run -it --image<span style=color:#ff79c6>=</span>hello-world --restart<span style=color:#ff79c6>=</span>Never hello-world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#44475a>Hello from Docker!
</span></span></span><span style=display:flex><span><span style=color:#44475a>This message shows that your installation appears to be working correctly.
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>To generate this message, Docker took the following steps:
</span></span></span><span style=display:flex><span><span style=color:#44475a> 1. The Docker client contacted the Docker daemon.
</span></span></span><span style=display:flex><span><span style=color:#44475a> 2. The Docker daemon pulled the &#34;hello-world&#34; image from the Docker Hub.
</span></span></span><span style=display:flex><span><span style=color:#44475a>    (amd64)
</span></span></span><span style=display:flex><span><span style=color:#44475a> 3. The Docker daemon created a new container from that image which runs the
</span></span></span><span style=display:flex><span><span style=color:#44475a>    executable that produces the output you are currently reading.
</span></span></span><span style=display:flex><span><span style=color:#44475a> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span></span></span><span style=display:flex><span><span style=color:#44475a>    to your terminal.
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>To try something more ambitious, you can run an Ubuntu container with:
</span></span></span><span style=display:flex><span><span style=color:#44475a> $ docker run -it ubuntu bash
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Share images, automate workflows, and more with a free Docker ID:
</span></span></span><span style=display:flex><span><span style=color:#44475a> https://hub.docker.com/
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>For more examples and ideas, visit:
</span></span></span><span style=display:flex><span><span style=color:#44475a> https://docs.docker.com/get-started/
</span></span></span></code></pre></div><p>Cool, isn&rsquo;t it? It&rsquo;s a bit like Docker, but so different in the end.</p><p>What the <code>kubectl run</code> command has just done is create a &ldquo;Pod&rdquo; object in Kubernetes which is similar to a &ldquo;container&rdquo; in the Docker world, more on that later.</p><p>Kubernetes uses YAML (/ JSON for the hardcore people) to define objects in its API. The mentioned &ldquo;Pod&rdquo; object is one of them.</p><blockquote><p><strong>NOTE</strong></p><p>Speaking of YAML:</p></blockquote><ul><li>To separate documents / objects, you put <code>---</code> in between them.</li><li>Don&rsquo;t use tabs, only use spaces in YAML files, or your gonna have a bad time.<ul><li>You can use, e.g., <a href=https://yaml-online-parser.appspot.com/>Online YAML Parser</a> to validate your YAML files online or also locally through addons / extensions in your editor.</li></ul></li></ul><p>There are different types of objects in Kubernetes, as an example with the above <code>kubectl run</code> command we created a <code>Pod</code> object with the name of <code>hello-world</code>.</p><h4 id=lets-look-at-the-pod-object>Let&rsquo;s look at the &ldquo;Pod&rdquo; object</h4><p>(<em>No we are not talking about the band <a href=https://en.wikipedia.org/wiki/P.O.D.>P.O.D.</a></em>)</p><p>To look at the Pod we just created using <code>kubectl run</code>, we are going to use <code>kubectl get</code> now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get pod hello-world
</span></span><span style=display:flex><span><span style=color:#44475a>NAME          READY   STATUS      RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>hello-world   0/1     Completed   0          12s
</span></span></span></code></pre></div><p>This only got us the Pod in a &ldquo;list&rdquo; format. Omitting the <code>hello-world</code> (object name) would cause all Pod objects in the current <code>Namespace</code> to be listed.
A <code>Namespace</code> is a logical naming space separation for objects, meaning that it is possible to have multiple <code>hello-world</code> Pod objects in different namespaces at the same time.
This is one of the &ldquo;special&rdquo; points of Kubernetes, being able to separate object (/ applications) by name already.</p><p>To get the YAML / JSON contents of this Pod object, we add the <code>--output=FORMAT</code> (short: <code>-o FORMAT</code>) flag to the <code>kubectl get</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>$ kubectl get pod hello-world --output yaml
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Pod
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>cni.projectcalico.org/podIP</span>: <span style=color:#bd93f9>100.67.92.19</span>/32
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>creationTimestamp</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:30Z&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>run</span>: hello-world
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: hello-world
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resourceVersion</span>: <span style=color:#f1fa8c>&#34;11195745&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selfLink</span>: /api/v1/namespaces/default/pods/hello-world
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>uid</span>: c919ad65-6e96-11e9-a6f0-9600001d3faa
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>image</span>: hello-world
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>imagePullPolicy</span>: Always
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: hello-world
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>resources</span>: {}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>stdin</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>stdinOnce</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>terminationMessagePath</span>: /dev/termination-log
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>terminationMessagePolicy</span>: File
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>tty</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>mountPath</span>: /var/run/secrets/kubernetes.io/serviceaccount
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: default-token-lb5tz
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>readOnly</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>dnsPolicy</span>: ClusterFirst
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>enableServiceLinks</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>nodeName</span>: k8s02-node-mvljd2v2nje-htz-deu-fsn1dc1.clster.systems
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>priority</span>: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>restartPolicy</span>: Never
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>schedulerName</span>: default-scheduler
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>securityContext</span>: {}
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>serviceAccount</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>serviceAccountName</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>terminationGracePeriodSeconds</span>: <span style=color:#bd93f9>30</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>tolerations</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>effect</span>: NoExecute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>key</span>: node.kubernetes.io/not-ready
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>operator</span>: Exists
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>tolerationSeconds</span>: <span style=color:#bd93f9>300</span>
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>effect</span>: NoExecute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>key</span>: node.kubernetes.io/unreachable
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>operator</span>: Exists
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>tolerationSeconds</span>: <span style=color:#bd93f9>300</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: default-token-lb5tz
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>secret</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>defaultMode</span>: <span style=color:#bd93f9>420</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>secretName</span>: default-token-lb5tz
</span></span><span style=display:flex><span><span style=color:#ff79c6>status</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>conditions</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>lastProbeTime</span>: <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>lastTransitionTime</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:31Z&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>reason</span>: PodCompleted
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>status</span>: <span style=color:#f1fa8c>&#34;True&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: Initialized
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>lastProbeTime</span>: <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>lastTransitionTime</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:35Z&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>reason</span>: PodCompleted
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>status</span>: <span style=color:#f1fa8c>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: Ready
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>lastProbeTime</span>: <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>lastTransitionTime</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:35Z&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>reason</span>: PodCompleted
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>status</span>: <span style=color:#f1fa8c>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: ContainersReady
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>lastProbeTime</span>: <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>lastTransitionTime</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:30Z&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>status</span>: <span style=color:#f1fa8c>&#34;True&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: PodScheduled
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>containerStatuses</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>containerID</span>: containerd://f5cea87d6ed60944a564c28ca9f1ee96eda262f3d0b99587fa798c0ea1a650ed
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: docker.io/library/hello-world:latest
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>imageID</span>: docker.io/library/hello-world@sha256:92695bc579f31df7a63da6922075d0666e565ceccad16b59c3374d2cf4e8e50e
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>lastState</span>: {}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: hello-world
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ready</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>restartCount</span>: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>state</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>terminated</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>containerID</span>: containerd://f5cea87d6ed60944a564c28ca9f1ee96eda262f3d0b99587fa798c0ea1a650ed
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>exitCode</span>: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>finishedAt</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:34Z&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>reason</span>: Completed
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>startedAt</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:34Z&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>hostIP</span>: [IP OF NODE REMOVED]
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>phase</span>: Succeeded
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>podIP</span>: <span style=color:#bd93f9>100.67.92.19</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>qosClass</span>: BestEffort
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>startTime</span>: <span style=color:#f1fa8c>&#34;2019-05-04T18:02:31Z&#34;</span>
</span></span></code></pre></div><p><em>Don&rsquo;t worry be happy</em> the <code>kubectl get</code> output shows &ldquo;every field&rdquo; of this Pod object named <code>hello-world</code> (e.g., the <code>status</code> part / structure is generated by Kubernetes). You don&rsquo;t need to provide all of them, only a (small) handful of the specifications.</p><p>A Pod is Kubernetes&rsquo; logical unit of workload, which consists of one or more containers which will all run in the same Node. All containers of a Pod share the same process and network context, and volumes (for data) between each other.
Besides that a Pod has one IP address (+ localhost).</p><blockquote><p><strong>NOTE</strong></p><p>If at any point you need help with Kubernetes object and / or <code>kubectl</code> cli, please look into the <a href=#kubessar>Kubessar</a> and / or <a href=#kubectl-our-tool-to-catch-deploy-them-all><code>kubectl</code> - Our tool to <del>catch</del> deploy them all</a> sections for information.</p></blockquote><h4 id=pod---no-not-the-band>Pod - &ldquo;No, not the band&rdquo;</h4><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes101><code>kubernetes101</code></a></p></blockquote><p>A simple nginx Pod object which will run a <code>nginx</code> container with the port 80 exposed inside the cluster looks like this (file <code>nginx.yaml</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Pod
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: nginx
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: nginx
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>image</span>: nginx:1.15.12
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: nginx
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: MY_ENV_VAR
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;Hello World!&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: http
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>protocol</span>: TCP
</span></span></code></pre></div><p>Splitting the YAML into multiple parts to get a better grasp of what what means and which parts are &ldquo;more&rdquo; important.</p><p>An object no matter if it is a Kubernetes &ldquo;in-built&rdquo; or custom defined ones, will always consist of:</p><ul><li><code>apiVersion</code>: The (API) version of the object API to use.</li><li><code>kind</code>: &ldquo;Type&rdquo; of the object (e.g., <code>Pod</code>, <code>Namespace</code>, <code>Deployment</code>).</li><li><code>metadata</code>: Basic information about an object, see next section, <a href=#metadata><code>metadata</code></a>.</li><li><code>spec</code>: Specifications for the <code>Pod</code> object.</li></ul><p>There are more parts to a <code>Pod</code> object, but there are .</p><h5 id=metadata><code>metadata</code></h5><ul><li><code>annotations</code>: Key / Value pairs with information you do not need to select the objects by; <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/>Kubernetes - Annotations</a>.</li><li><code>labels</code>: Labels of the object (key-value pairs). You can select objects based on labels (<a href=#getting-listing-objects-using-label-selectors>label selector</a>); <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/>Kubernetes - Labels</a>.</li><li><code>name</code>: Name of the object; <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/names/>Kubernetes - Names</a>.</li><li><code>namespace</code>: This is only available when the object (API) is namespaced, allows to separate objects name-wise from each other; <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/>Kubernetes - Namespaces</a>.</li></ul><h5 id=spec-and-others><code>spec</code> and others</h5><p>(&ldquo;others&rdquo; = e.g., <code>status</code>)</p><p>This is the part which is always different per object and also potentially different per API version (<code>apiVersion</code>).</p><p>To know how each object in itself looks, please refer to the Kubernetes API reference for your Kubernetes cluster version (<code>kubectl version</code>): <a href=https://kubernetes.io/docs/reference/>Kubernetes - Reference</a>.</p><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>spec.containers</code>: List of containers to run in this Pod (more is not good, just create more Pods).<ul><li><code>image</code>: Container image name / URL to run.</li><li><code>name</code>: Name of the container.</li><li><code>env</code>: Environment variables to add to the container.<ul><li><code>name</code>: Name of the environment variable.</li><li><code>value</code>: Value of the environment variable. In an upcoming section we will look into dynamically using so called <code>ConfigMap</code>s and <code>Secrets</code> for the configuration of your application.</li></ul></li><li><code>ports</code>: List of ports to &ldquo;open&rdquo; on the container.<ul><li><code>containerPort</code>: Port on the container.</li><li><code>name</code>: &ldquo;Human&rdquo; name for the port.</li><li><code>protocol</code>: Protocol of the port, either <code>TCP</code> or <code>UDP</code> (default <code>TCP</code>).</li></ul></li></ul></li></ul><p>That is a very basic <code>Pod</code> YAML structure, you can do much more as shown in the <a href=#so-what-has-kubernetes-to-offer-features-of-kubernetes>Kubernetes features</a> section.</p><h4 id=namespaces>Namespaces</h4><p>Namespaces in Kubernetes are exactly what the name implies, a space for names. Meaning that most objects in Kubernetes are namespaced.
Meaning that you can have a <code>Pod</code> object in Namespace <code>abc</code> and <code>xyz</code> with the same name.</p><p>Same goes for other objects, besides Pods, in Kubernetes, e.g., <code>Deployment</code>, <code>Service</code>, <code>ReplicaSet</code>, <code>PersistentVolumeClaim</code>, <code>Secret</code>, <code>ConfigMap</code> and many more.</p><blockquote><p><strong>NOTE</strong></p><p>In Kubernetes there are no sub-Namespaces and also no sub-sub-Namespaces, sub-sub-sub-sub-Namespaces. Keep that in mind when naming them.
I would recommend you to create a Namespace naming schema in some way for your Kubernetes cluster(s) in your company / organisation.</p></blockquote><h3 id=lets-run-wordpress-on-kubernetes>Let&rsquo;s run WordPress on Kubernetes</h3><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=logo-wordpress-bg-medblue.png itemprop=contentUrl><img itemprop=thumbnail src=logo-wordpress-bg-medblue.png width=400px></a><figcaption><h4>WordPress Logo</h4></figcaption></figure><p>What do we need for WordPress? Some storage for our attachments and a MySQL database. Nothing easier than that.</p><p>Before jumping further into the magical world of Kubernetes objects in form of YAML structures, let&rsquo;s look at the &ldquo;requirements&rdquo; for WordPress (no redundancy yet) from a Kubernetes feature perspective.</p><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li>We want to run a MySQL database <code>Pod</code> and WordPress <code>Pod</code>.<ul><li>We want to keep it running no matter what is going in the Kubernetes cluster (e.g., a node failure).</li><li>=> <code>Deployment</code> - Keeps X instances / <code>replicas</code> of a defined <code>Pod</code> template running. The <code>Pod</code> template contains the same information as seen in the above <a href=#let-s-look-at-the-pod>Let&rsquo;s look at the &ldquo;Pod&rdquo;</a> section.</li></ul></li><li>MySQL should be reachable under the same name and / or IP address at all times.<ul><li>=> <code>Service</code> - Causes an IP to be &ldquo;allocated&rdquo; and made reachable from within the Kubernetes cluster (Pods), and DNS records.</li></ul></li><li>WordPress should be exposed to the &ldquo;public&rdquo;.<ul><li>=> <code>Ingress</code> - Exposes a HTTP application to the Internet, which is &ldquo;selected&rdquo; through a <code>Service</code> object. This is done through a so called Kubernetes Ingress Controller, which is running, e.g., <a href=https://nginx.org/>NGINX</a>, <a href=https://traefik.io/>Traefik</a>.</li></ul></li></ul><p>We now know the Kubernetes objects we need to get a MySQL database and the WordPress running.</p><p><strong>Let&rsquo;s begin ticking off each part of the list!</strong> Starting with the <a href=#mysql-database>MySQL Database</a>.</p><h4 id=running-the-mysql-database>Running the MySQL Database</h4><p><strong>A <code>Pod</code> in itself does not have any means of being &ldquo;recreated&rdquo; when it has been deleted.</strong></p><p>That is where objects like <code>Deployments</code> (+ <code>ReplicaSet</code>) and <code>StatefulSet</code> come into play.
We start with a <code>Deployment</code> object which we can tell to always keep X instances (<code>replicas</code>) of our defined &ldquo;<code>Pod</code> template&rdquo;.</p><blockquote><p><strong>NOTE</strong></p><p>For now we leave high availability of the MySQL database Pod out of the picture.</p></blockquote><p>The &ldquo;<code>Pod</code> template&rdquo; is basically the &ldquo;same&rdquo; as a <code>Pod</code>, but with a few fields / structures left out. These left out fields / structures are &ldquo;templated&rdquo; by the Deployment object automatically.</p><p>When you create a <code>Deployment</code>, a so called <code>ReplicaSet</code> object is created automatically. The <code>ReplicaSet</code> created is the current state of the <code>Deployment</code>. Means that if the <code>Deployment</code> is updated (e.g., a new <code>image</code> is used for a container in the <code>Pod</code> template), a new <code>ReplicaSet</code> is created (there is a limit of <code>10</code> by default, they are deleted automatically).
If you delete a <code>Pod</code> that is part of the <code>Deployment</code>, the <code>ReplicaSet</code> &ldquo;magic&rdquo; in the background create a new <code>Pod</code> to fullfill the wanted <code>replicas</code> count.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes202><code>kubernetes202</code></a> - <code>mysql.yaml</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      - <span style=color:#ff79c6>image</span>: mysql:5.6
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>name</span>: MYSQL_ROOT_PASSWORD
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>value</span>: changeme
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>3306</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>protocol</span>: TCP
</span></span></code></pre></div><p>As previosuly talked about <code>apiVersion</code>, <code>kind</code> and <code>metadata</code> are for identifying the object.</p><p>The <code>spec</code> structure contains the following info:</p><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>selector</code>: The selector to &ldquo;find&rdquo; the Pods spawned from the <code>Deployment</code> (through the <code>ReplicaSet</code>; <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rollover-aka-multiple-updates-in-flight>Kubernetes - Deployments - Selector Information</a>).</li><li><code>template</code>: This is the &ldquo;Pod&rdquo; <code>template</code> structure previosuly written about, see <a href=#pod-no-not-the-band>example <code>Pod</code></a> for how a <code>Pod</code> object looks.</li></ul><p>All these fields / structures are important for the Deployment, but there are tools to have this and the other objects tempalted to reduce Time-to-Deploy (TtD).</p><blockquote><p><strong>NOTE</strong></p><p>Don&rsquo;t run a <code>kubectl</code> command on the <code>mysql.yaml</code> file yet.</p></blockquote><h4 id=configuring-the-mysql-server>Configuring the MySQL server</h4><p>In the above <a href=#pod-no-not-the-band>Pod - “No, not the band”</a> section, a <code>Pod</code> object was shown with a section called <code>env:</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>    - <span style=color:#ff79c6>name</span>: MY_ENV_VAR
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;Hello World!&#34;</span>
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>In the <strong>WDWD</strong> section, it was explained that those variables are added to the container as environment variables, so your application can consume them.
To have a better separation between the actual definition of your Pod&rsquo;s containers, we are looking into <code>ConfigMap</code>s and <code>Secret</code>s now.</p><p><code>ConfigMaps</code> and <code>Secrets</code> are basically objects to have key-value pairs of &ldquo;data&rdquo; in them. They can be used to provide applications with configuration / secrets.
An important part to mention is that if you edit a <code>ConfigMap</code> and / or <code>Secret</code> object and have a key set as an environment variable for a Pod, the environment variable is never updated due to limitations in environment variable handling for processes.
On the other hand if you have mounted a <code>ConfigMap</code> and / or <code>Secret</code> object, the mount will be updated (at latest after 1 minute, configurable) in the Pods, this means that you can &ldquo;<code>inotify</code>&rdquo; on your config file(s) and then reload dynamically.</p><h5 id=configmap><code>ConfigMap</code></h5><p>This is an example of a <code>ConfigMap</code>. It has two keys defined in it, one named <code>MY_API_SERVICE_ADDRESS</code> with a single line string value and a second one <code>config.yaml</code> which is a multi-line string.
Especially for the second key, it would make sense to mount this key as a file. This is possible by specifying the list of keys (<code>items</code>) in the <code>volumeMounts</code> list. Meaning that if you added such an entry the <code>config.yaml</code> would be available inside the Pod&rsquo;s container for your application to read from, like anyother file (<code>ConfigMap</code> and <code>Secret</code> keys mounted are read-only!).
The <code>volumeMounts</code> list, is the list of given volumes to mount to a container in a Pod, more on that in an upcoming section.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes101><code>kubernetes101</code></a> - <code>configmap.yaml</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4># You can have multiple key-value pairs in one `ConfigMap`</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>MY_API_SERVICE_ADDRESS</span>: https://my-api-service.example.com
</span></span><span style=display:flex><span>  <span style=color:#6272a4># You can specify which keys of a `ConfigMap` to mount in a Pod</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>config.yaml</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    database:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      host: broker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      port: 5234
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      username: root
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # Will be read from the environment by the application reading the `config.yaml`
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      password: ${DB_USER}</span>    
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: ConfigMap
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: my-app
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: my-config
</span></span></code></pre></div><p>If you want to, you can copy the contents of the <code>ConfigMap</code> example and run <code>kubectl create -f FILE_NAME</code> on it. After that you can use <code>kubectl get configmap NAME -o yaml</code> to look at it in the Kubernetes API.</p><h5 id=secret><code>Secret</code></h5><p>A <code>Secret</code> is only base64 encoded, so it is not so secret as the name implies. You can however encrypt the data inside the &ldquo;brain of the Kubernetes cluster&rdquo;.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes101><code>kubernetes101</code></a> - <code>secret.yaml</code></p></blockquote><p>The example below has a single key-value pair, named <code>DB_PASSWORD</code> with the base64 encoded value <code>kubernetesiscool</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4># `Secret` values are base64 encoded right now.</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>DB_PASSWORD</span>: a3ViZXJuZXRlc2lzY29vbA==
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Secret
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: my-app
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: my-app
</span></span><span style=display:flex><span><span style=color:#ff79c6>type</span>: Opaque
</span></span></code></pre></div><p>You can as for a <code>ConfigMap</code> mount specify which keys to mount in a Pod&rsquo;s containers, which will be covered now.</p><p>If you want to, you can copy the contents of the <code>Secret</code> example and run <code>kubectl create -f FILE_NAME</code> on it. After that you can use <code>kubectl get secret NAME -o yaml</code> to look at it in the Kubernetes API.</p><h5 id=moving-the-mysql-configuration-to-a-configmap-and-secret>Moving the MySQL configuration to a <code>ConfigMap</code> and <code>Secret</code></h5><blockquote><p><strong>NOTE</strong></p><p>Mounting a <code>ConfigMap</code> and <code>Secret</code> will be a topic for later on. For this section we&rsquo;ll just use values from a <code>ConfigMap</code> and <code>Secret</code> as environment variables of the example MySQL <code>Deployment</code> object here.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>MYSQL_ALLOW_EMPTY_PASSWORD</span>: <span style=color:#f1fa8c>&#34;off&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: ConfigMap
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql-config
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>MYSQL_ROOT_PASSWORD</span>: Y2hhbmdlbWU=
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Secret
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql-secret
</span></span><span style=display:flex><span><span style=color:#ff79c6>type</span>: Opaque
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>image</span>: mysql:5.6
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Two ways possible:</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>## 1. If we want to mount specific keys from the `Secret` or `ConfigMap`:</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>        <span style=color:#6272a4>### For `Secret`</span>
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: MYSQL_ROOT_PASSWORD
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>secretKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>name</span>: mysql-secret
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>key</span>: MYSQL_ROOT_PASSWORD
</span></span><span style=display:flex><span>        <span style=color:#6272a4>### For `ConfigMap`</span>
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: MYSQL_ALLOW_EMPTY_PASSWORD
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>name</span>: mysql-config
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>key</span>: MYSQL_ALLOW_EMPTY_PASSWORD
</span></span><span style=display:flex><span>        <span style=color:#6272a4>## 2. If we want to add all keys (which are all uppercase) of a `Secret` or `ConfigMap` as environment variables we can use:</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>envFrom</span>:
</span></span><span style=display:flex><span>        <span style=color:#6272a4>### For `Secret`</span>
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>secretRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: mysql-secret
</span></span><span style=display:flex><span>        <span style=color:#6272a4>### For `ConfigMap`</span>
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>configMapRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: mysql-config
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>For the first method, this would take the given <code>key</code>(s) from the <code>ConfigMap</code> / <code>Secret</code> by <code>name</code> and add that value under the environment variable name to the container of the Pod.
The <code>envFrom</code> method, will do the same but simply add all keys (which are all uppercase) to the container of the Pod as environment variables.</p><p>As fine-grained that you can specify which keys of a <code>ConfigMap</code> and <code>Secret</code> to be available as environment variables, is also possible for mounting keys into a Pod. They will be mounted as files directly.
When mounted and the <code>ConfigMap</code> and / or <code>Secret</code> is updated, the content of the mounted keys is also updated (will take at maximum one minute after the change to have propagated to each node).</p><p>Now that we know about configuration of Pods, let&rsquo;s move on to making the MySQL server available as a &ldquo;Service&rdquo; in the Kubernetes cluster.</p><h4 id=making-the-mysql-server-available-as-a-service>Making the MySQL server available as a &ldquo;Service&rdquo;</h4><p>In Kubernetes there are <code>Service</code> objects, which allow to select one or more <code>Pods</code> based on labels and &ldquo;group&rdquo; them behind &ldquo;one&rdquo; cluster wide reachable IP and a DNS record for it.</p><p>Meaning that if we were to run a web application through a <code>Deployment</code>, we would create a <code>Service</code> selecting the application <code>Pods</code> based on the labels. That would allow any application in the cluster (also an Ingress controller), to access the web application through one IP address / DNS name.
Without <code>Services</code> in Kubernetes you would need to talk to a <code>Pod</code> IP address directly, meaning that if the Pod is deleted and a new one is started that the IP address can be different. Having such one IP address and DNS name, allows for DNS based service discovery and dynamically extending an application behind that <code>Service</code> without &ldquo;anyone&rdquo; noticing.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes202><code>kubernetes202</code></a> - <code>mysql.yaml</code></p></blockquote><p>A <code>Service</code> object looks like that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>    - <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>3306</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>protocol</span>: TCP
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>type</span>: ClusterIP
</span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><p>Focusing on the <code>spec</code> part here.</p></blockquote><ul><li><code>ports</code>: List of ports.<ul><li><code>name</code>: Name of the port.</li><li><code>port</code>: Port on the <code>Service</code> that should be &ldquo;exposed&rdquo; inside the Kubernetes cluster.</li><li><code>protocol</code>: <code>TCP</code> or <code>UDP</code> (there are other protocols but &ldquo;only&rdquo; for other <code>type</code>s of <code>Service</code>).</li><li><code>targetPort</code>: Optional. Allows to use a different port on the Pod side (e.g., <code>port: 80</code> and <code>targetPort: 8080</code>, will cause traffic on the Service on port <code>80</code> to be &ldquo;redirected&rdquo; to port <code>8080</code> on the Pods).</li></ul></li><li><code>selector</code>: A label selector . With that you can select Pods based on their labels for the <code>Service</code>.</li><li><code>type</code>: Optional. <code>ClusterIP</code> (default), what that means will be looked into detail in a second.</li></ul><p>Now we look into the last mentioned field <code>type. There are multiple </code>type<code>s of the </code>Service`, which allow for different &ldquo;publishing&rdquo; / exposition of one or more Pods inside and / or outside of the Kubernetes cluster.</p><p>We&rsquo;ll scratch a network topic already with that but the actual in-deep look will be done later on.</p><blockquote><p><strong>NOTE</strong></p><p>For most software defined networks that can be used with Kubernetes a Service IP is not pingable! Only the ports in the <code>Service</code> objects are &ldquo;connected&rdquo; to the <code>Pods</code> that the <code>Service</code> is selecting.</p></blockquote><h5 id=clusterip><code>ClusterIP</code></h5><blockquote><p>&ldquo;Exposes the service on a cluster-internal IP. Choosing this value makes the service only reachable from within the cluster. This is the default ServiceType.&rdquo;
– Taken from <a href=https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types>Kubernetes - Services: ClusterIP</a></p></blockquote><p>This is the most commonly used <code>Service</code> <code>type</code>. A cluster-interally reachable IP address and a DNS name, for services inside the Kubernetes cluster to use.</p><h5 id=nodeport><code>NodePort</code></h5><blockquote><p>&ldquo;Exposes the service on each Node’s IP at a static port (the <code>NodePort</code>). A <code>ClusterIP</code> service, to which the <code>NodePort</code> service will route, is automatically created. You’ll be able to contact the <code>NodePort</code> service, from outside the cluster, by requesting <code>&lt;NodeIP>:&lt;NodePort></code>.&rdquo;
– Taken from <a href=https://kubernetes.io/docs/concepts/services-networking/service/#nodeport>Kubernetes - Services: NodePort</a></p></blockquote><p>Is a <code>ClusterIP</code> service, so an IP address and DNS name is allocated, but for this <code>ClusterIP</code> a port is opened on all Nodes of the cluster (changeable, <code>trafficPolicy</code>). The port is from the so called <code>NodePort</code> Port range.</p><h5 id=loadbalancer><code>LoadBalancer</code></h5><blockquote><p>&ldquo;Exposes the service externally using a cloud provider’s load balancer. <code>NodePort</code> and <code>ClusterIP</code> services, to which the external load balancer will route, are automatically created.&rdquo;
– Taken from <a href=https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer>Kubernetes - Services: LoadBalancer</a></p></blockquote><p>Is a <code>NodePort</code> service which has the <code>NodePort</code>(s) exposed through a Cloud load balancer. This is possible for certain cloud providers / environments (e.g., AWS, Google Cloud, OpenStack, and more).</p><h5 id=externalname><code>ExternalName</code></h5><blockquote><p>&ldquo;Maps the service to the contents of the <code>externalName</code> field (e.g. <code>foo.bar.example.com</code>), by returning a <code>CNAME</code> record with its value. No proxying of any kind is set up. This requires version 1.7 or higher of <code>kube-dns</code>.&rdquo;
– Taken from <a href=https://kubernetes.io/docs/concepts/services-networking/service/#externalname>Kubernetes - Services: ExternalName</a></p></blockquote><p>A <code>CNAME</code>for an external name (no proxying).</p><h4 id=service-dns-name-naming><code>Service</code> DNS Name Naming</h4><p>Let&rsquo;s say we have a <code>Service</code> named <code>mysql</code> in the <code>default</code> namespace. This is the cluster-internal DNS name schema:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>NAME.NAMESPACE.svc.cluster.local</span>
</span></span></code></pre></div><p>Which means for our <code>Service</code> this is its full name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>wordpress.default.svc.cluster.local</span>
</span></span></code></pre></div><p>The <code>cluster.local</code> is a customizable cluster-wide DNS prefix. I would recommend you to leave it as <code>cluster.local</code>.</p><p>Please note that for the DNS resolution <code>search</code> parameters are set in the <code>resolv.conf</code> mounted inside the Pod&rsquo;s containers.
Meaning that if a Pod in the namespace <code>default</code> wants to access the <code>mysql</code> Service, it can just use <code>mysql</code> for the DNS name.
But a Pod from the namespace <code>workshop</code>, must use at least the following DNS name <code>mysql.default.svc</code> to access the <code>mysql</code> Service in the <code>default</code> namespace.</p><h4 id=storage-for-our-precious-mysql-database>Storage for our precious MySQL database</h4><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=lotr-gollum.jpg itemprop=contentUrl><img itemprop=thumbnail src=lotr-gollum.jpg width=350px></a><figcaption><h4>LOTR Gollum - 'My precious data'</h4></figcaption></figure><p>(Taken from <a href=https://techcrunch.com/2018/09/23/our-precious/>TechCrunch | Our Precious</a>, owned by <a href=https://en.wikipedia.org/wiki/J._R._R._Tolkien>J.R.R. Tolkien</a>)</p><p>Right now if the MySQL database Pod is deleted all data in it would be lost.
We don&rsquo;t want that to happen, so we are going to put storage in the Pod. This is done using <code>PersistentVolumeClaim</code>s. A <code>PersistentVolumeClaim</code> is a way to &ldquo;request&rdquo; / &ldquo;claim&rdquo; X amount of storage for an application.
This is mostly used with dynamically provisioned storage, where the Kubernetes storage in some way is talking to a storage software / system to create <code>PersistentVolume</code>s on-demand when the user needs them.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes202><code>kubernetes202</code></a> - <code>mysql.yaml</code></p></blockquote><p>A <code>PersistentVolumeClaim</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: PersistentVolumeClaim
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>storageClassName</span>: rook-ceph-block
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>accessModes</span>:
</span></span><span style=display:flex><span>  - ReadWriteOnce
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>storage</span>: 5Gi
</span></span></code></pre></div><p>I hope it is looking pretty straight forward to you.</p><blockquote><p><strong>NOTE</strong></p><p>In the provided cluster there is a <a href=https://rook.io>Rook Ceph cluster</a> running which is running Ceph in the Kubernetes cluster and dynamically provides storage for the Kubernetes cluster.
Keep that in mind when trying in other Kubernetes cluster, besides the provided ones.</p><p><strong>WDWD</strong></p></blockquote><ul><li><code>storageClassName</code>: There are <code>StorageClass</code>es in Kubernetes which can hold different <code>parameters</code> which are given to the dynamic storage volume provisioner.</li><li><code>accessModes</code>: There are three different access modes for volumes. <code>ReadWriteOnce</code>, <code>ReadOnlyMany</code> and <code>ReadWriteMany</code>, these boil down to &ldquo;mount once&rdquo;, &ldquo;many mounts for read&rdquo; and &ldquo;many mounts for write " see <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes>Kubernetes - Persistent Volumes - Access Modes</a>.</li><li><code>resources</code>: Resource spec.<ul><li><code>requests</code><ul><li><code>storage</code>: The (minimum) size of the storage for the <code>PersistentVolume</code> to create. Can be just a number (<code>Mi</code>), <code>Mi</code>, <code>Gi</code>, <code>Ti</code> and so on.</li></ul></li></ul></li></ul><p>For the Pod from the <code>Deployment</code> to use this <code>PersistentVolumeClaim</code> is to add an entry to the <code>volumes</code> list of the Pod, and for the container(s) to consume it then an entry to the <code>volumeMounts</code> list.
The names probably make it clear that the <code>volumes</code> list the actual list of volumes that will be added to the Pod and the <code>volumeMounts</code> are then the points where the <code>volumes</code> are mounted inside the container(s) of the Pod.</p><p>Save the <code>PersistentVolumeClaim</code> as <code>mysql-pvc.yaml</code> and run <code>kubectl create -f mysql-pvc.yaml</code> on the file (from the master server).
The <code>kubectl create</code> should respond back with a message that a <code>PersistentVolumeClaim</code> has been created (no errors).</p><p>Now that we have a <code>PersistentVolumeClaim</code> &ldquo;claiming&rdquo; storage for the MySQL Pod, we just need to add that to the <code>Deployment</code> object that it will mount and use the storage.</p><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes202><code>kubernetes202</code></a> - <code>mysql-with-storage.yaml</code></p><p><strong>NOTE</strong></p><p>Have you previoulsy ran <code>kubectl create</code> / <code>kubectl apply</code> on <code>mysql.yaml</code>? Please run <code>kubectl delete -f mysql.yaml</code> to remove the objects first before continuing.</p></blockquote><p>MySQL Deployment example with <code>PersistentVolumeClaim</code> for the storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: Recreate
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app.kubernetes.io/name</span>: mysql
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>image</span>: mysql:5.6
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: MYSQL_ROOT_PASSWORD
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>value</span>: changeme
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>3306</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>volumeMounts</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>mountPath</span>: /var/lib/mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      - <span style=color:#ff79c6>name</span>: mysql
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>claimName</span>: mysql
</span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>strategy</code>: Strategy to update Pods that are spawned through the <code>Deployment</code>.<ul><li><code>type</code>: Strategy name. <code>Recreate</code> will delete an old Pod first and create a new one afterwards.</li></ul></li><li><code>volumeMounts</code>: List of mounts for the <code>volumes</code> list.<ul><li><code>name</code>: Name of the volume.</li><li><code>mountPath</code>: The path inside the container to attach the volume to.</li></ul></li><li><code>volumes</code>: List of volumes for the Pod&rsquo;s container.<ul><li><code>name</code>: Name of the volume, will be used in the <code>volumeMounts</code> list for matching to a volume.</li><li><code>persistentVolumeClaim</code>: Volume information for a <code>PersistentVolumeClaim</code>.<ul><li><code>claimName</code>: Name of an existing <code>PersistentVolumeClaim</code> to mount.</li></ul></li><li>Besides mounting storage through <code>PersistentVolumeClaim</code>s, there are other storage options available for your applications (<code>emptyDir</code>, <code>ConfigMap</code>, <code>Secrets</code>, etc).</li></ul></li></ul><p>Now that our database will not lose its data, we can run <code>kubectl create -f mysql-with-storage.yaml</code> in the task directory, this will create a MySQL Deployment which mounts the <code>PersistentVolumeClaim</code> previosuly created to the <code>mysql</code> container at <code>/var/lib/mysql</code>.</p><p>After the <code>kubectl create</code> run, we can use <code>kubectl get</code> to check if our Deployment and PersistentVolumeClaim have been created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get deployment,pod,persistentvolumeclaim
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>deployment.extensions/mysql   1/1     1            1           86s
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                         READY   STATUS      RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>pod/hello-world              0/1     Completed   0          26h
</span></span></span><span style=display:flex><span><span style=color:#44475a>pod/mysql-5fc68fb84c-bssg4   1/1     Running     0          86s
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>persistentvolumeclaim/mysql   Bound    pvc-3ede7af3-6f74-11e9-a6f0-9600001d3faa   5Gi        RWO            rook-ceph-block   86s
</span></span></span></code></pre></div><p>(The name in the <code>VOLUME</code> column at the end will be different per cluster!)</p><p>Isn&rsquo;t that cool? We now have a MySQL Pod running.</p><p>Before we make sure the database server is working, let&rsquo;s quickly close the basic storage topic, by looking at the other important volume types for applications in Kubernetes.</p><h5 id=volume-types-emptydir-configmap-secrets-etc>Volume Types (<code>emptyDir</code>, <code>ConfigMap</code>, <code>Secrets</code>, etc)</h5><p>Besides previosuly talked about <code>ConfigMap</code>s and <code>Secrets</code> which can used for environment variable and also to mount as volumes, there are some important other volume types like <code>emptyDir</code> and <code>hostPath</code>.</p><h6 id=emptydir><code>emptyDir</code></h6><p>When a Pod is created and scheduled to a node, a empty directory is created and mounted inside the Pod.
This directory is only persistent till the Pod has been deleted, if a Pod of, e.g., the same <code>Deployment</code> is put on the same node, the new Pod gets its own new empty directory and not a used one.</p><h6 id=hostpath><code>hostPath</code></h6><p>A Pod can also mount storage from the host into the container(s). Unless you have a very good reason, restrict usage of <code>hostPath</code> and use <a href=https://kubernetes.io/docs/concepts/storage/volumes/#local>Kubernetes - Local Persistent Storage</a>.</p><blockquote><p><strong>NOTE</strong></p><p>There can be good reason to mount a host path into a Pod&rsquo;s container(s), but for normal users that can lead to nodes running full because there is no data management behind <code>hostPath</code> &ldquo;volumes&rdquo;.</p></blockquote><h4 id=make-sure-the-database-server-is-working>Make sure the database server is working</h4><p>Maybe you know about <code>docker exec</code>, which can be used to run a command and / or shell inside a running container.
<code>kubectl exec</code> does the same but for Pods. If a Pod has more than one container, it will &ldquo;cmplain&rdquo; to you and tell you the list of containers, which you can specify using the <code>-c CONTAINER_NAME</code> flag.</p><p>Adapt the following command to your <code>mysql</code> Pod name with the command <code>bash</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl exec -it POD_NAME -- COMMAND ARGS
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>-it</code> - <code>i</code> stands for interactive (attach stdin and stdout, stderr from the <code>kubectl</code>). <code>t</code> will cause a TTY to be attached, a TTY is needed for applications like <code>vim</code>, <code>emacs</code> and so on.</li><li><code>POD_NAME</code> - Name of the Pod to exec into.</li><li><code>COMMAND</code> - Command to execute inside the Pod&rsquo;s container.</li><li><code>ARGS</code> - Optional. Arguments passed to the <code>COMMAND</code> given.</li></ul><p>The result can look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it mysql-5fc68fb84c-bssg4 -- bash
</span></span><span style=display:flex><span><span style=color:#44475a>root@mysql-5fc68fb84c-bssg4:/#
</span></span></span></code></pre></div><p>This has now opened an interactive <code>bash</code> shell inside the MySQL Pod.</p><p>Let&rsquo;s use <code>mysql</code> command to connect to the database server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>root@mysql-5fc68fb84c-bssg4:/# mysql -u root -p$MYSQL_ROOT_PASSWORD
</span></span></span><span style=display:flex><span><span style=color:#44475a>Warning: Using a password on the command line interface can be insecure.
</span></span></span><span style=display:flex><span><span style=color:#44475a>Welcome to the MySQL monitor.  Commands end with ; or \g.
</span></span></span><span style=display:flex><span><span style=color:#44475a>Your MySQL connection id is 1
</span></span></span><span style=display:flex><span><span style=color:#44475a>Server version: 5.6.44 MySQL Community Server (GPL)
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Oracle is a registered trademark of Oracle Corporation and/or its
</span></span></span><span style=display:flex><span><span style=color:#44475a>affiliates. Other names may be trademarks of their respective
</span></span></span><span style=display:flex><span><span style=color:#44475a>owners.
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>mysql&gt; SHOW DATABASES;
</span></span></span><span style=display:flex><span><span style=color:#44475a>+--------------------+
</span></span></span><span style=display:flex><span><span style=color:#44475a>| Database           |
</span></span></span><span style=display:flex><span><span style=color:#44475a>+--------------------+
</span></span></span><span style=display:flex><span><span style=color:#44475a>| information_schema |
</span></span></span><span style=display:flex><span><span style=color:#44475a>| mysql              |
</span></span></span><span style=display:flex><span><span style=color:#44475a>| performance_schema |
</span></span></span><span style=display:flex><span><span style=color:#44475a>+--------------------+
</span></span></span><span style=display:flex><span><span style=color:#44475a>3 rows in set (0.00 sec)
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>mysql&gt; quit
</span></span></span><span style=display:flex><span><span style=color:#44475a>Bye
</span></span></span><span style=display:flex><span><span style=color:#44475a>root@mysql-5fc68fb84c-bssg4:/# exit
</span></span></span></code></pre></div><p>Awesome! Our MySQL server Pod is running as should.</p><p>We took the &ldquo;extra&rdquo; steps to attach storage to the MySQL Deployment so let&rsquo;s test what happens if the MySQL Pod is deleted.</p><h5 id=test-resilience-of-mysql-server-deployment>Test resilience of MySQL server Deployment</h5><p>Go ahead and delete the MySQL Pod in the <code>default</code> Namespace (no need to use <code>--namespace</code> flag though as it is the default).</p><p>To get the current Pods, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get pod
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                     READY   STATUS      RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>hello-world              0/1     Completed   0          26h
</span></span></span><span style=display:flex><span><span style=color:#44475a>mysql-5fc68fb84c-bssg4   1/1     Running     0          11m
</span></span></span></code></pre></div><p>Pod with name <code>mysql-5fc68fb84c-bssg4</code> is our target, so run <code>kubectl delete pod mysql-5fc68fb84c-bssg4</code>.</p><p>Checking the current Pods now, we should see a new Pod running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get pod
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                     READY   STATUS      RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>hello-world              0/1     Completed   0          26h
</span></span></span><span style=display:flex><span><span style=color:#44475a>mysql-5fc68fb84c-crm86   0/1     Running     0          16s
</span></span></span></code></pre></div><p>This will mean for our WordPress which we are going to create in the next section, that if the MySQL Pod is down / deleted, a new one will spawn up with the same data so that WordPress can continue working.</p><h4 id=what-do-we-have-now>What do we have now?</h4><p>We now have a <code>Deployment</code> which keep one Pod of MySQL running running. The <code>Deployment</code> has the configuration in it for the MySQL Pod it is spawning.
But we have not specified a store for the MySQL data yet, we will do that as the next step.</p><p>Besides the <code>Deployment</code> we have a <code>Service</code>, which makes the MySQL reachable under a &ldquo;static&rdquo; cluster-internal IP address and DNS name for the <code>Service</code>.
Meaning the WordPress can easily access the MySQL database server through the DNS name of the <code>Service</code>.</p><p>So let&rsquo;s get right onto it and run WordPress.</p><h4 id=running-wordpress>Running WordPress</h4><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes202><code>kubernetes202</code></a> - <code>wordpress.yaml</code></p></blockquote><p><code>wordpress</code> Deployment, Service and PersistentVolumeClaim YAML:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>      - <span style=color:#ff79c6>image</span>: wordpress:5.1.1-php7.1-apache
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>name</span>: wordpress
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>name</span>: WORDPRESS_DB_HOST
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>value</span>: mysql
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>name</span>: WORDPRESS_DB_PASSWORD
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>value</span>: changeme
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>          <span style=color:#ff79c6>name</span>: wordpress
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: http
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>protocol</span>: TCP
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>type</span>: NodePort
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: PersistentVolumeClaim
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/name</span>: wordpress
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app.kubernetes.io/part-of</span>: wordpress
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: wordpress
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>storageClassName</span>: rook-ceph-block
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>accessModes</span>:
</span></span><span style=display:flex><span>  - ReadWriteOnce
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>storage</span>: 5Gi
</span></span></code></pre></div><p>Go to the task directory and run <code>kubectl create -f wordpress.yaml</code>.
This will create the objects defined in the YAML.</p><p>Check on the newly created <code>wordpress</code> objects using <code>kubectl get</code> with a label selector:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get deployment,svc,persistentvolumeclaim,pod -l app.kubernetes.io/name<span style=color:#ff79c6>=</span>wordpress
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                              READY   UP-TO-DATE   AVAILABLE   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>deployment.extensions/wordpress   1/1     1            1           44s
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>service/wordpress   NodePort   100.76.188.95   &lt;none&gt;        80:30142/TCP   44s
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS               AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>persistentvolumeclaim/wordpress   Bound    pvc-8059dc54-6f77-11e9-a067-9600001d3fa9   5Gi        RWO            rook-ceph-block-repl-3-1   44s
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                             READY   STATUS    RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#44475a>pod/wordpress-56bdcbcb5b-jhpjw   1/1     Running   0          44s
</span></span></span></code></pre></div><p>The <code>STATUS</code> column for the <code>pod/wordpress-...</code> should be <code>Running</code>, if not please let me know and you can try to look into yourself using the <code>kubectl describe KIND OBJECT_NAME</code> which will be explained in the next section.</p><h5 id=having-issues-kubectl-describe-is-here-for-you>Having issues? <code>kubectl describe</code> is here for you</h5><p><code>kubectl describe</code> is a way to &ldquo;describe&rdquo; Pods in a human readable form. In this &ldquo;description&rdquo; the <code>Events</code> for Pods are shown. These <code>Events</code> can help you track down what the issue is with, e.g., a Pod not starting up.</p><p>Run <code>kubectl describe</code> on the Pod above and checkout the output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span>$ kubectl describe pod wordpress-56bdcbcb5b-jhpjw
</span></span><span style=display:flex><span><span style=color:#ff79c6>Name</span>:               wordpress-56bdcbcb5b-jhpjw
</span></span><span style=display:flex><span><span style=color:#ff79c6>Namespace</span>:          default
</span></span><span style=display:flex><span><span style=color:#ff79c6>Priority</span>:           <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>PriorityClassName</span>:  &lt;none&gt;
</span></span><span style=display:flex><span><span style=color:#ff79c6>Node</span>:               k8s02-node-9one1voqljz-htz-deu-fsn1dc1.clster.systems/94.130.51.245
</span></span><span style=display:flex><span><span style=color:#ff79c6>Start Time</span>:         Sun, 05 May 2019 22:51:05 +0200
</span></span><span style=display:flex><span><span style=color:#ff79c6>Labels</span>:             app.kubernetes.io/name=wordpress
</span></span><span style=display:flex><span>                    app.kubernetes.io/part-of=wordpress
</span></span><span style=display:flex><span>                    pod-template-hash=56bdcbcb5b
</span></span><span style=display:flex><span><span style=color:#ff79c6>Annotations:        cni.projectcalico.org/podIP</span>: <span style=color:#bd93f9>100.67.207.68</span>/32
</span></span><span style=display:flex><span><span style=color:#ff79c6>Status</span>:             Running
</span></span><span style=display:flex><span><span style=color:#ff79c6>IP</span>:                 <span style=color:#bd93f9>100.67.207.68</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>Controlled By</span>:      ReplicaSet/wordpress-56bdcbcb5b
</span></span><span style=display:flex><span><span style=color:#ff79c6>Containers</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>wordpress</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Container ID</span>:   containerd://301ffa076b4151276e97e2c9df9f9e3788aa1cb6bfead00b70f84d04d78b4595
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Image</span>:          wordpress:5.1.1-php7.1-apache
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Image ID</span>:       docker.io/library/wordpress@sha256:ec14baae52d61e409ea4c2ccaf63401a660266977b0b6ec2dc81396f55f27f57
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Port</span>:           <span style=color:#bd93f9>80</span>/TCP
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Host Port</span>:      <span style=color:#bd93f9>0</span>/TCP
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>State</span>:          Running
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>Started</span>:      Sun, 05 May 2019 22:51:07 +0200
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Ready</span>:          <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Restart Count</span>:  <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>WORDPRESS_DB_HOST</span>:      mysql
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>WORDPRESS_DB_PASSWORD</span>:  changeme
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Mounts</span>:
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-lb5tz (ro)
</span></span><span style=display:flex><span><span style=color:#ff79c6>Conditions</span>:
</span></span><span style=display:flex><span>  Type              Status
</span></span><span style=display:flex><span>  Initialized       True
</span></span><span style=display:flex><span>  Ready             True
</span></span><span style=display:flex><span>  ContainersReady   True
</span></span><span style=display:flex><span>  PodScheduled      True
</span></span><span style=display:flex><span><span style=color:#ff79c6>Volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>default-token-lb5tz</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Type</span>:        Secret (a volume populated by a Secret)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>SecretName</span>:  default-token-lb5tz
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>Optional</span>:    <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>QoS Class</span>:       BestEffort
</span></span><span style=display:flex><span><span style=color:#ff79c6>Node-Selectors</span>:  &lt;none&gt;
</span></span><span style=display:flex><span><span style=color:#ff79c6>Tolerations</span>:     node.kubernetes.io/not-ready:NoExecute for 300s
</span></span><span style=display:flex><span>                 node.kubernetes.io/unreachable:NoExecute for 300s
</span></span><span style=display:flex;background-color:#3d3f4a><span><span style=color:#ff79c6>Events</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Type    Reason     Age    From                                                            Message
</span></span><span style=display:flex;background-color:#3d3f4a><span>  ----    ------     ----   ----                                                            -------
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Normal  Scheduled  4m16s  default-scheduler                                               Successfully assigned default/wordpress-56bdcbcb5b-jhpjw to k8s02-node-9one1voqljz-htz-deu-fsn1dc1.clster.systems
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Normal  Pulled     4m15s  kubelet, k8s02-node-9one1voqljz-htz-deu-fsn1dc1.clster.systems  Container image &#34;wordpress:5.1.1-php7.1-apache&#34; already present on machine
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Normal  Created    4m15s  kubelet, k8s02-node-9one1voqljz-htz-deu-fsn1dc1.clster.systems  Created container wordpress
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Normal  Started    4m14s  kubelet, k8s02-node-9one1voqljz-htz-deu-fsn1dc1.clster.systems  Started container wordpress
</span></span></code></pre></div><p>Instead of having to look through the massive YAML output of running <code>kubectl get TYPE OBJECT_NAME -o yaml</code>, <code>kubectl describe</code> outputs most information that is needed to look into an issue.</p><p>Be sure to use it if you should have issues and / or encounter weird behavior (e.g., no Pods starting for a Deployment (<code>kubectl describe deployment OBJECT_NAME</code>), etc).</p><hr><h2 id=get-creative-with-your-kubernetes-cluster>Get creative with your Kubernetes cluster!</h2><p>To further deepen the new knowledge we have made, let&rsquo;s deploy an PHP Guestbook application that uses Redis.</p><p>For that please follow the instructions here: <a href=https://kubernetes.io/docs/tutorials/stateless-application/guestbook/>Example: Deploying PHP Guestbook application with Redis - Kubernetes documentation</a>.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=kubernetes-guestbook-agenda.png itemprop=contentUrl><img itemprop=thumbnail src=kubernetes-guestbook-agenda.png width=750px></a><figcaption><h4>Kubernetes Guestbook Tutorial Content</h4></figcaption></figure><p>If you have questions and / or issues with the instructions or questions about Kubernetes, please let me know / ask them now.</p><h3 id=already-done-with-the-php-guestbook-application-on-kubernetes>Already done with the PHP Guestbook application on Kubernetes?</h3><p>You can look into the <a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/>Kubernetes - Learn Kubernetes Basics</a> page and go through the <code>^.+ Your App</code> tutorials linked in the sidebar, for more tasks to deepen your knowledge, or take a break for a few minutes to relax your brain.</p><h3 id=summary>Summary</h3><p>You have successfully learned about the basic objects and commands to deploy an application onto of Kubernetes as a container.</p><p>We will now move on the deploying your own Kubernetes cluster in the next section (and after the break).</p><hr><h2 id=deploy-your-own-kubernetes-cluster>Deploy your own Kubernetes cluster</h2><p><em>Follow these simple steps to get a Kubernetes cluster up and running fast.</em></p><p>The recipe for a Kubernetes cluster is as follows:</p><ul><li>500g flour</li><li>75g sugar</li><li>1 pinch of salt</li><li>200ml of lukewarm milk</li><li>100g soft butter</li><li>2 eggs</li></ul><p>Just kidding, we are not beginning to bake a cake now or are we?</p><p>You will need to have at least one server which will be used for the <code>master</code> components.</p><h3 id=what-is-kubeadm>What is <code>kubeadm</code>?</h3><p><code>kubeadm</code> is the official Tool to configure a <code>kubelet</code>, which is the node component of Kubernetes, to run in master or node &ldquo;mode&rdquo; in the end.
There are other tools / ways to deploy Kubernetes, which awill be listed in the upcoming sub section.
Reason why <code>kubeadm</code> is used here is simply because it is an official tool which is &ldquo;guaranteed&rdquo; to work with the Kubernetes version released (they follow the same release cycle).</p><h4 id=alternatives--additions-to-kubeadm>&ldquo;Alternatives&rdquo; / Additions to <code>kubeadm</code></h4><ul><li><a href=https://kubespray.io/>Kubespray</a> - Ansible deployment for Kubernetes.</li><li><a href=https://kublr.com/>kublr</a> - &ldquo;Reliable, Secure Container Management - Designed for modern enterprise&rdquo;.</li><li><a href=https://github.com/kelseyhightower/kubernetes-the-hard-way>Kelsey Hightower&rsquo;s Kubernetes The Hard Way</a> - If you want to learn &ldquo;everything&rdquo; about Kubernetes, follow the guide and it will lead you down the rabbit hole of Kubernetes.</li><li>One of the many Cloud Kubernetes solutions:<ul><li>Google Kubernetes Engine (GKE)</li><li>Azure Kubernetes Service (AKS)</li><li>Amazon Managed Kubernetes Service (EKS)</li></ul></li></ul><p>Many factors play into what is the right way for you to run / install / buy Kubernetes, this Kubernetes documentation page can help you with a list of &ldquo;all&rdquo; available solutions: <a href=https://kubernetes.io/docs/setup/pick-right-solution/>Picking the right solution - Kubernetes documentation</a>.</p><h3 id=what-are-kubeadms-prerequisites>What are <code>kubeadm</code>&rsquo;s prerequisites?</h3><p>Hard- / Software-Requirements are as follows:</p><ul><li>Servers must have at least 2 CPU (cores / threads) and at least 2GB of RAM.</li><li>OS: Linux or Windows<ul><li>Linux: Recommended to have Kernel 4.x or better.</li><li>Windows: Support was just added with Kubernetes v1.14.</li></ul></li><li>Container runtime:<ul><li><a href=https://www.docker.com/>Docker</a></li><li>A <strong>C</strong>ontainer<strong>R</strong>untime<strong>I</strong>nterface (CRI) compatible container runtime<ul><li>E.g., <a href=https://containerd.io>containerd</a>, <a href=https://github.com/kubernetes-sigs/cri-o>CRI-O</a>,</li></ul></li></ul></li></ul><h3 id=steps-to-your-own-kubernetes-cluster>Steps to your own Kubernetes cluster</h3><h4 id=stop-architecture-time>Stop, Architecture time!</h4><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=kubernetes-cluster-architecture.png itemprop=contentUrl><img itemprop=thumbnail src=kubernetes-cluster-architecture.png width=1200px></a><figcaption><h4>Kubernetes Cluster architecture</h4></figcaption></figure><p>More detailed information on each component with some insights, will be given later.</p><h5 id=network-architecture>Network Architecture</h5><p>A Kubernetes cluster always requires at least two IP ranges:</p><ul><li>Service / Cluster IP address range - IP address range to select IPs for Services from.</li><li>Pod IP range - IP address range to select an IP for each non-<code>hostNetwork</code> Pod in the Kubernetes cluster.<ul><li>This can be &ldquo;optional&rdquo; depending on, e.g., the CNI plugin you are using and other factors.</li></ul></li></ul><h4 id=kubeadm-installation><code>kubeadm</code> Installation</h4><p>The instructions for the <code>kubeadm</code> and <code>kubelet</code> installation have been taken from the Kubernetes documentation, see <a href=https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl>Installing kubeadm - Kubernetes documentation</a>.</p><blockquote><p><strong>NOTE</strong></p><p>An important point to mention is that <code>kubeadm</code> is only doing the configuration of the <code>kubelet</code>, which will then take care of spawning the components needed.
This means that we need to care to install the correct version of both <code>kubeadm</code> and <code>kubelet</code> packages.</p></blockquote><p>To be able to install the packages we need to add the Kubernetes repository for RHEL-based systems:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#44475a>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#44475a>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style=display:flex><span><span style=color:#44475a>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#44475a>gpgcheck=1
</span></span></span><span style=display:flex><span><span style=color:#44475a>repo_gpgcheck=1
</span></span></span><span style=display:flex><span><span style=color:#44475a>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#44475a>exclude=kube*
</span></span></span><span style=display:flex><span><span style=color:#44475a>EOF
</span></span></span></code></pre></div><p>Well.. SELinux everyone has it enabled, right guys? Right now it is recommended to disable SELinux.
At one point we can hope for good SELinux support for Kubernetes.</p><p>Let&rsquo;s go ahead and disable it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span># Set SELinux in permissive mode <span style=color:#ff79c6>(</span>effectively disabling it<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#44475a>setenforce 0
</span></span></span><span style=display:flex><span><span style=color:#44475a>sed -i &#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39; /etc/selinux/config
</span></span></span></code></pre></div><p>After that we can just go ahead and install the following packages and enable the <code>kubelet</code> service:</p><ul><li><code>kubelet</code> - The node component of Kubernetes, which takes care of talking with the container runtime to run containers.</li><li><code>kubeadm</code> - The &ldquo;configuration utility&rdquo; for the <code>kubelet</code>.</li><li><code>kubectl</code> - Kubernetes client utility, doesn&rsquo;t hurt if it is on every server, no matter if just a node. It is only &ldquo;needed&rdquo; on the master(s) because we will use the master VM to access the Kubernetes API through it.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
</span></span></span><span style=display:flex><span><span style=color:#44475a>systemctl enable --now kubelet
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># Set the <span style=color:#f1fa8c>&#34;new&#34;</span> K8S CNI plugins path <span style=color:#ff79c6>for</span> the kubelet <span style=color:#ff79c6>(</span>because Docker is used we can <span style=color:#ff79c6>do</span> it on the kubelet<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#44475a>sed -i &#39;s|KUBELET_EXTRA_ARGS=|KUBELET_EXTRA_ARGS=--cni-bin-dir=/opt/cni/bin,/usr/libexec/cni |&#39; /etc/sysconfig/kubelet
</span></span></span></code></pre></div><blockquote><p><strong>NOTE</strong></p><p>CNI plugin path fix: In case of other CRI compatile container runtimes, e.g., <a href=https://containerd.io>containerd</a>, <a href=https://github.com/kubernetes-sigs/cri-o>CRI-O</a>, this would need to be done in the container runtimes config file(s).</p></blockquote><p>After that we can go ahead and setup the initial master for the Kuberntes cluster using <code>kubeadm</code>.</p><h4 id=setting-up-the-initial-master-of-the-kubernetes-cluster>Setting up the initial master of the Kubernetes cluster</h4><blockquote><p><strong>NOTE</strong></p><p>Only run this on the first master server! The other master servers don&rsquo;t need to be <code>init</code>ialized, they need to be joined to the first Kubernetes master server.</p><p>For more information on high availability Kubernetes clusters, see <a href=https://kubernetes.io/docs/setup/independent/high-availability/>Creating Highly Available Clusters with kubeadm - Kubernetes</a>.</p></blockquote><p>To setup the initial master of the Kubernetes cluster, we will use the <code>kubeadm init</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubeadm init <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span><span style=color:#44475a>    --pod-network-cidr=100.64.0.0/13 \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    --service-cidr=100.72.0.0/13
</span></span></span><span style=display:flex><span><span style=color:#44475a>[init] Using Kubernetes version: v1.14.1
</span></span></span><span style=display:flex><span><span style=color:#44475a>[preflight] Running pre-flight checks
</span></span></span><span style=display:flex><span><span style=color:#44475a>	[WARNING IsDockerSystemdCheck]: detected &#34;cgroupfs&#34; as the Docker cgroup driver. The recommended driver is &#34;systemd&#34;. Please follow the guide at https://kubernetes.io/docs/setup/cri/
</span></span></span><span style=display:flex><span><span style=color:#44475a>[preflight] Pulling images required for setting up a Kubernetes cluster
</span></span></span><span style=display:flex><span><span style=color:#44475a>[preflight] This might take a minute or two, depending on the speed of your internet connection
</span></span></span><span style=display:flex><span><span style=color:#44475a>[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubelet-start] Writing kubelet environment file with flags to file &#34;/var/lib/kubelet/kubeadm-flags.env&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubelet-start] Writing kubelet configuration to file &#34;/var/lib/kubelet/config.yaml&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubelet-start] Activating the kubelet service
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Using certificateDir folder &#34;/etc/kubernetes/pki&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;ca&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;apiserver&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] apiserver serving cert is signed for DNS names [k8s-c1-master-1.eden.run kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [100.72.0.1 159.69.244.41]
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;apiserver-kubelet-client&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;front-proxy-ca&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;front-proxy-client&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;etcd/ca&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;etcd/server&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] etcd/server serving cert is signed for DNS names [k8s-c1-master-1.eden.run localhost] and IPs [159.69.244.41 127.0.0.1 ::1]
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;etcd/peer&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] etcd/peer serving cert is signed for DNS names [k8s-c1-master-1.eden.run localhost] and IPs [159.69.244.41 127.0.0.1 ::1]
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;etcd/healthcheck-client&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;apiserver-etcd-client&#34; certificate and key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[certs] Generating &#34;sa&#34; key and public key
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubeconfig] Using kubeconfig folder &#34;/etc/kubernetes&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubeconfig] Writing &#34;admin.conf&#34; kubeconfig file
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubeconfig] Writing &#34;kubelet.conf&#34; kubeconfig file
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubeconfig] Writing &#34;controller-manager.conf&#34; kubeconfig file
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubeconfig] Writing &#34;scheduler.conf&#34; kubeconfig file
</span></span></span><span style=display:flex><span><span style=color:#44475a>[control-plane] Using manifest folder &#34;/etc/kubernetes/manifests&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[control-plane] Creating static Pod manifest for &#34;kube-apiserver&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[control-plane] Creating static Pod manifest for &#34;kube-controller-manager&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[control-plane] Creating static Pod manifest for &#34;kube-scheduler&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[etcd] Creating static Pod manifest for local etcd in &#34;/etc/kubernetes/manifests&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &#34;/etc/kubernetes/manifests&#34;. This can take up to 4m0s
</span></span></span><span style=display:flex><span><span style=color:#44475a>[apiclient] All control plane components are healthy after 15.502780 seconds
</span></span></span><span style=display:flex><span><span style=color:#44475a>[upload-config] storing the configuration used in ConfigMap &#34;kubeadm-config&#34; in the &#34;kube-system&#34; Namespace
</span></span></span><span style=display:flex><span><span style=color:#44475a>[kubelet] Creating a ConfigMap &#34;kubelet-config-1.14&#34; in namespace kube-system with the configuration for the kubelets in the cluster
</span></span></span><span style=display:flex><span><span style=color:#44475a>[upload-certs] Skipping phase. Please see --experimental-upload-certs
</span></span></span><span style=display:flex><span><span style=color:#44475a>[mark-control-plane] Marking the node k8s-c1-master-1.eden.run as control-plane by adding the label &#34;node-role.kubernetes.io/master=&#39;&#39;&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[mark-control-plane] Marking the node k8s-c1-master-1.eden.run as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] Using token: mqn3hg.p8r8p7yyi7ozoqbx
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
</span></span></span><span style=display:flex><span><span style=color:#44475a>[bootstrap-token] creating the &#34;cluster-info&#34; ConfigMap in the &#34;kube-public&#34; namespace
</span></span></span><span style=display:flex><span><span style=color:#44475a>[addons] Applied essential addon: CoreDNS
</span></span></span><span style=display:flex><span><span style=color:#44475a>[addons] Applied essential addon: kube-proxy
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Your Kubernetes control-plane has initialized successfully!
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>To start using your cluster, you need to run the following as a regular user:
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>  mkdir -p $HOME/.kube
</span></span></span><span style=display:flex><span><span style=color:#44475a>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span></span><span style=display:flex><span><span style=color:#44475a>  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>You should now deploy a pod network to the cluster.
</span></span></span><span style=display:flex><span><span style=color:#44475a>Run &#34;kubectl apply -f [podnetwork].yaml&#34; with one of the options listed at:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>Then you can join any number of worker nodes by running the following on each as root:
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>kubeadm join 159.69.244.41:6443 --token mqn3hg.p8r8p7yyi7ozoqbx \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    --discovery-token-ca-cert-hash sha256:4000680d6a69786e1d69c3f7aef7fd03c533665e00f35886e0d2b33754d3c03c
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>kubeadm init</code> - Initialize a Kubernetes cluster first master.<ul><li><code>--pod-network-cidr=100.64.0.0/13</code> - Pod IP address range.</li><li><code>--service-cidr=100.72.0.0/13</code> - Service / Cluster IP address range.</li></ul></li><li>In the output:<ul><li><code>mkdir [...]</code> + <code>sudo cp</code> + <code>sudo chown</code> - These commands copy the <code>kubeconfig</code> which contains the access credentials to the cluster to the default location, so the <code>kubectl</code> can pick it up without any changes to it&rsquo;s configuration.</li><li><code>kubeadm join [...]</code> - The command which allows us to join other servers into the cluster.</li></ul></li></ul><p>This will pull the images needed by the <code>kubelet</code> as the so called &ldquo;pause image&rdquo;, besides in case of the master the images for the Kubernetes master components are also pulled, and generate configurations for those components.</p><p>After the <code>kubeadm init</code> command ran successfully make sure to copy the command beginning with <code>kubeadm join</code> to a safe location, it is needed later on.</p><p>The Kubernetes master components consist of:</p><ul><li><code>etcd</code> - It is either run as Pod inside the cluster as is done with the &ldquo;default&rdquo; cluster installation from <code>kubeadm</code>, but an &ldquo;cluster external&rdquo; etcd could also be used.</li><li><code>kube-apiserver</code> - The API server is the &ldquo;gateway&rdquo; to the etcd with the other components, like <code>kubelet</code>, <code>kube-controller-manager</code> and <code>kube-scheduler</code>.</li><li><code>kube-controller-manager</code> - Taking care of management aspects such as, for Services of type NodePort to select a free port in the configured range, make sure nodes are marked as <code>NotReady</code> when they have not updated themselves at the APi for sometime, and more control loops, making sure Deployments and other &ldquo;<code>replicas</code> object type&rdquo; are at their desired and if not try to bring them to the desired state, and many .</li><li><code>kube-scheduler</code> - Takes care of the scheduling of Pods in the Kubernetes cluster depending on various factors like total node resources requests. Also if supported by the storage driver the <code>kube-scheduler</code> will take location of the storage (PersistentVolumes) into account.</li></ul><p>For a more detailed view on what each Kubernetes component, see <a href=https://kubernetes.io/docs/concepts/overview/components/>Kubernetes Components - Kubernetes</a>.</p><p>Then we just need to configure the <code>kubectl</code> (only) on the master server to be able to talk with Kubernetes cluster we just created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>mkdir -p $HOME/.kube
</span></span></span><span style=display:flex><span><span style=color:#44475a>cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span></span><span style=display:flex><span><span style=color:#44475a>chown $(id -u):$(id -g) $HOME/.kube/config
</span></span></span></code></pre></div><p>Finally on the master server, run <code>kubectl get componentstatus</code> to get the current component status and <code>kubectl get nodes</code> to get the list of nodes of cluster which should only return the master server we are on right now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get componentstatus
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                 STATUS    MESSAGE             ERROR
</span></span></span><span style=display:flex><span><span style=color:#44475a>controller-manager   Healthy   ok
</span></span></span><span style=display:flex><span><span style=color:#44475a>scheduler            Healthy   ok
</span></span></span><span style=display:flex><span><span style=color:#44475a>etcd-0               Healthy   {&#34;health&#34;:&#34;true&#34;}
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>$ kubectl get nodes
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                       STATUS     ROLES    AGE     VERSION
</span></span></span><span style=display:flex><span><span style=color:#44475a>k8s-c1-master-1.eden.run   NotReady   master   2m33s   v1.14.1
</span></span></span></code></pre></div><p>It is okay for the node to be in <code>NotReady</code> status, because we currently have not deployed a network. This will be done in the next section.</p><h5 id=errors-during-kubeadm-execution>Errors during <code>kubeadm</code> execution</h5><blockquote><p><strong>WARNING</strong></p><p>This will remove all Kubernetes related data on the master and node that you are running the &ldquo;reset&rdquo; command on.</p></blockquote><p>If you should encounter issues with <code>kubeadm</code> failing during, e.g., <code>kubeadm join</code> or <code>kubeadm init</code>, you can do a reset of that node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubeadm reset -f
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># Clear iptables rules
</span></span><span style=display:flex><span><span style=color:#44475a>iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># Clear ipvs rules
</span></span><span style=display:flex><span><span style=color:#44475a>ipvsadm --clear
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>-f</code> - In this case stands for &ldquo;force&rdquo;, this will just &ldquo;reset&rdquo; the node and make it ready to be <code>kubeadm init</code>ed or <code>kubeadm join</code>ed again.</li></ul><h4 id=lets-add-some-network-to-the-cluster-first>Let&rsquo;s add some network to the cluster first</h4><p>Before we go ahead and join the two node servers we have &ldquo;join&rdquo; the Kubernetes cluster, let&rsquo;s install a network. The network install must be done on the master and only once.</p><p>In this case <a href=https://github.com/coreos/flannel>Flannel</a> will be used as the network provider, as it is the most basic one which should work no matter what.</p><blockquote><p><strong>NOTE</strong></p><p>The IP address range used for the Pods will be <code>100.64.0.0/13</code> which is part of <a href=https://en.wikipedia.org/wiki/IPv4#Special-use_addresses><code>100.64.0.0/10</code> space normally used for carrier-grade NAT</a>.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ curl -O <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span><span style=color:#44475a>    https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>$ sed -i -e <span style=color:#f1fa8c>&#34;s?10.244.0.0/16?100.64.0.0/13?g&#34;</span> kube-flannel.yml
</span></span><span style=display:flex><span>$ kubectl apply -f kube-flannel.yml
</span></span></code></pre></div><p>Running the following command will show you the Pods in the <code>kube-system</code> namespace and there you should hopefully already see at least one <code>kube-flannel-*</code> Pods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl get -n kube-system pod
</span></span></span></code></pre></div><h4 id=join-each-node-server-into-your-kubernetes-cluster>Join each node server into your Kubernetes cluster</h4><p>On the master server run the following command to print out the &ldquo;join&rdquo; command for the nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubeadm token create --print-join-command
</span></span><span style=display:flex><span><span style=color:#44475a>kubeadm join --token 447067.20b55955bd6abe6c 192.168.99.100:8443 --discovery-token-ca-cert-hash sha256:17023a5c90b996e50c514e63e161e46f78be216fd48c0c3df3be67e008b28889
</span></span></span></code></pre></div><p>Copy the command to the two nodes and run it on them.
After a few seconds / minutes the command should exit successfully and you should be able to see the two nodes in the nodes list on the master (<code>kubectl get nodes</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span><span style=color:#44475a>NAME                       STATUS     ROLES    AGE     VERSION
</span></span></span><span style=display:flex><span><span style=color:#44475a>k8s-c1-master-1.eden.run   Ready      master   5m33s   v1.14.1
</span></span></span><span style=display:flex><span><span style=color:#44475a>k8s-c1-worker-1.eden.run   Ready      &lt;none&gt;   46s     v1.14.1
</span></span></span><span style=display:flex><span><span style=color:#44475a>k8s-c1-worker-2.eden.run   Ready      &lt;none&gt;   10s     v1.14.1
</span></span></span></code></pre></div><h4 id=test-the-kubernetes-cluster-health>Test the Kubernetes cluster health</h4><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes404><code>kubernetes404</code></a></p></blockquote><p>In the task <code>kubernetes404</code> directory is a file called <code>busybox.yaml</code>. We will now deploy this file onto our cluster.
The file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#44475a>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#44475a>metadata:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  name: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>spec:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  containers:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  - image: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>    command:
</span></span></span><span style=display:flex><span><span style=color:#44475a>      - sleep
</span></span></span><span style=display:flex><span><span style=color:#44475a>      - &#34;3600&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>    imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#44475a>    name: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>  restartPolicy: Always
</span></span></span></code></pre></div><p>Connect to the Kubernetes master server and in the task directory <code>kubernetes101</code> run the following command to create the <code>busybox</code> Pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl create -f busybox.yaml
</span></span></span></code></pre></div><p>The syntax of the <code>busybox</code> Pod object manifest, is a bit similar to the syntax of <code>docker-compose</code> files. It should get clear when you look at some other examples.</p><p>Run <code>kubectl get pod busybox</code> to see the status of the <code>busybox</code> Pod we created through the <code>kubectl create</code> command. The <code>busybox</code> Pod should be in <code>Running</code> state if it is not use <code>kubectl describe pod busybox</code> to show some general information and the events of the Pod. The events can help you find out what the issue is.</p><p>After that run the following command to make sure Pods can reach the Kubernetes API which should mean that the container network works fine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ kubectl <span style=color:#8be9fd;font-style:italic>exec</span> busybox -- wget https://kubernetes.default.svc.cluster.local:443
</span></span><span style=display:flex><span><span style=color:#44475a>Connecting to kubernetes.default.svc.cluster.local:443 (100.72.0.1:443)
</span></span></span><span style=display:flex><span><span style=color:#44475a>wget: note: TLS certificate validation not implemented
</span></span></span><span style=display:flex><span><span style=color:#44475a>wget: server returned error: HTTP/1.1 403 Forbidden
</span></span></span><span style=display:flex><span><span style=color:#44475a>command terminated with exit code 1
</span></span></span></code></pre></div><p>If you get the error that is shown above (<code>403</code> return status), the cluster should be okay now and I can welcome you to the Kubernetes Danger Zone!
If you should get a different output, something probably went wrong please contact me.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=welcome-to-the-danger-zone.png itemprop=contentUrl><img itemprop=thumbnail src=welcome-to-the-danger-zone.png width=450px></a><figcaption><h4>Welcome to the Danger Zone! - Taken from MemeGenerator.net</h4></figcaption></figure><h3 id=lets-extend-the-kubernetes-cluster-with-cool-features>Let&rsquo;s extend the Kubernetes cluster with cool features!</h3><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes303><code>kubernetes303</code></a></p></blockquote><p>The task <code>kubernetes303</code> directory contains some additional manifests to add some features like, an Ingress cntroller, a PersistentVolume provider using Rook Ceph operator for storage and Prometheus Monitoring for the cluster.</p><blockquote><p><strong>NOTE</strong></p><p>In this as there are many different objects most depending in some on the other, for simplicity are just going to &ldquo;brute force the system&rdquo;.
Ignore any &ldquo;already exists&rdquo; errors as they are okay.</p></blockquote><p>Please enter the task directory and follow the &ldquo;Create / Apply Order&rdquo; in the <code>README.md</code> there.</p><p>The command to create the objects is</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl create -R -f DIRECTORY
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>-R</code> - Means recursive. Making the <code>kubectl create</code> recurse through every sub directory in the <code>kubernetes303/</code> in this case.</li><li><code>DIRECTORY</code> - Is the current directory you want to create all objects from (<strong>Respect the &ldquo;Create / Apply Order&rdquo;!</strong>).</li></ul><hr><h2 id=network-stuff-because-network-in-kubernetes-is-special>Network stuff. Because network in Kubernetes is &ldquo;special&rdquo;.</h2><p>Let&rsquo;s talk network!</p><blockquote><p><strong>NOTE</strong></p><p>Do you want to look at complex network diagrams about Kubernetes? Checkout <a href=https://docs.edenmal.moe/kubernetes/networking/explained/>Kubernetes Network Explained - Edenmal Docs</a>.</p></blockquote><h3 id=requirements>Requirements</h3><ul><li>At least two un-routed IP ranges.<ol><li>IP range should have at least of CIDR size: <code>NUMBER_OF_NODES * IPV4 /24</code>. It will be used for the Pods IPs by the SDN / Kubernetes.</li><li>IP range is used for Kubernetes <code>Service ClusterIPs</code>.</li></ol></li><li>You should have at least 1G connection between the servers.<ul><li>If you have internet facing service, make sure that it is enough in general network capacity.<ul><li>=> Talk with your network team!</li></ul></li></ul></li><li>Load Balancer is recommended for production for the Kubernetes API (more details on the architecture follow soon).</li></ul><h3 id=sdn-and-cni>SDN and CNI?</h3><p>Equals
<span class="icofont-heart icofont-2x" alt="Icon heart"></span>
for dynamic network for containers!</p><h4 id=glossar>Glossar</h4><ul><li>SDN stands for Software Defined Network</li><li>CNI = <a href=https://github.com/containernetworking/cni>Container Network Interface</a></li></ul><h4 id=what-do-they-do>What do they do?</h4><p>The <a href=https://github.com/containernetworking/cni>Container Network Interface</a> in itself is a unified interface for any system to request &ldquo;network&rdquo;, e.g, an IP address.</p><p>There are many different CNI plugins available, here is a list of some:</p><ul><li><a href=https://github.com/coreos/flannel>CoreOS Flannel</a>: VXLAN Mesh network between the servers. The simplest network plugin that can span over more than one node.</li><li><a href=https://www.projectcalico.org/>Project Calico</a>: Either BGP + IP-IP or in form of <a href=https://docs.projectcalico.org/latest/getting-started/kubernetes/installation/flannel>Canal</a> using Flannel for the traffic between the nodes.</li><li>And many more <a href=https://kubernetes.io/docs/concepts/cluster-administration/networking/>Kubernetes - Cluster Networking</a> &mldr;</li></ul><h3 id=kube-proxy---takes-care-of-service-clusterips><code>kube-proxy</code> - Takes care of Service ClusterIPs</h3><p>The <code>kube-proxy</code> component must be run on every node as it takes care of making the ClusterIPs of the Services &ldquo;available&rdquo;.</p><p>The <code>kube-proxy</code> does this through either <code>iptables</code> or <code>ipvs</code> (which uses only a small amount of <code>iptables</code> rules), the default for new cluster is <code>ipvs</code>.
Reason for <code>ipvs</code> being the default is because it is performance-wise better than having &ldquo;a billion&rdquo; iptables rules on each node doing &ldquo;routing&rdquo; / filtering.</p><p>Why not connect to a Node and run <code>iptables-save</code> and <code>ipvsadm -ln</code> to check on what is going on.</p><blockquote><p><strong>TL;DR</strong> The <code>iptables</code> and / or IPVS &ldquo;rules&rdquo; take care of forwarding the traffic where it needs to be for ClusterIPs.</p></blockquote><h3 id=ipv6>IPv6</h3><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=i-think-we-have-a-problem-cheezeburger.png itemprop=contentUrl><img itemprop=thumbnail src=i-think-we-have-a-problem-cheezeburger.png width=300px></a><figcaption><h4>'State of IPv6 and containers' - Image taken from Cheezburger.com</h4></figcaption></figure><p>Oh boi, right now if you want dual stack network for your Pods you are in for a challenge. Dual stack is not really supported right now. It is either IPv4 or IPv6 in your cluster.</p><p>This is sadly due to bigger clouds not having IPv6 (by default) enabled and most companies not batting an eye.</p><p>A huge problem for users having DSL-Light, where you share one IPv4 address with many and often don&rsquo;t have enough bandwidth over IPv4, though IPv6 is working fine you have most of the bandwidth all the time without any issues (+ port fowarding is active at most ISPs).</p><hr><h2 id=deploying-an-application-to-kubernetes>Deploying an application to Kubernetes</h2><p>The <code>kubectl</code> utility allows us to create objects, in this section I&rsquo;m going to cover how you can create Manifest files for Kubernetes objects.</p><h3 id=busybox-pod-example>BusyBox Pod Example</h3><blockquote><p><strong>TASK</strong>: <a href=https://github.com/galexrt/workshop-container-docker-kubernetes/tree/master/kubernetes303><code>kubernetes303</code></a></p></blockquote><blockquote><p><strong>NOTE</strong></p><p>The snippet below is from the file <code>busybox.yaml</code> in the <code>kubernetes303</code> task.</p></blockquote><p>You have already seen this example, but here again with more explanations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#44475a>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#44475a>metadata:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  name: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#44475a>spec:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  containers:
</span></span></span><span style=display:flex><span><span style=color:#44475a>  - image: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>    command:
</span></span></span><span style=display:flex><span><span style=color:#44475a>      - sleep
</span></span></span><span style=display:flex><span><span style=color:#44475a>      - &#34;3600&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>    imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#44475a>    name: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>  restartPolicy: Always
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>apiVersion: v1</code> - Sets the API version to use.</li><li><code>kind: Pod</code> - Sets the type / kind of the &ldquo;obejct&rdquo;.</li><li><code>metadata: []</code> - A list of metadata information, like what name or namespace to use.</li><li><code>spec: []</code> - A list of &ldquo;specifications&rdquo;. In this case containing a list of containers.</li><li><code>containers:</code> - List of containers, see next snippet for more information.</li><li><code>restartPolicy: Always</code> - Restart policy. In this case the Pod always restarts, until deleted.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>- image: busybox
</span></span></span><span style=display:flex><span><span style=color:#44475a>  command:
</span></span></span><span style=display:flex><span><span style=color:#44475a>    - sleep
</span></span></span><span style=display:flex><span><span style=color:#44475a>    - &#34;3600&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>  imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#44475a>  name: busybox
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p></blockquote><ul><li><code>- image: busybox</code> - Use the busybox image. The <code>-</code> (minus) begins the list entry.</li><li><code>command: []</code> - The command to run in the container (not the entrypoint).</li><li><code>imagePullPolicy: IfNotPresent</code> - The image pull policy.</li><li><code>name: busybox</code> - The name of the container of the Pod.</li></ul><p>Most things are seem similar but different to <code>docker-compose.yml</code>s, but if you know the basic syntax differences you should be good to go.</p><hr><h2 id=kubessar---a-glossar-but-for-kubernetes>Kubessar - A Glossar but for Kubernetes</h2><blockquote><p><em>Like a glossar, but for Kubernetes stuff. So a Kubessar?</em></p></blockquote><h3 id=labels>Labels</h3><p>Labels are a way to.. well.. label objects, you can use these labels to &ldquo;group&rdquo; objects together and select them all together then.
For example a label selector looks like this: <code>app.kubernetes.io/name=my-application</code> or for multiple labels: <code>app.kubernetes.io/name=my-application,app.kubernetes.io/version=1.2.3</code>.</p><p>Kubernetes has a list of recommended label (names): <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/>https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/</a>.</p><h3 id=annotations>Annotations</h3><p>Annotations are kind of like labels just from the concept of key-value pairs, but you can&rsquo;t filter on annotations.
Annotations are meant to hold information of, e.g., an application <code>Deployment</code>, which is there is no need to select the objects on.</p><h3 id=namespace>Namespace</h3><p>Separation of resources. Allowing for quotas per namespace.
When not specifying a namespace in the <code>kubectl</code> command, if set the namespace configured in the kubeconfig (<code>$HOME/.kube/config</code>) else <code>default</code> namespace will be used.</p><h3 id=pod-po>Pod (<code>po</code>)</h3><p>A Pod is a logical construct of one or more containers that will run together and share the same context.
The one or more containers of a Pod share the same network context, meaning they have the same interface (= IP address).</p><h3 id=deployment-deployment>Deployment (<code>deployment</code>)</h3><p>A <code>Deployment</code> is a way to deploy your application and always keep a specific number of <code>replicas</code> of the application running.
In addition to that when the <code>Deployment</code> object is edited there will be a history retained, the sub section <a href=#replicaset-rs>ReplicaSet</a> will give more insight into this.</p><h4 id=replicaset-rs>ReplicaSet (<code>rs</code>)</h4><p>When a Deployment is created or updated a ReplicaSet is created per creation / change to the Deployment.
The ReplicaSet is an imprint of the current state of the Deployment. This is the history part of the Deployment.</p><h3 id=service-svc>Service (<code>svc</code>)</h3><p>Exposed one or more Ports of Pods which are selected by a label selector. The access to the port(s) is &ldquo;load balanced&rdquo; using <code>iptables</code> or <code>ipvs</code> depending on how the cluster has been setup. In the upcoming cluster installation, the component which &ldquo;configures&rdquo; these Service IPs on each node will use <code>ipvs</code>.</p><p>When you create a Service, a <code>A</code> and <code>SRV</code> DNS record is created so that you can access the server through a &ldquo;static&rdquo; DNS name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>wordpress.default.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#44475a>NAME.NAMESPACE.svc.cluster.local
</span></span></span></code></pre></div><p>(where cluster.local is the default cluster DNS suffix)</p><p>In addition to that there are three types of Service available:</p><h4 id=clusterip-1>ClusterIP</h4><p>An IP address, which is the so called Service IP range, which is only reachable on the port(s) exposed by the service. This means that an ICMP ping won&rsquo;t work.</p><h4 id=nodeport-1>NodePort</h4><p>A NodePort Service is based on the ClusterIP Service type.
The addition is that as the name may imply a port is opened on every node of the cluster (by default) which is in the so called node port range (<code>30000-32767</code>).</p><h4 id=loadbalancer-1>LoadBalancer</h4><p>A LoadBalancer in a nutshell is a NodePort service which triggers the creation and automatic configuration of a LoadBalancer in the environment (e.g., in a Kubernetes as a Service cloud, Kubernetes in OpenStack).</p><h3 id=other-objects>Other Objects</h3><ul><li>StatefulSet - Deployment like object but with a &ldquo;twist&rdquo; in regard to persistence (PersistentVolumeClaims).</li><li>PersistentVolumeClaims and PersistentVolumes - Claims are for requesting storage and the PersistentVolumes are the &ldquo;mapping&rdquo; part for Kubernetes and storage system / software (<code>storage system / software &lt;-> Kubernetes</code>).</li><li>ResourceQuota - Resource quotas for a namespace in regards to compute resources but also actual objects.</li><li>Nodes - Information about nodes in the cluster.</li></ul><h3 id=object-manifest-files>Object Manifest files</h3><p>Manifest files can be either in a YAML and / or JSON format which Kubernetes is able to understand and interpret accordingly. These files are descriptors / specifications for Kubernetes objects and can be created, edited, updated and deleted on a Kubernetes cluster using the <code>kubectl</code> Kubernetes client tool.</p><hr><h2 id=kubectl---our-tool-to-catch-deploy-them-all><code>kubectl</code> - Our tool to <del>catch</del> deploy them all</h2><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=kubernetes-its-dangerous-to-go-alone.png itemprop=contentUrl><img itemprop=thumbnail src=kubernetes-its-dangerous-to-go-alone.png width=550px></a><figcaption><h4>Kubernetes - 'It's dangerous to go alone' *Zelda Meme intensifies*</h4></figcaption></figure><h3 id=the-basics-of-kubectl>The Basics of <code>kubectl</code></h3><p>The <code>kubectl</code> command is used to create new &ldquo;objects&rdquo;, view Pods, ReplicationController and all other available objects in Kubernetes.</p><h4 id=get--list-objects>Get / List objects</h4><p>To view all Pods in all namespaces of the Kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl get -n NAMESPACE pods
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>kubectl</code> - The kubectl command.</li><li><code>get</code> - Get &ldquo;objects&rdquo; from kubernetes API.</li><li><code>NAMESPACE</code> - Name of the namespace you want to get objects from.</li><li><code>--all-namespaces</code> - Show objects from all namespaces.</li><li><code>pods</code> - Show only Pods (Can be a comma seperated list of types, short forms are available).</li></ul></blockquote><h5 id=getting--listing-objects-using-label-selectors>Getting / Listing objects using label selectors</h5><p>Labels are an important of Kubernetes as they allow you to &ldquo;group&rdquo; your objects when selecting them.
Meaning for example if you have certain components that are for the backend, you could add a label to them <code>role = backend</code> and the frontend components with <code>role = frontend</code>.</p><p>Kubernetes has a list of rcommended labels to use for applications: <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/>https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/</a>.</p><p>You can basically specify &ldquo;anything&rdquo; as a label, so you are able to select your objects fine grained on your own accord.</p><h4 id=gather-information-about-one-or-more-objects>Gather information about one or more object(s)</h4><p>Get pretty formatted informations about one or more object(s):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl describe --namespace=NAMESPACE TYPE/NAME (TYPE/NAME ...)
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>describe</code> - Call the describe routines.</li><li><code>--namespace=NAMESPACE</code> - Set namespace to search in (optional when set through kubeconfig file).</li><li><code>TYPE</code> - The type of objects to show. For example <code>pod</code>, <code>deployment</code> (for Deployment).</li><li><code>NAME</code> - Name of the object to show. For our WordPress Pod, would be <code>wordpress</code>.</li></ul></blockquote><h4 id=create-one-or-more-objects-in-kubernetes>Create one or more object(s) in Kubernetes</h4><p>To create Kubernetes objects through a manifest file or through commands, the <code>create</code> subcommand is used:</p><h5 id=creating-objects-through-a-manifest-file>Creating objects through a manifest file</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    create \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -f FILE_NAME
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>create</code> - Subcommand.</li><li><code>-f FILE_NAME</code> - Can be one file, a directory or <code>-</code> for stdin. When a directory is specified, files are read in alphabetical order.</li></ul></blockquote><h5 id=create-eg-a-configmap-through-the-kubectl-create-subcommands>Create, e.g., a ConfigMap through the <code>kubectl create</code> subcommands</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    create \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    configmap OBJECT_NAME \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    --from-file=path/to/file \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    --from-literal=&#34;key=value&#34;
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>create</code> - Subcommand.</li><li><code>configmap</code> - Type of object to create.</li><li><code>OBJECT_NAME</code> - The name of the object.</li><li><code>--from-file=path/to/file</code> - Takes the file path and puts it in a key named after the file path.</li><li><code>--from-literal="key=value"</code> - Takes a key-value pair and puts it in the ConfigMap.</li></ul></blockquote><h4 id=delete-one-or-more-objects>Delete one or more object(s)</h4><p>To delete one or more object(s), there&rsquo;s the <code>delete</code> subcommand:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl delete -f FILE_NAME
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>delete</code> - Deletes specified object(s).</li><li><code>-f FILE_NAME</code> - Can be one file, a directory or <code>-</code> for stdin. When a directory is specified, files are read in alphabetical order.</li></ul></blockquote><p><strong>Or</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl delete TYPE/NAME (TYPE/NAME ...)
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>delete</code> - Deletes specified object(s).</li><li><code>TYPE</code> - The type of objects to show. For example <code>pod</code>, <code>deployment</code> (for Deployment).</li><li><code>NAME</code> - Name of the object to show. For our WordPress Pod, would be <code>wordpress</code>.</li></ul></blockquote><h4 id=execute-command-inside-a-pods-container>Execute command inside a Pod&rsquo;s container</h4><p>Using the <code>exec</code> subcommand, with almost the same syntax as <code>docker exec</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl exec OPTIONS POD_NAME (-c CONTAINER_NAME) COMMAND
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>exec</code> - Deletes specified object(s).</li><li><code>OPTIONS</code> - For example <code>-i</code> for interactive, see the help menu for more information.</li><li><code>POD_NAME</code> - Name of the object to show. For our WordPress Pod, would be <code>wordpress</code>.</li><li><code>-c CONTAINER_NAME</code> - Optional. If the specified Pod has more than one container, then it is required.</li><li><code>COMMAND</code> - The command to run inside the container.</li></ul></blockquote><p>If you are trying to exec into a Pod with multiple containers and have not selected a container using the <code>-c</code> flag, <code>kubectl exec</code> will &ldquo;complain&rdquo; about it and print a list of containers.</p><h4 id=view-the-logs-of-a-pods-container>View the logs of a Pod&rsquo;s container</h4><p>The <code>logs</code> subcommand, has almost the same syntax as <code>docker logs</code> with some Kubernetes Pod object related flags sprinkled in.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl logs OPTIONS POD_NAME (-c CONTAINER_NAME) COMMAND
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>exec</code> - Deletes specified object(s).</li><li><code>OPTIONS</code> - For example <code>-f</code> for follow the output, see the help menu for more information.</li><li><code>NAME</code> - Name of the object to show. For our WordPress Pod, would be <code>wordpress</code>.</li><li><code>-c CONTAINER_NAME</code> - Optional. If the specified Pod has more than one container, then it is required.</li></ul></blockquote><p>If you are trying to get the logs of a Pod with multiple containers and have not selected a container using the <code>-c</code> flag, <code>kubectl logs</code> will &ldquo;complain&rdquo; about it and print a list of containers.</p><h3 id=advanced-kubectl-usage>Advanced kubectl usage</h3><h4 id=editing-an-existing-deployment-object>Editing an existing Deployment object</h4><p>The <code>edit</code> subcommand allows you to edit an object which for, e.g., Deployment, StatefulSet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl edit TYPE OBJECT_NAME
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>edit</code> - Rolling update subcommand.</li><li><code>TYPE</code> - The type of object to edit.</li><li><code>OBJECT_NAME</code> - Name of object to be edited.</li></ul></blockquote><h4 id=scaling-a-deployment>Scaling a Deployment</h4><p>The <code>scale</code> subcommand allows you scale the replicas size of a given object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>kubectl scale TYPE OBJECT_NAME --replicas=SIZE
</span></span></span></code></pre></div><blockquote><p><strong>WDWD</strong></p><ul><li><code>scale</code> - Scale subcommand.</li><li><code>TYPE</code> - The type of object to edit.</li><li><code>OBJECT_NAME</code> - Name of object to be edited.</li><li><code>--replicas=SIZE</code> - Set the replicas for the object.</li></ul></blockquote><hr><h2 id=summary-of-the-day>Summary of the Day</h2><p>If you are reading this, you have made it to the end of day #2. Well done, sir or madam, have a second cookie!</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=here-is-a-cookie.png itemprop=contentUrl><img itemprop=thumbnail src=here-is-a-cookie.png width=300px></a><figcaption><h4>Here is a Cookie (from Memegen)</h4></figcaption></figure><p>I hope everyone had a good time during the training&rsquo;s first day and has taken new knowledge with them already.
If you have any feedback about the training itself or the materials, please let me know in person or email me at <a href=mailto:me@galexrt.moe>me AT galexrt DOT moe</a>.</p><p>Have Fun!</p></article><footer class=post-footer><ul class=post-tags><li><a href=https://edenmal.moe/tags/Workshop><span class=tag>Workshop</span></a></li><li><a href=https://edenmal.moe/tags/Docker><span class=tag>Docker</span></a></li><li><a href=https://edenmal.moe/tags/Kubernetes><span class=tag>Kubernetes</span></a></li><li><a href=https://edenmal.moe/tags/Container><span class=tag>Container</span></a></li></ul><p class=post-copyright>© This page/post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License, please give source if you wish to quote or reproduce.</p></footer><script src=https://utteranc.es/client.js repo=galexrt/edenmal.moe issue-term=title label=blogpost theme=icy-dark crossorigin=anonymous async></script></section><footer class=site-footer><p>© 2017-2023 Alexander Trost</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with customized theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><link rel=stylesheet href=https://edenmal.moe/styles/icofont.min.min.css><script async src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.min.120e30ad299b8d6548dd1fbb6ab1d45fb508bf080219df63e5ab9750b1241207.js integrity="sha256-Eg4wrSmbjWVI3R+7arHUX7UIvwgCGd9j5auXULEkEgc="></script><script type=text/x-mathjax-config>
  MathJax.Ajax.config.path["MathJax"] = "/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5";
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://edenmal.moe/scripts/index.min.0375b6e63e18876ff8d4ad95bf8ef081176b6b994398d5bd22f5140f45565d37.js integrity="sha256-A3W25j4Yh2/41K2Vv47wgRdra5lDmNW9IvUUD0VWXTc="></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(){console.log("[ServiceWorker] Registered")})</script></body></html>