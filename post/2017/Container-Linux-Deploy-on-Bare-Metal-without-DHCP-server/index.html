<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Container Linux: Deploy on Bare-Metal without DHCP server | Edenmal - Sysadmin Garden of Eden</title>
<meta name=author content="Alexander Trost"><meta name=description content="This is more of a quick writeup in form of a note on how to deploy Container Linux on bare-metal without DHCP server."><meta name=twitter:site content="@galexrt"><meta name=twitter:title content="Container Linux: Deploy on Bare-Metal without DHCP server | Edenmal - Sysadmin Garden of Eden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://edenmal.moe/post/covers/Container_Linux_Logo.png"><meta name=twitter:description content="This is more of a quick writeup in form of a note on how to deploy Container Linux on bare-metal without DHCP server."><meta property="og:type" content="article"><meta property="og:title" content="Container Linux: Deploy on Bare-Metal without DHCP server"><meta property="og:description" content="This is more of a quick writeup in form of a note on how to deploy Container Linux on bare-metal without DHCP server."><meta property="og:url" content="https://edenmal.moe/post/2017/Container-Linux-Deploy-on-Bare-Metal-without-DHCP-server/"><meta property="og:image" content="https://edenmal.moe/post/covers/Container_Linux_Logo.png"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=https://edenmal.moe/post/2017/Container-Linux-Deploy-on-Bare-Metal-without-DHCP-server/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=Cache-Control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#4d4ac7"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Edenmal"><meta name=msapplication-tooltip content="Edenmal"><meta name=msapplication-navbutton-color content="#4d4ac7"><meta name=msapplication-TileColor content="#4d4ac7"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://edenmal.moe/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://edenmal.moe/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://edenmal.moe/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://edenmal.moe/icons/icon-192x192.png><link rel=apple-touch-icon href=https://edenmal.moe/icons/icon-152x152.png><link rel=manifest href=https://edenmal.moe/manifest.json><link rel=preload href=https://edenmal.moe/styles/main-rendered.min.css as=style><link rel=preload href=https://edenmal.moe/images/avatar.png as=image><link rel=preload href=https://edenmal.moe/images/grey-prism.svg as=image><style>body{background-color:#f4f3f1;background-image:url(/images/grey-prism.svg);background-repeat:repeat;background-attachment:fixed}</style><link rel=stylesheet href=https://edenmal.moe/styles/main-rendered.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.min.css><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.819c76b4bba0f8b8c568f6e4860173f1d16e5046c01b008f4705ae823b5766e1.js integrity="sha256-gZx2tLug+LjFaPbkhgFz8dFuUEbAGwCPRwWugjtXZuE="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.min.2fcfc43be15566e9378af0e8247ba57fec8d4ee95c5dba15cf97e84d6c2115bc.js integrity="sha256-L8/EO+FVZuk3ivDoJHulf+yNTulcXboVz5foTWwhFbw="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.min.77ec5e7d7f844e9b6c2413a352b48194493a65c75d94d5cd9679a225c2da773c.js integrity="sha256-d+xefX+ETptsJBOjUrSBlEk6ZcddlNXNlnmiJcLadzw="></script><script src=https://edenmal.moe/scripts/pswp-init.min.299a530b67d8be41667aa9ed78920e272e970b0ac8ab7540ba3a7c1382b52de2.js integrity="sha256-KZpTC2fYvkFmeqnteJIOJy6XCwrIq3VAujp8E4K1LeI="></script></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class=icofont-caret-up aria-hidden=true></span></a>
<a role=button aria-label="Print page" title="Print page" class=print-page onclick=window.print()><span class=icofont-print aria-hidden=true></span></a></div><header class=site-header><a class=avatara href=https://edenmal.moe/><img class=avatar src=https://edenmal.moe/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://edenmal.moe/>Edenmal</a></h2><p class=subtitle>Sysadmin Garden of Eden</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class=icofont-navigation-menu aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://edenmal.moe/>Home</a></li><li class=menu-item><a href=https://edenmal.moe/about/>About</a></li><li class=menu-item><a href=https://edenmal.moe/tags/>Tags</a></li><li class=menu-item><a href=https://edenmal.moe/events/>Events</a></li><li class=menu-item><a href=https://edenmal.moe/site-notice/>Impressum</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:me@galexrt.moe title=Email aria-label=Email><span class=icofont-envelope aria-hidden=true></span></a></li><li class=social-item><a href=https://galexrt.moe/ rel=me title=Homepage aria-label=Homepage><span class=icofont-page aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/galexrt rel=me title=GitHub aria-label=GitHub><span class=icofont-github aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/galexrt rel=me title=Twitter aria-label=Twitter><span class=icofont-twitter aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/alexander-trost rel=me title=LinkedIn aria-label=LinkedIn><span class=icofont-linkedin aria-hidden=true></span></a></li><li class=social-item><a href=//www.xing.com/profile/Alexander_Trost18 rel=me title=XING aria-label=XING><span class=icofont-xing aria-hidden=true></span></a></li><li class=social-item><a rel=alternate type=application/rss+xml href=https://edenmal.moe/index.xml title=RSS aria-label=RSS><span class=icofont-rss aria-hidden=true></span></a></li></ul></nav></header><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><section class="main post-detail"><header class=post-header><h1 class=post-title>Container Linux: Deploy on Bare-Metal without DHCP server</h1><p class=post-meta>Author Alexander Trost · Read Time 6 minutes · Created Thu Aug 31 19:41:04 2017 · Updated Fri Mar 25 21:33:36 2022</p></header><article class=post-content><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=https://edenmal.moe/post/covers/Container_Linux_Logo.png itemprop=contentUrl><img itemprop=thumbnail src=https://edenmal.moe/post/covers/Container_Linux_Logo.png width=850px></a></figure></div><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#clarification>Clarification</a></li></ul></li><li><a href=#step-1---setup-matchbox>Step 1 - Setup Matchbox</a></li><li><a href=#step-2---reboot-the-servers-into-a-resuce-system>Step 2 - Reboot the servers into a Resuce system</a></li><li><a href=#step-3---optional-clear-the-disks-yourself-to-prevent-bootloader-issues>Step 3 - (Optional) clear the disks yourself to prevent bootloader &ldquo;issues&rdquo;</a></li><li><a href=#step-4---add-grub-config-for-ipxe-boot>Step 4 - Add grub config for iPXE boot</a></li><li><a href=#step-5---create-a-profile-and-group-for-container-linux-for-the-deployment>Step 5 - Create a profile and group for Container Linux for the Deployment</a></li><li><a href=#step-6---reboot-the-servers>Step 6 - Reboot the servers</a></li><li><a href=#step-7---connect-to-a-server-by-ssh>Step 7 - Connect to a server by SSH</a></li><li><a href=#summary>Summary</a></li></ul></nav><hr><h2 id=intro>Intro</h2><p>This post shows you how you can run Container Linux without a DHCP server configured for custom iPXE boot.</p><h3 id=clarification>Clarification</h3><p>Thanks to <a href=https://disqus.com/by/judiantara/>Baju Judiantara</a> for his <a href=http://disq.us/p/1p8dqa7>comment</a>!
He correctly found that the title is contradict to the IPXE boot script in <a href=#Step-4-Add-grub-config-for-iPXE-boot>Step 4 - Add grub config for iPXE boot</a>.
To resolve the conratdict of the title with the post I have added a snippet which does the interface configuration manual and not over DHCP.</p><h2 id=step-1---setup-matchbox>Step 1 - Setup Matchbox</h2><p>I will not go over this here, as the CoreOS documentation about this is pretty good, see here: <a href=https://github.com/coreos/matchbox/blob/master/Documentation/getting-started.md#matchbox>coreos/matchbox Documentation - Getting Started</a>.
At least for my I did something like this:</p><ul><li>Download and install matchbox (the way to run Matchbox as a Docker container be seen below).</li><li>Create <code>/var/lib/matchbox/assets</code> and <code>/etc/matchbox</code> directory (<code>mkdir -p /var/lib/matchbox/assets /etc/matchbox</code>).</li><li>Git clone the Matchbox repository <code>https://github.com/coreos/matchbox.git</code> (<code>git clone https://github.com/coreos/matchbox.git</code>).</li><li>Enter the cloned Matchbox repository.</li><li>Generate certificates with the <code>./scripts/tls/cert-gen</code> script from the Matchbox repository (enter the <code>scripts/</code> directory before execution).</li><li>Download Container Linux with the <code>./scripts/get-coreos</code> script from the Matchbox repository (enter the <code>scripts/</code> directory before execution).<ul><li>An example to download Container Linux stable version <code>1465.7.0</code>: <code>./scripts/get-coreos stable 1465.7.0 /var/lib/matchbox/assets</code></li></ul></li><li>(When Docker is used to run Matchbox) Run matchbox, with the following <code>docker run</code> command.</li></ul><p>The <code>docker run</code> command I used looked like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ docker run <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span><span style=color:#44475a>    --net=host \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -d \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -v /var/lib/matchbox:/var/lib/matchbox:Z \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -v /etc/matchbox:/etc/matchbox:Z,ro \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    quay.io/coreos/matchbox:latest \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -address=0.0.0.0:8080 \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -rpc-address=0.0.0.0:8081 \
</span></span></span><span style=display:flex><span><span style=color:#44475a>    -log-level=debug
</span></span></span></code></pre></div><h2 id=step-2---reboot-the-servers-into-a-resuce-system>Step 2 - Reboot the servers into a Resuce system</h2><p>The title says it all, reboot all the servers you want to run Container Linux on into a rescue/recovery system based on Linux.</p><h2 id=step-3---optional-clear-the-disks-yourself-to-prevent-bootloader-issues>Step 3 - (Optional) clear the disks yourself to prevent bootloader &ldquo;issues&rdquo;</h2><blockquote><p><strong>NOTE</strong></p><p>Replace <code>/dev/sda</code> with the disk in your server(s). This needs to be done in this and the next steps that work with the disk(s).</p></blockquote><p>This is more of a &ldquo;brute force&rdquo; to clear the disks completely.
First two commands disable and &ldquo;remove&rdquo; LVM devices. <code>umount</code> to unmount the disk&rsquo;s partitions and <code>mdadm</code> to zero the disks (<code>/dev/sd{a,b}</code>) superblocks so no mdadm RAID is detected. The <code>dd</code> additionally clears the first 10M of the disk, this is more than just the partition table and MBR, but I personally like to simply erase a bit more just in case.. The end runs <code>cgpt</code> to &ldquo;repair&rdquo; the disks GPT tables, this fixed issues with Container Linux having trouble creating the partitions during the installation process for me.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>lvscan 2&gt;/dev/null | awk &#39;{print &#34;lvremove -f &#34;$2}&#39; | sh
</span></span></span><span style=display:flex><span><span style=color:#44475a>vgremove 2&gt;/dev/null
</span></span></span><span style=display:flex><span><span style=color:#44475a>mdadm --stop --scan
</span></span></span><span style=display:flex><span><span style=color:#44475a>umount /dev/sda[1-9] 2&gt;/dev/null
</span></span></span><span style=display:flex><span><span style=color:#44475a>mdadm --zero-superblock /dev/sda
</span></span></span><span style=display:flex><span><span style=color:#44475a>dd if=/dev/zero of=/dev/sda bs=10M count=10
</span></span></span><span style=display:flex><span><span style=color:#44475a>cgpt repair /dev/sda
</span></span></span></code></pre></div><p>If you are on a Debian based resuce/recovery system, you need to install <code>cgpt</code> you can do this by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>apt-get update
</span></span></span><span style=display:flex><span><span style=color:#44475a>apt-get install -y cgpt
</span></span></span></code></pre></div><h2 id=step-4---add-grub-config-for-ipxe-boot>Step 4 - Add grub config for iPXE boot</h2><p>The following commands do the following:</p><ol><li>&ldquo;Zap&rdquo;/Clear the disk <code>/dev/sda</code> just in case again.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>sgdisk --zap-all --clear /dev/sda &gt;/dev/null
</span></span></span></code></pre></div><ol start=2><li>Create a BIOS boot partition (size ~4096M) on the disk.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>sgdisk --new 1:2048:4095 -c 1:&#34;BIOS Boot Partition&#34; -t 1:ef02 /dev/sda &gt;/dev/null
</span></span></span></code></pre></div><ol start=3><li>Create a partition for &ldquo;data&rdquo; which will be used for the grub configs.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>sgdisk --new 2:4096:500M -c 2:&#34;Linux Boot Partition&#34; /dev/sda &gt;/dev/null
</span></span></span></code></pre></div><ol start=4><li>The next three commands, format the data partition with <code>ext2</code>, create the mount target directory and mount the data partition to <code>/boot</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>mkfs.ext2 -F -q /dev/sda2
</span></span></span><span style=display:flex><span><span style=color:#44475a>mkdir /boot
</span></span></span><span style=display:flex><span><span style=color:#44475a>mount -t ext2 /dev/sda2 /boot
</span></span></span></code></pre></div><p>Next up is to add a <code>menuentry</code> for iPXE boot to a file named <code>/boot/grub2/grub.cfg</code>. But first the folder structure needs to be created with a simple <code>mkdir /boot/grub2</code>.
The content in the code block needs to be put in the <code>grub.cfg</code> in the given path:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>menuentry <span style=color:#f1fa8c>&#34;Network boot (iPXE)&#34;</span> {
</span></span><span style=display:flex><span>    linux16 <span style=color:#ff79c6>/</span>ipxe.lkrn
</span></span><span style=display:flex><span>    initrd16 <span style=color:#ff79c6>/</span>matchbox.ipxe
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After creating the <code>grub.cfg</code> we need to install grub to the disk.
This can be done via (for <code>/dev/sda</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>grub-install --no-floppy /dev/sda
</span></span></span></code></pre></div><p>Download ipxe.lkrn from boot.ipxe.org to <code>/boot</code>: <a href=https://boot.ipxe.org/ipxe.lkrn>https://boot.ipxe.org/ipxe.lkrn</a>. This can be done by curl or wget whatever you prefer.
An example with <code>curl</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>curl -L https://boot.ipxe.org/ipxe.lkrn -o /boot/ipxe.lkrn
</span></span></span></code></pre></div><p>Now that grub and the iPXE &ldquo;loader&rdquo; is installed, we just need to tell grub what to &ldquo;handover&rdquo; to the iPXE &ldquo;loader&rdquo;.
For that we add a file named <code>matchbox.ipxe</code> to the <code>/boot</code> directory. The file content looks like this:</p><p>Even though the title says &ldquo;without DHCP server&rdquo;, if you should &ldquo;only&rdquo; have the issue that you are not allowed to boot (custom) IPXE over your DHCP server, but are using DHCP for address configuration checkout the second snippet below.</p><p>For manual interface configuration in IPXE can be done like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>#!ipxe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>set</span> IP of first interface
</span></span><span style=display:flex><span><span style=color:#44475a>set net0/ip 192.168.0.100
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># <span style=color:#8be9fd;font-style:italic>set</span> netmask of first interface
</span></span><span style=display:flex><span><span style=color:#44475a>set net0/netmask 255.255.255.0
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># <span style=color:#8be9fd;font-style:italic>set</span> gateway of first interface
</span></span><span style=display:flex><span><span style=color:#44475a>set net0/gateway 192.168.0.1
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># <span style=color:#8be9fd;font-style:italic>set</span> dns to google ns a
</span></span><span style=display:flex><span><span style=color:#44475a>set dns 8.8.8.8
</span></span></span><span style=display:flex><span><span style=color:#44475a></span>
</span></span><span style=display:flex><span><span style=color:#44475a>chain http://matchbox.example.net:8080/boot.ipxe
</span></span></span></code></pre></div><p>More info on IPXE <code>set</code> command, can be found here: <a href=http://ipxe.org/cmd/set>iPXE - open source boot firmware [cmd:set]</a>.</p><p>If you use a DHCP server for address configuration, you can try using this snippet:
(This is useful for public cloud providers which don&rsquo;t allow custom IPXE chains)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>#!ipxe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#44475a>dhcp
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># <span style=color:#8be9fd;font-style:italic>set</span> dns to google ns a
</span></span><span style=display:flex><span><span style=color:#44475a>set dns 8.8.8.8
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># <span style=color:#8be9fd;font-style:italic>enable</span> the first network interface
</span></span><span style=display:flex><span><span style=color:#44475a>ifopen net0
</span></span></span><span style=display:flex><span><span style=color:#44475a></span># call the Matchbox server <span style=color:#ff79c6>for</span> the next iPXE steps
</span></span><span style=display:flex><span><span style=color:#44475a>chain http://matchbox.example.net:8080/boot.ipxe
</span></span></span></code></pre></div><p>Replace <code>matchbox.example.net:8080</code> with your Matchbox server address/IP.</p><blockquote><p><strong>NOTE</strong></p><p>Don&rsquo;t reboot the servres yet! Wait with the rebooting until we have configured a Matchbox profile in <a href=#Step-5-Create-a-profile-and-group-for-Container-Linux-for-the-Deployment>Step 5 - Create a profile and group for Container Linux for the Deployment</a>.</p></blockquote><h2 id=step-5---create-a-profile-and-group-for-container-linux-for-the-deployment>Step 5 - Create a profile and group for Container Linux for the Deployment</h2><p>For this please take a look at the examples provided in the Matchobx repository, which can be seen here: <a href=https://github.com/coreos/matchbox/tree/master/examples>GitHub CoreOS Matchbox - Examples Folder</a>.
If you need help by that the full documentation, can be found here: <a href=https://coreos.com/matchbox/docs/latest>Matchbox latest documentation</a>.</p><p>Don&rsquo;t forget to add your own SSH key to the profile or else <a href=Step-7-Connect-to-a-server-by-SSH>Step 7 - Connect to a server by SSH</a> won&rsquo;t work for you.</p><p>An basic example profile for running Container Linux on all servers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;id&#34;</span>: <span style=color:#f1fa8c>&#34;coreos&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;Simple CoreOS Container Linux catch-all profile&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;ignition_id&#34;</span>: <span style=color:#f1fa8c>&#34;coreos-install.yaml.tmpl&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;boot&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;kernel&#34;</span>: <span style=color:#f1fa8c>&#34;/assets/coreos/1465.7.0/coreos_production_pxe.vmlinuz&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;initrd&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;/assets/coreos/1465.7.0/coreos_production_pxe_image.cpio.gz&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;coreos.config.url=http://matchbox.example.net:8080/ignition?uuid=${uuid}\u0026mac=${mac:hexhyp}&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;coreos.first_boot=yes&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;console=tty0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;console=ttyS0&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>(This is an slightly altered example taken from here: <a href=https://github.com/coreos/matchbox/blob/master/examples/profiles/simple/default.json>GitHub coreos/matchbox: examples/profiles/simple/default.json</a>).</p><p>Replace <code>1465.7.0</code> with the chosen Container Linux version and also as earlier replace <code>matchbox.example.net:8080</code> with your Matchbox server address/IP.</p><p>A catch-all/wildcard group looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&#34;id&#34;</span>: <span style=color:#f1fa8c>&#34;coreos-catch-all&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&#34;profile&#34;</span>: <span style=color:#f1fa8c>&#34;coreos&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>&#34;ssh_authorized_key&#34;</span>: <span style=color:#f1fa8c>&#34;ssh-rsa [...]&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>(This is an slightly altered example taken from here: <a href=https://github.com/coreos/matchbox/blob/master/examples/groups/simple/default.json>GitHub coreos/matchbox: examples/groups/simple/default.json</a>).</p><p>The profiles go into the <code>/var/lib/matchbox/profiles</code> and the groups into <code>/var/lib/matchbox/groups</code> directory.</p><h2 id=step-6---reboot-the-servers>Step 6 - Reboot the servers</h2><p>As the title suggests reboot your servers.
When you now have rebooted your servers, you should see some activity in the Matchbox server (&ldquo;access&rdquo;) log.
To view the logs of Matchbox when running in Docker with the command in <a href=#Step-1-Setup-matchbox>Step 1 - Setup Matchbox</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>[...]
</span></span></span><span style=display:flex><span><span style=color:#44475a>time=&#34;2017-09-09T14:43:26Z&#34; level=debug msg=&#34;Matched an Ignition or Container Linux Config template&#34; group=coreos-install-container-linux-node01 labels=map[mac:XX-XX-XX-XX-XX-XX uuid:[...]] profile=coreos-install
</span></span></span><span style=display:flex><span><span style=color:#44475a>time=&#34;2017-09-09T14:43:30Z&#34; level=info msg=&#34;HTTP GET /ignition?uuid=[...]&amp;mac=XX-XX-XX-XX-XX-XX&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>[...]
</span></span></span></code></pre></div><p>(Where <code>coreos-install</code> is the name of the profile you created)</p><h2 id=step-7---connect-to-a-server-by-ssh>Step 7 - Connect to a server by SSH</h2><p>Again just what the title says. Just connect to one of your servers with username <code>core</code> over SSH (port 22).</p><h2 id=summary>Summary</h2><p>For questions about the post, please leave a comment below or send me an email, thanks!</p><p>Have Fun!</p></article><footer class=post-footer><ul class=post-tags><li><a href=https://edenmal.moe/tags/Container><span class=tag>Container</span></a></li><li><a href=https://edenmal.moe/tags/Container-Linux><span class=tag>Container Linux</span></a></li><li><a href=https://edenmal.moe/tags/Bare-Metal><span class=tag>Bare Metal</span></a></li></ul><p class=post-copyright>© This page/post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License, please give source if you wish to quote or reproduce.This post was published <strong>663</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.</p></footer><script src=https://utteranc.es/client.js repo=galexrt/edenmal.moe issue-term=title label=blogpost theme=icy-dark crossorigin=anonymous async></script></section><footer class=site-footer><p>© 2017-2024 Alexander Trost</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with customized theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><link rel=stylesheet href=https://edenmal.moe/styles/icofont.min.min.css><script async src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.min.120e30ad299b8d6548dd1fbb6ab1d45fb508bf080219df63e5ab9750b1241207.js integrity="sha256-Eg4wrSmbjWVI3R+7arHUX7UIvwgCGd9j5auXULEkEgc="></script><script type=text/x-mathjax-config>
  MathJax.Ajax.config.path["MathJax"] = "/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5";
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://edenmal.moe/scripts/index.min.0375b6e63e18876ff8d4ad95bf8ef081176b6b994398d5bd22f5140f45565d37.js integrity="sha256-A3W25j4Yh2/41K2Vv47wgRdra5lDmNW9IvUUD0VWXTc="></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(){console.log("[ServiceWorker] Registered")})</script></body></html>