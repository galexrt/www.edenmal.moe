<!doctype html><html lang=en-us><head><meta charset=utf-8><title>GitLab: Use Keycloak as SAML 2.0 OmniAuth Provider | Edenmal - Sysadmin Garden of Eden</title>
<meta name=author content="Alexander Trost"><meta name=description content="How to use Keycloak SAML 2.0 for GitLab as an OmniAuth provider."><meta name=twitter:site content="@galexrt"><meta name=twitter:title content="GitLab: Use Keycloak as SAML 2.0 OmniAuth Provider | Edenmal - Sysadmin Garden of Eden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://edenmal.moe/post/covers/gitlab-keycloak-logo.png"><meta name=twitter:description content="How to use Keycloak SAML 2.0 for GitLab as an OmniAuth provider."><meta property="og:type" content="article"><meta property="og:title" content="GitLab: Use Keycloak as SAML 2.0 OmniAuth Provider"><meta property="og:description" content="How to use Keycloak SAML 2.0 for GitLab as an OmniAuth provider."><meta property="og:url" content="https://edenmal.moe/post/2018/GitLab-Keycloak-SAML-2-0-OmniAuth-Provider/"><meta property="og:image" content="https://edenmal.moe/post/covers/gitlab-keycloak-logo.png"><meta name=generator content="Hugo 0.120.4"><link rel=canonical href=https://edenmal.moe/post/2018/GitLab-Keycloak-SAML-2-0-OmniAuth-Provider/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=Cache-Control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#4d4ac7"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Edenmal"><meta name=msapplication-tooltip content="Edenmal"><meta name=msapplication-navbutton-color content="#4d4ac7"><meta name=msapplication-TileColor content="#4d4ac7"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://edenmal.moe/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://edenmal.moe/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://edenmal.moe/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://edenmal.moe/icons/icon-192x192.png><link rel=apple-touch-icon href=https://edenmal.moe/icons/icon-152x152.png><link rel=manifest href=https://edenmal.moe/manifest.json><link rel=preload href=https://edenmal.moe/styles/main-rendered.min.css as=style><link rel=preload href=https://edenmal.moe/images/avatar.png as=image><link rel=preload href=https://edenmal.moe/images/grey-prism.svg as=image><style>body{background-color:#f4f3f1;background-image:url(/images/grey-prism.svg);background-repeat:repeat;background-attachment:fixed}</style><link rel=stylesheet href=https://edenmal.moe/styles/main-rendered.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.css><link rel=stylesheet href=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.min.css><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.min.819c76b4bba0f8b8c568f6e4860173f1d16e5046c01b008f4705ae823b5766e1.js integrity="sha256-gZx2tLug+LjFaPbkhgFz8dFuUEbAGwCPRwWugjtXZuE="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.min.2fcfc43be15566e9378af0e8247ba57fec8d4ee95c5dba15cf97e84d6c2115bc.js integrity="sha256-L8/EO+FVZuk3ivDoJHulf+yNTulcXboVz5foTWwhFbw="></script><script src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.min.77ec5e7d7f844e9b6c2413a352b48194493a65c75d94d5cd9679a225c2da773c.js integrity="sha256-d+xefX+ETptsJBOjUrSBlEk6ZcddlNXNlnmiJcLadzw="></script><script src=https://edenmal.moe/scripts/pswp-init.min.299a530b67d8be41667aa9ed78920e272e970b0ac8ab7540ba3a7c1382b52de2.js integrity="sha256-KZpTC2fYvkFmeqnteJIOJy6XCwrIq3VAujp8E4K1LeI="></script></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class=icofont-caret-up aria-hidden=true></span></a>
<a role=button aria-label="Print page" title="Print page" class=print-page onclick=window.print()><span class=icofont-print aria-hidden=true></span></a></div><header class=site-header><a class=avatara href=https://edenmal.moe/><img class=avatar src=https://edenmal.moe/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://edenmal.moe/>Edenmal</a></h2><p class=subtitle>Sysadmin Garden of Eden</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class=icofont-navigation-menu aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://edenmal.moe/>Home</a></li><li class=menu-item><a href=https://edenmal.moe/about/>About</a></li><li class=menu-item><a href=https://edenmal.moe/tags/>Tags</a></li><li class=menu-item><a href=https://edenmal.moe/events/>Events</a></li><li class=menu-item><a href=https://edenmal.moe/site-notice/>Impressum</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:me@galexrt.moe title=Email aria-label=Email><span class=icofont-envelope aria-hidden=true></span></a></li><li class=social-item><a href=https://galexrt.moe/ rel=me title=Homepage aria-label=Homepage><span class=icofont-page aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/galexrt rel=me title=GitHub aria-label=GitHub><span class=icofont-github aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/galexrt rel=me title=Twitter aria-label=Twitter><span class=icofont-twitter aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/alexander-trost rel=me title=LinkedIn aria-label=LinkedIn><span class=icofont-linkedin aria-hidden=true></span></a></li><li class=social-item><a href=//www.xing.com/profile/Alexander_Trost18 rel=me title=XING aria-label=XING><span class=icofont-xing aria-hidden=true></span></a></li><li class=social-item><a rel=alternate type=application/rss+xml href=https://edenmal.moe/index.xml title=RSS aria-label=RSS><span class=icofont-rss aria-hidden=true></span></a></li></ul></nav></header><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><section class="main post-detail"><header class=post-header><h1 class=post-title>GitLab: Use Keycloak as SAML 2.0 OmniAuth Provider</h1><p class=post-meta>Author Alexander Trost · Read Time 8 minutes · Created Tue Jan 16 16:15:53 2018 · Updated Fri Mar 25 21:33:36 2022</p></header><article class=post-content><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=https://edenmal.moe/post/covers/gitlab-keycloak-logo.png itemprop=contentUrl><img itemprop=thumbnail src=https://edenmal.moe/post/covers/gitlab-keycloak-logo.png width=850px></a></figure></div><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#requirements>Requirements</a></li></ul></li><li><a href=#step-1---create-saml-client-in-keycloak>Step 1 - Create SAML Client in Keycloak</a></li><li><a href=#step-2---configure-saml-client-in-keycloak>Step 2 - Configure SAML Client in Keycloak</a><ul><li><a href=#settings-tab>Settings Tab</a></li><li><a href=#roles-tab>Roles Tab</a></li><li><a href=#mappers-tab>Mappers Tab</a></li><li><a href=#scope-tab>Scope Tab</a></li></ul></li><li><a href=#step-3---get-certificate-fingerprint>Step 3 - Get Certificate Fingerprint</a></li><li><a href=#step-4---configure-gitlab>Step 4 - Configure GitLab</a><ul><li><a href=#adding-the-saml-omniauth-provider-configuration>Adding the SAML OmniAuth Provider configuration</a></li></ul></li><li><a href=#step-5---try-to-login-to-your-gitlab>Step 5 - Try to login to your GitLab</a></li><li><a href=#side-notes>Side notes</a><ul><li><a href=#high-availability-for-sessions>High availability for Sessions</a></li><li><a href=#sso-logout>SSO Logout</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav><hr><h2 id=intro>Intro</h2><p>This post shows how you can use Keycloak with SAML 2.0 as an OmniAuth Provider for GitLab (CE and EE).
Please note that these settings are tested only with GitLab CE <code>10.x.x</code> and above.
GitLab EE edition should probably work too, additionally offers more control features like Admin groups, &ldquo;User must be in group/role to be able to login&rdquo;, etc.</p><p>If you haven&rsquo;t heard of Keycloak yet, checkout their website at: <a href=http://www.keycloak.org/>Keycloak.org</a>.
In short Keycloak is an Open Source Identity and Access Management that allows SSO, uses standard protocols like OpenID Connect, OAuth 2.0 and SAML 2.0, it also has other very interesting features available.</p><h3 id=requirements>Requirements</h3><ul><li>Running and working Keycloak instance(s)<ul><li>Keycloak knowledge on an intermediate level</li><li>Keycloak admin access (you need permissions to create a client in a realm of choice)</li></ul></li><li>Running GitLab instance<ul><li>Access to the GitLab&rsquo;s instance configuration files</li></ul></li></ul><h2 id=step-1---create-saml-client-in-keycloak>Step 1 - Create SAML Client in Keycloak</h2><blockquote><p><strong>NOTE</strong></p><p>Replace <code>gitlab.edenmal.moe</code> with your actual GitLab hostname, example <code>my-gitlab.edenmal.moe</code>.</p></blockquote><p>Go to the Clients page and click the <code>Create</code> button in the right upper corner.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-add-client.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-add-client.png width=1000px></a><figcaption><h4>Keycloak - Add Client form</h4></figcaption></figure><p>The configuration of the SAML client will be done in <a href=#step-2-configure-sAML-client-in-keycloak>Step 2 - Configure SAML Client in Keycloak</a>.</p><h2 id=step-2---configure-saml-client-in-keycloak>Step 2 - Configure SAML Client in Keycloak</h2><p>In this step the configuration of the created Keycloak SAML client will be done.
If you aren&rsquo;t on the client configuration page of your created SAML client yet, navigate to it now.</p><h3 id=settings-tab>Settings Tab</h3><blockquote><p><strong>NOTE</strong></p><p>Replace <code>gitlab.edenmal.moe</code> with your actual GitLab hostname, example <code>my-gitlab.edenmal.moe</code>.</p></blockquote><p>The next screenshots contains the settings you need to set on your client.</p><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-settings-overview.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-settings-overview.png width=1100px></a><figcaption><h4>Keycloak - Created Client Settings overview</h4></figcaption></figure></div><h3 id=roles-tab>Roles Tab</h3><p>GitLab CE users are &ldquo;only&rdquo; able to specifically mark users as &ldquo;external&rdquo; in GitLab, that is what, below in the screenshot, the <code>gitlab.edenmal.moe:external</code> group is for.
GitLab EE users have more possibilites to restrict access, which can be found here: <a href=https://docs.gitlab.com/ee/integration/saml.html>GitLab EE Documentation - SAML OmniAuth Provider</a>.
Please note that the roles other than the <code>*:external</code> in the screenshot, only &ldquo;work&rdquo; for GitLab EE edition.</p><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-roles-tab.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-roles-tab.png width=1100px></a><figcaption><h4>Keycloak - Created Client Settings Roles Tab</h4></figcaption></figure></div><p>Now that you have setup roles to control the acccess to your GitLab, continue on to the <code>Mappers</code> tab.</p><h3 id=mappers-tab>Mappers Tab</h3><p>Mappers, as the name may suggest, allow you to map user information to parameters in the SAML 2.0 request for GitLab.
An example would be to map the Username into the request for GitLab.</p><div class=fullwidthimg><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-mappers-tab.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-mappers-tab.png width=1100px></a><figcaption><h4>Keycloak - Created Client Settings Mappers Tab</h4></figcaption></figure></div><p>The created mappers configuration is:</p><ul><li>Name: <code>name</code><ul><li>Mapper Type: <code>User Property</code></li><li>Property: <code>Username</code></li><li>Friendly Name: <code>Username</code></li><li>SAML Attribute Name: <code>name</code></li><li>SAML Attribute NameFormat: <code>Basic</code></li></ul></li><li>Name: <code>email</code><ul><li>Mapper Type: <code>User Property</code></li><li>Property: <code>Email</code></li><li>Friendly Name: <code>Email</code></li><li>SAML Attribute Name: <code>email</code></li><li>SAML Attribute NameFormat: <code>Basic</code></li></ul></li><li>Name: <code>first_name</code><ul><li>Mapper Type: <code>User Property</code></li><li>Property: <code>FirstName</code></li><li>Friendly Name: <code>First Name</code></li><li>SAML Attribute Name: <code>first_name</code></li><li>SAML Attribute NameFormat: <code>Basic</code></li></ul></li><li>Name: <code>last_name</code><ul><li>Mapper Type: <code>User Property</code></li><li>Property: <code>LastName</code></li><li>Friendly Name: <code>Last Name</code></li><li>SAML Attribute Name: <code>last_name</code></li><li>SAML Attribute NameFormat: <code>Basic</code></li></ul></li><li>Name: <code>roles</code><ul><li>Mapper Type: <code>Role list</code></li><li>Role attribute name: <code>roles</code></li><li>Friendly Name: <code>Roles</code></li><li>SAML Attribute NameFormat: <code>Basic</code></li><li>Single Role Attribute: <code>On</code></li></ul></li></ul><p>All of the mappers have &ldquo;Consent Required&rdquo; set to <code>Off</code>.</p><h3 id=scope-tab>Scope Tab</h3><p>Sadly this option needs to be set to <code>On</code> for GitLab, as there seem to issues with it getting the <code>roles</code> because of &ldquo;missing&rdquo; scopes requested.</p><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><a href=keycloak-client-scope-tab.png itemprop=contentUrl><img itemprop=thumbnail src=keycloak-client-scope-tab.png width=600px></a><figcaption><h4>Keycloak - Created Client Settings Scope Tab</h4></figcaption></figure><h2 id=step-3---get-certificate-fingerprint>Step 3 - Get Certificate Fingerprint</h2><p>The Keycloak IDP realm&rsquo;s public certificate fingerprint is needed for the configuration of SAML2.0.</p><p>For that go to the <code>Realm Settings</code> sidebar menu point and client the <code>SAML 2.0 Identity Provder Metadata</code>.</p><p><img src=keycloak-realm-settings.png alt="Keycloak Realm Settings Page"></p><p>Now download / save page by, e.g., using <kbd>CTRL</kbd> + <kbd>S</kbd>, right click on the page and &ldquo;Save as&mldr;&rdquo;.</p><p>The file contains the Keycloak IDP public certificate of which the public fingerprint is needed for the configuration on GitLab&rsquo;s side.
To get that certificate in the &ldquo;correct&rdquo; format and get the fingerprint, I have a small script snippet below to extract the cert and print the fingerprint.</p><blockquote><p><strong>REQUIREMENTS</strong></p><ul><li>bash (located at <code>/bin/bash</code>)</li><li><code>grep</code></li><li><code>sed</code></li><li><code>openssl</code></li></ul></blockquote><p>Set the <code>IDP_DESCRIPTOR_FILE</code> variable to the path where you saved the <code>SAML 2.0 Identity Provder Metadata</code> &ldquo;page&rdquo; to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#44475a>IDP_DESCRIPTOR_FILE=&#34;~/Downloads/descriptor&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>(
</span></span></span><span style=display:flex><span><span style=color:#44475a>    echo &#34;-----BEGIN CERTIFICATE-----&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>    grep -oP &#39;&lt;ds:X509Certificate&gt;(.*)&lt;/ds:X509Certificate&gt;&#39; &#34;$IDP_DESCRIPTOR_FILE&#34; | sed -r -e &#39;s~&lt;[/]?ds:X509Certificate&gt;~~g&#39; | fold -w 64
</span></span></span><span style=display:flex><span><span style=color:#44475a>    echo &#34;-----END CERTIFICATE-----&#34;
</span></span></span><span style=display:flex><span><span style=color:#44475a>) | openssl x509 -noout -fingerprint -sha1
</span></span></span></code></pre></div><p>Write down the fingerprint that is printed out by the script we need it for GitLab configuration later on.</p><p>Now that you have the Keycloak IDP certificate fingerprint and the SAML 2.0 client created + configured, we can move on to configuring GitLab to use the client for authentication in the next step <a href=#step-4-configure-gitlab>Step 4 - Configure GitLab</a>.</p><h2 id=step-4---configure-gitlab>Step 4 - Configure GitLab</h2><p>This needs to be done in the <code>gitlab.yml</code> config file of your GitLab instance.</p><h3 id=adding-the-saml-omniauth-provider-configuration>Adding the SAML OmniAuth Provider configuration</h3><p>The GitLab config YAML snippet below contains the settings that control the SAML OmniAuth Provider.</p><blockquote><p><strong>NOTE</strong> The snippet below is from GitLab CE.</p><p>GitLab EE has more options for SAML authentication, see <a href=https://docs.gitlab.com/ee/integration/saml.html>GitLab EE Documentation - SAML OmniAuth Provider</a>.</p></blockquote><p>As before, don&rsquo;t forget to replace <code>gitlab.edenmal.moe</code> with your actual GitLab hostname, example <code>my-gitlab.edenmal.moe</code>.
Additionally replace <code>YOUR_KEYCLOAK_CERT_FINGERPRINT</code> with the Keycloak certificate fingerprint from the <a href=#Get-Certificate-Fingerprint>previous step&rsquo;s section (Get Certificate Fingerprint)</a> and <code>keycloak.edenmal.moe</code> with the actual address to your Keycloak instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>production</span>:
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>omniauth</span>:
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Allow login via Twitter, Google, etc. using OmniAuth providers</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>enabled</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Uncomment this to automatically sign in with a specific omniauth provider&#39;s without</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># showing GitLab&#39;s sign-in page (default: show the GitLab sign-in page)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>auto_sign_in_with_provider</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Sync user&#39;s email address from the specified Omniauth provider every time the user logs</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># in (default: nil). And consequently make this field read-only.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># sync_email_from_provider: cas3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># CAUTION!</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># This allows users to login without having a user account first. Define the allowed providers</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># using an array, e.g. [&#34;saml&#34;, &#34;twitter&#34;], or as true/false to allow all providers or none.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># User accounts will be created automatically when authentication was successful.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>allow_single_sign_on</span>: [saml]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Locks down those users until they have been cleared by the admin (default: true).</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>block_auto_created_users</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Look up new users in LDAP servers. If a match is found (same uid), automatically</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># link the omniauth identity with the LDAP account. (default: false)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>auto_link_ldap_user</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Allow users with existing accounts to login and auto link their account via SAML</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># login, without having to do a manual login first and manually add SAML</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># (default: false)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>auto_link_saml_user</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Set different Omniauth providers as external so that all users creating accounts</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># via these providers will not be able to have access to internal projects. You</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># will need to use the full name of the provider, like `google_oauth2` for Google.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Refer to the examples below for the full names of the supported providers.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># (default: [])</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>external_providers</span>: []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>## Auth providers</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Uncomment the following lines and fill in the data of the auth provider you want to use</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># If your favorite auth provider is not listed you can use others:</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># see https://github.com/gitlabhq/gitlab-public-wiki/wiki/Custom-omniauth-provider-configurations</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># The &#39;app_id&#39; and &#39;app_secret&#39; parameters are always passed as the first two</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># arguments, followed by optional &#39;args&#39; which can be either a hash or an array.</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Documentation for this is available at http://doc.gitlab.com/ce/integration/omniauth.html</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>providers</span>:
</span></span><span style=display:flex><span>          <span style=color:#6272a4># See omniauth-cas3 for more configuration details</span>
</span></span><span style=display:flex><span>          - { <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#39;saml&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>label</span>: <span style=color:#f1fa8c>&#39;gitlab.edenmal.moe Keycloak&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>groups_attribute</span>: <span style=color:#f1fa8c>&#39;roles&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>external_groups</span>: [<span style=color:#f1fa8c>&#39;gitlab.edenmal.moe:external&#39;</span>],
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>args</span>: {
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>assertion_consumer_service_url</span>: <span style=color:#f1fa8c>&#39;https://gitlab.edenmal.moe/users/auth/saml/callback&#39;</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>idp_cert_fingerprint</span>: <span style=color:#f1fa8c>&#39;YOUR_KEYCLOAK_CERT_FINGERPRINT&#39;</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>idp_sso_target_url</span>: <span style=color:#f1fa8c>&#39;https://keycloak.edenmal.moe/auth/realms/master/protocol/saml/clients/gitlab.edenmal.moe&#39;</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>issuer</span>: <span style=color:#f1fa8c>&#39;gitlab.edenmal.moe&#39;</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>attribute_statements</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>first_name</span>: [<span style=color:#f1fa8c>&#39;first_name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>last_name</span>: [<span style=color:#f1fa8c>&#39;last_name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>name</span>: [<span style=color:#f1fa8c>&#39;name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>username</span>: [<span style=color:#f1fa8c>&#39;name&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>email</span>: [<span style=color:#f1fa8c>&#39;email&#39;</span>] },
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>name_identifier_format</span>: <span style=color:#f1fa8c>&#39;urn:oasis:names:tc:SAML:2.0:nameid-format:persistent&#39;</span> } }
</span></span></code></pre></div><p>Full examples of the <code>gitlab.yml</code> with all available options can be found here for GitLab:</p><ul><li>CE edition: <a href=https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/gitlab.yml.example>config/gitlab.yml.example · master · gitlab-org/gitlab-ce</a></li><li>EE Edition: <a href=https://gitlab.com/gitlab-org/gitlab-ee/blob/master/config/gitlab.yml.example>config/gitlab.yml.example · master · gitlab-org/gitlab-ee</a></li></ul><p>Make sure the address to your Keycloak instance is correct.</p><p>You can adjust most options that are outside the <code>providers</code> section to your likings, for example the <code>block_auto_created_users</code> option.</p><blockquote><p><strong>NOTE</strong></p><p>The <code>block_auto_created_users</code> option defaults to <code>true</code>, meaning that when you first time login in to GitLab through a authentication provider your account will be blocked.
So be ready to unblock the new account with an admin account or set the option to <code>false</code>.</p></blockquote><h2 id=step-5---try-to-login-to-your-gitlab>Step 5 - Try to login to your GitLab</h2><p>Logout of GitLab and you should land on the normal GitLab login page.
Just try to login to GitLab using the button named after the <code>label</code> value in the <code>providers</code> section of the <code>gitlab.yml</code>.
If it is not working, I suggest you investigate the Keycloak logs and GitLabs application logs for any errors thrown there.</p><p>When that works, you can switch the toggle that automatically redirects you to your login provider.
The option in GitLab to automatically redirect to the SSO provider (Keycloak in this case) is <code>auto_sign_in_with_provider</code>.
To allow the automatic redirection set <code>auto_sign_in_with_provider</code> to the (string) value <code>saml</code> (<code>auto_sign_in_with_provider: saml</code>) and restart your GitLab instance.</p><p>Now when going to your GitLab instance, you should automatically get redirected to your Keycloak instance and be prompted for login.</p><h2 id=side-notes>Side notes</h2><h3 id=high-availability-for-sessions>High availability for Sessions</h3><p>It is recommended that if you have more than one GitLab instance, that you use a shared Redis so users session are not invalidated when getting sent to the other GitLab instance.</p><h3 id=sso-logout>SSO Logout</h3><p>SSO Logout is currently not supported by GitLab. There is an issue open to implement this behavior, see <a href=https://gitlab.com/gitlab-org/gitlab-ce/issues/17344>Explore SAML Single Sign Out (#17344) · Issues · gitlab-org/gitlab-ce</a>.</p><h2 id=summary>Summary</h2><p>I hope this helps you to get started with using Keycloak as a GitLab SAML 2.0 OmniAuth Provider for simple SSO login.
For questions about the post or issues while trying the configuration from this post, please leave a comment below, thanks!</p><p>Have Fun!</p></article><footer class=post-footer><ul class=post-tags><li><a href=https://edenmal.moe/tags/GitLab><span class=tag>GitLab</span></a></li><li><a href=https://edenmal.moe/tags/Keycloak><span class=tag>Keycloak</span></a></li><li><a href=https://edenmal.moe/tags/SAML2><span class=tag>SAML2</span></a></li></ul><p class=post-copyright>© This page/post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License, please give source if you wish to quote or reproduce.This post was published <strong>726</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.</p></footer><script src=https://utteranc.es/client.js repo=galexrt/edenmal.moe issue-term=title label=blogpost theme=icy-dark crossorigin=anonymous async></script></section><footer class=site-footer><p>© 2017-2024 Alexander Trost</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with customized theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><link rel=stylesheet href=https://edenmal.moe/styles/icofont.min.min.css><script async src=https://edenmal.moe/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.min.120e30ad299b8d6548dd1fbb6ab1d45fb508bf080219df63e5ab9750b1241207.js integrity="sha256-Eg4wrSmbjWVI3R+7arHUX7UIvwgCGd9j5auXULEkEgc="></script><script type=text/x-mathjax-config>
  MathJax.Ajax.config.path["MathJax"] = "/cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5";
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://edenmal.moe/scripts/index.min.0375b6e63e18876ff8d4ad95bf8ef081176b6b994398d5bd22f5140f45565d37.js integrity="sha256-A3W25j4Yh2/41K2Vv47wgRdra5lDmNW9IvUUD0VWXTc="></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(){console.log("[ServiceWorker] Registered")})</script></body></html>